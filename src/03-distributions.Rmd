# Distributions

```{r setup-03}
library(Amisc)
library(batchAdj)
library(forcats)
library(scales)
library(here)
source(here("src/funs.R"))
source(here("validation/cs_process.R"))
source(here("validation/cs_process_cohorts.R"))
source(here::here("validation/cs1_generate.R"))
source(here::here("validation/cs2_generate.R"))
cs1_class <- readRDS(here("data/cs1_class.rds"))
cs2_class <- readRDS(here("data/cs2_class.rds"))
```

## Full Data

The histotype distributions on the full data are shown below.

```{r dist-all-hist-gr}
all_hist <- hist %>% dplyr::filter(!is.na(revHist))
all_hist %>%
  dplyr::count(CodeSet, `Histotype Group` = hist_gr) %>%
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "All CodeSet Histotype Groups")
```

```{r dist-major-hist}
all_maj_counts <- all_hist %>% 
  dplyr::filter(revHist %in% c("HGSC", "LGSC", "ENOC", "CCOC", "MUC")) %>% 
  dplyr::count(CodeSet, `Reviewed Histotype` = revHist)
all_maj_counts %>% 
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  dplyr::mutate(
    `CS1 %` = round(CS1 / sum(CS1) * 100, 1),
    `CS2 %` = round(CS2 / sum(CS2) * 100, 1),
    `CS3 %` = round(CS3 / sum(CS3) * 100, 1)
  ) %>%
  knitr::kable(caption = "All CodeSet Major Reviewed Histotypes")
```

```{r dist-all}
all_counts <- all_hist %>%
  dplyr::count(CodeSet, `Reviewed Histotype` = revHist)
all_counts %>%
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "All CodeSet Reviewed Histotypes")
```

```{r dist-cs1}
all_counts %>% 
  dplyr::filter(CodeSet == "CS1") %>% 
  knitr::kable(caption = "CS1 Histotypes")
```

```{r dist-cs2}
all_counts %>% 
  dplyr::filter(CodeSet == "CS2") %>% 
  knitr::kable(caption = "CS2 Histotypes")
```

```{r dist-cs3}
all_counts %>% 
  dplyr::filter(CodeSet == "CS3") %>% 
  knitr::kable(caption = "CS3 Histotypes")
```

```{r dist-common}
common_counts <- all_hist %>%
  dplyr::filter(FileName %in% common_samples) %>% 
  dplyr::count(CodeSet, `Reviewed Histotype` = revHist)
common_counts %>% 
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "Common Summary ID CodeSet Histotypes")
```

## Training Sets

### CS1 Training Set Generation

We use the reference method to normalize CS1 to CS3.

-   CS1 reference set: duplicate samples from CS1

    -   Samples = `r nrow(cs1_ref2)`
    -   Genes = `r ncol(cs1_ref2)`

-   CS3 reference set: corresponding samples in CS3 also found in CS1 reference set

    -   Samples = `r nrow(cs3_ref)`
    -   Genes = `r ncol(cs3_ref)`

-   CS1 validation set: remaining CS1 samples with reference set removed

    -   Samples = `r nrow(cs1_val2)`
    -   Genes = `r ncol(cs1_val2)`

The final CS1 training set has `r nrow(cs1_data)` samples on `r ncol(cs1_data)` genes after normalization and keeping only the major histotypes of interest.

```{r training-dist-cs1}
cs1_class %>% 
  tibble::enframe(value = "Histotype") %>% 
  dplyr::count(Histotype) %>% 
  dplyr::mutate(`%` = scales::percent(n / sum(n), accuracy = 0.1)) %>% 
  knitr::kable(caption = "CS1 Training Set Histotypes")
```

### CS2 Training Set Generation

We use the pool method to normalize CS2 to CS3 so we can be consistent with the PrOType normalization when there are available pools.

-   CS2 pools:

    -   Samples = 12 (Pool 1 = 4, Pool 2 = 4, Pool 3 = 4)
    -   Genes = `r nrow(cs2_pools)`

-   CS3 pools:

    -   Samples = `r ncol(ref_pools)` (Pool 1 = 12, Pool 2 = 5, Pool 3 = 5)
    -   Genes = `r nrow(ref_pools)`

-   CS2 validation set: CS2 samples with pools removed

    -   Samples = `r ncol(cs2_norm) - 3 - 9`
    -   Genes = `r nrow(cs2_norm)`

The final CS2 training set has `r nrow(cs2_data)` samples on `r ncol(cs2_data)` (common) genes after normalization and keeping only the major histotypes of interest.

```{r training-dist-cs2}
cs2_class %>% 
  tibble::enframe(value = "Histotype") %>% 
  dplyr::count(Histotype) %>% 
  dplyr::mutate(`%` = scales::percent(n / sum(n), accuracy = 0.1)) %>% 
  knitr::kable(caption = "CS2 Training Set Histotypes")
```

## Common Samples

```{r common-dist-all}
common_dist_all <- hist %>% 
  filter(FileName %in% c(
    cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName
  )) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(common_dist_all, caption = "All Common Samples Histotype Distribution")
```

```{r common-dist-distinct}
common_dist_distinct <- hist %>% 
  filter(FileName %in% c(
    cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName
  )) %>% 
  distinct(ottaID, CodeSet, revHist) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(common_dist_distinct, caption = "Distinct Common Samples Histotype Distribution")
```

```{r common-cs2-cs3-dist-distinct}
# Pool set: pool samples from CS2
pool_samples <- cohorts %>% 
  filter(file_source == "cs2", cohort == "POOL-CTRL") %>% 
  pull(col_name)
cs2_pools <- select(cs2_norm, Name, all_of(pool_samples))

# Locked down reference pools weights
weights <- c("Pool1", "Pool2", "Pool3") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs2_pools_mgx <- weights %>%
  imap_dfc(~ .x * rowMeans(select(cs2_pools, matches(.y)))) %>%
  transmute(Name = cs2_pools[["Name"]], cs2_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Extract cs2 norm counts (not pools)
cs2_norm_counts <- cs2_norm %>% select(-one_of(names(cs2_pools)[-1]))

# Normalize each gene by adding batch effect (diff in mean gx)
cs2_normalized_data_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs2_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)

# Keep only common samples between codesets, average out duplicates
tmp2 <- cs2_norm_counts %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>% 
  filter(Name %in% names(cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)
tmp3 <- cs3_norm_van %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>% 
  filter(Name %in% names(cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

cs2_common_non <- semi_join(tmp2, tmp3, by = "ottaID")
cs3_common_non <- semi_join(tmp3, tmp2, by = "ottaID")

cs2_common_non <- column_to_rownames(cs2_common_non, "ottaID")
cs3_common_non <- column_to_rownames(cs3_common_non, "ottaID")

common_cs2_cs3_dist_distinct <- hist %>%
  filter(ottaID %in% c(rownames(cs2_common_non),
                       rownames(cs3_common_non))) %>%
  distinct(ottaID, CodeSet, revHist) %>%
  count(CodeSet, revHist) %>%
  pivot_wider(names_from = "CodeSet", values_from = "n") %>%
  select(-CS1)
knitr::kable(common_cs2_cs3_dist_distinct, caption = "Distinct Common CS2 and CS3 Samples Histotype Distribution")
```

```{r common-dist-sites}
common_dist_sites <- hist %>%
  filter(
    FileName %in% c(
      cs3_clean_van$FileName,
      cs3_clean_aoc$FileName,
      cs3_clean_usc$FileName
    )
  ) %>%
  count(site, revHist) %>%
  pivot_wider(names_from = "site", values_from = "n")
knitr::kable(common_dist_sites, caption = "Common Samples Across Sites Histotype Distribution")
```

```{r common-dist-sites-distinct}
common_dist_sites_distinct <- hist %>%
  filter(
    FileName %in% c(
      cs3_clean_van$FileName,
      cs3_clean_aoc$FileName,
      cs3_clean_usc$FileName
    )
  ) %>%
  distinct(ottaID, site, revHist) %>% 
  count(site, revHist) %>%
  pivot_wider(names_from = "site", values_from = "n")
knitr::kable(common_dist_sites_distinct, caption = "Distinct Common Samples Across Sites Histotype Distribution")
```

```{r cs345-overlap}
# CS4/CS5 overlap 74 (removed 6 samples failed QC)
cs45_overlap <-
  inner_join(cs4_exp, cs5_exp, by = "ottaID", suffix = c(".CS4", ".CS5")) %>%
  filter(!File.Name.CS4 %in% cs4_qc_failed, !File.Name.CS5 %in% cs5_qc_failed) %>%
  select(ottaID, File.Name.CS4, File.Name.CS5)

# CS3/CS4/CS5 overlap 72 (2 duplicates)
cs345_overlap <- 
  inner_join(hist_all, cs45_overlap, by = "ottaID") %>%
  filter(CodeSet == "CS3") %>%
  select(ottaID, CS3 = FileName, CS4 = File.Name.CS4, CS5 = File.Name.CS5, revHist) %>%
  pivot_longer(names_to = "CodeSet", values_to = "File.Name", 2:4) %>% 
  distinct(ottaID, CodeSet, revHist) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(cs345_overlap, caption = "CS3/CS4/CS5 Common Samples Histotype Distribution")
```

```{r cs345-pools}
cs3_pool_counts <- paste0("Pool", 1:3) %>%
  set_names() %>%
  map_df(~ sum(grepl(., names(ref_pools), ignore.case = TRUE)))

# Pools Set A, B, C from CS4
cs4_pools <- cs4_dat %>% 
  select(Name, matches("pool", ignore.case = TRUE))
cs4_poolsA <- cs4_pools %>% 
  select(Name, matches("Pool ?[1-3|A-C](?!0|1)", perl = TRUE)) %>% 
  rename_with( ~ str_replace_all(
    .,
    c("A_" = "1A_", "B_" = "2B_", "C_" = "3C_", " " = "")
  ))
cs4_poolsB <- cs4_pools %>% 
  select(Name, matches("Pool ?(9|10|11).*")) %>% 
  `rownames<-`(NULL) %>% 
  column_to_rownames("Name")
cs4_poolsC <- cs4_pools %>% 
  select(Name, matches("Pool ?[4-5|7-8].*")) %>% 
  `rownames<-`(NULL) %>% 
  column_to_rownames("Name")

# Pools Set B, C from CS5
cs5_pools <- select(cs5_dat, Name, matches("pool", ignore.case = TRUE))
cs5_poolsA <- select(cs5_pools, Name, matches("POOL[1-3]_"))
cs5_poolsB <- select(cs5_pools, Name, matches("POOL(9|10|11)"))
cs5_poolsC <- select(cs5_pools, Name, matches("POOL[4-5|7-8]"))

cs4_pools_names <-
  gsub(".*_(.*)_[0-9]{2}$", "\\1\\2", names(cs4_pools)) %>% 
  str_replace_all(c("A" = "1", "B" = "2", "C" = "3", " " = ""))
cs4_pool_counts <- paste0("^Pool", 1:11, "$") %>% 
  set_names(gsub("\\^|\\$", "", .)) %>%
  map_df(~ sum(grepl(., cs4_pools_names, ignore.case = TRUE)))

cs5_pools_names <-
  gsub(".*_(.*)_[0-9]{2}$", "\\1\\2", names(cs5_pools))
cs5_pool_counts <- paste0("^Pool", 1:11, "$") %>%
  set_names(gsub("\\^|\\$", "", .)) %>%
  map_df(~ sum(grepl(., cs5_pools_names, ignore.case = TRUE)))

cs345_pools <- 
  bind_rows(cs3_pool_counts, cs4_pool_counts, cs5_pool_counts) %>% 
  add_column(CodeSet = c("CS3", "CS4", "CS5"), .before = 1) %>% 
  pivot_longer(cols = -CodeSet, names_to = "Pool", values_to = "Samples") %>% 
  pivot_wider(names_from = "CodeSet", values_from = "Samples")

knitr::kable(cs345_pools, caption = "CS3/CS4/CS5 Pools Distribution")
```

## Histotypes in Classifier Data

```{r classifier-hist}
source(here("validation/cs_classifier.R"))
```

```{r train-hist-codeset}
train_hist_codeset <- train_ref %>% 
  mutate(revHist = fct_infreq(revHist)) %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE
  )

knitr::kable(train_hist_codeset,
             caption = "Full Training Set Histotype Distribution by CodeSet")
```

```{r hist-codeset-dataset}
hist_codeset_dataset <- list(
  `CS1 All` = cs1_all_ref,
  `CS2 All` = cs2_all_ref,
  Confirmation = conf_ref,
  Validation = val_ref
) %>%
  map_dfr( ~ select(., revHist), .id = "Data") %>% 
  mutate(
    Data = factor(Data, levels = c(
      "CS1 All", "CS2 All", "Confirmation", "Validation"
    )),
    revHist = factor(revHist, levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC"))
  ) %>%
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "Data",
    total = "bottom",
    test = FALSE,
    bold_var = FALSE
  ) %>% 
  select(-Total)

knitr::kable(hist_codeset_dataset,
             caption = "Histotype Distribution by CodeSet/Datasets")
```
