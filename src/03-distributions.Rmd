# Distributions

```{r setup-03}
library(Amisc)
library(batchAdj)
library(forcats)
library(scales)
library(patchwork)
library(kableExtra)
library(here)
source(here("validation/cs_classifier.R"))
```

## Histotype Distribution

```{r train-cohort-codeset}
train_cohort_codeset <- hist_all %>%
  filter(FileName %in% gsub("^X", "", c(
    cs1_samples_coh, cs2_samples_coh, cs3_samples_coh
  ))) %>%
  mutate(revHist = revHist %>%
           factor(levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC")) %>%
           fct_na_value_to_level(level = "Other")) %>%
  droplevels() %>%
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r train-qc-codeset}
train_qc_codeset <- hist_all %>%
  filter(FileName %in% gsub(
    "^X",
    "",
    c(cs1_samples_coh_qc, cs2_samples_coh_qc, cs3_samples_coh_qc)
  )) %>% 
  mutate(revHist = revHist %>%
           factor(levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC")) %>%
           fct_na_value_to_level(level = "Other")) %>%
  droplevels() %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r train-hist-codeset}
train_hist_codeset <- hist %>%
  filter(FileName %in% gsub("^X", "", c(cs1_samples, cs2_samples, cs3_samples))) %>%
  mutate(revHist = revHist %>%
           factor(levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC")) %>%
           fct_na_value_to_level(level = "Other")) %>%
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r train-dedup-codeset}
train_dedup_codeset <- hist %>%
  filter(FileName %in% gsub("^X", "", c(cs1_dedup$col_name, cs2_dedup$col_name, cs3_dedup$col_name))) %>%
  mutate(revHist = revHist %>%
           factor(levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC")) %>%
           fct_na_value_to_level(level = "Other")) %>%
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r train-comb-codeset}
train_comb_codeset <- train_ref_comb %>% 
  mutate(revHist = fct_infreq(revHist)) %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r train-derep-codeset}
train_derep_codeset <- train_ref %>% 
  mutate(revHist = fct_infreq(revHist)) %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE,
    fill = TRUE
  )
```

```{r hist-codeset}
hist_codeset <-
  bind_rows(
    train_cohort_codeset,
    train_qc_codeset,
    train_hist_codeset,
    train_dedup_codeset,
    train_comb_codeset,
    train_derep_codeset
  )

hist_codeset %>%
  kbl(caption = "Histotype Distribution in Training Set by Processing Stage") %>%
  kable_styling() %>%
  pack_rows(
    index = c(
      "Selected Cohorts" = 7,
      "QC" = 7,
      "Main Histotypes" = 6,
      "Removed Duplicates" = 6,
      "Normalized and Recombined" = 6,
      "Removed Replicates" = 6
    )
  ) %>%
  collapse_rows(columns = 1)
```

```{r hist-train-conf-val}
hist_train_conf_val <-
  list(Training = train_ref,
       Confirmation = conf_ref,
       Validation = val_ref) %>%
  map_dfr( ~ select(., revHist), .id = "Data") %>%
  mutate(Data = factor(Data, levels = c("Training", "Confirmation", "Validation")),
         revHist = factor(revHist, levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC"))) |>
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "Data",
    total = "bottom",
    test = FALSE,
    bold_var = FALSE,
    fill = TRUE
  ) %>%
  select(-Total)

hist_train_conf_val %>%
  kbl(caption = "Histotype Distribution in Training, Confirmation, and Validation Sets") %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```

## Cohort Distribution

```{r cohorts-dist}
cohorts_dist <-
  cohorts %>%
  filter(col_name %in% c(cs1_samples_coh, cs2_samples_coh, cs3_samples_coh)) %>%
  mutate(CodeSet = toupper(file_source),
         cohort = factor(
           cohort,
           levels = c(
             "OOU",
             "OOUE",
             "VOA",
             "OVAR3",
             "ICON7",
             "MAYO",
             "DOVE4",
             "TNCO",
             "MTL",
             "JAPAN",
             "POOL-CTRL",
             "POOL-1",
             "POOL-2",
             "POOL-3"
           )
         )) %>%
  tbl_summary(
    by = CodeSet,
    label = list(cohort ~ "Cohort"),
    include = c(CodeSet, cohort)
  ) %>%
  modify_header(label ~ "**CodeSet**") %>% 
  modify_caption(caption = "Pre-QC Cohort Distribution by CodeSet")

cohorts_dist
```

## Quality Control

### Failed Samples

We use an aggregated `QCFlag` that considers a sample to have failed QC if any of the following conditions are true:

- `linFlag`: linearity of positive controls with positive control concentrations is less than 0.95, or linearity measures are unknown
- `imagingFlag`: percent of field of view is less than 75%
- `spcFlag`: smallest positive control is less than the lower limit of detection (negative control average expression less two times the negative control standard deviation), or negative control average expression equals zero
- `normFlag`: signal to noise ratio less than 100, or percent of genes detected is less than 50. Note: these thresholds were determined by examining the [%GD vs. SNR] relationship below.

```{r qc-failed}
qc_failed <-
  bind_rows(cs1_qc, cs2_qc, cs3_qc) %>% 
  droplevels() %>% 
  tbl_summary(
    by = CodeSet,
    label = list(
      linFlag ~ "Linearity",
      imagingFlag ~ "Imaging",
      spcFlag ~ "Smallest Positive Control",
      normFlag ~ "Normality",
      QCFlag ~ "Overall QC"
    ),
    include = matches("(?<!bd)Flag", perl = TRUE)
  ) %>% 
  bold_labels() %>% 
  modify_header(label ~ "**Quality Control Flag**") %>% 
  modify_caption(caption = "Quality Control Summary")

qc_failed
```

### %GD vs. SNR

```{r qc-gd-snr-all, fig.height=8, fig.cap='% Genes Detected vs. Signal to Noise Ratio'}
p1 <- ggplot(cs1_qc, aes(snr, pergd)) + 
  geom_point() +
  labs(title = "CS1")
p2 <- ggplot(cs2_qc, aes(snr, pergd)) + 
  geom_point() +
  labs(title = "CS2")
p3 <- ggplot(cs3_qc, aes(snr, pergd)) + 
  geom_point() +
  labs(title = "CS3")

p_gd_snr_all <- p1 / p2 / p3 &
  labs(x = "SNR", y = "% GD") &
  geom_vline(xintercept = 100, color = "red", linetype = "dashed") &
  geom_hline(yintercept = 50, color = "red", linetype = "dashed") &
  theme_bw() &
  theme(panel.grid.minor = element_blank()) &
  plot_annotation(title = "% Genes Detected vs. SNR",
                  tag_levels = "a")
print(p_gd_snr_all)
```

```{r qc-gd-snr-zoomed, fig.height=8, fig.cap='% Genes Detected vs. Signal to Noise Ratio (Zoomed)'}
p_gd_snr_zoomed <- p_gd_snr_all &
  lims(x = c(0, 2000)) &
    plot_annotation(title = "% Genes Detected vs. SNR (Zoomed)",
                  tag_levels = "a")
print(p_gd_snr_zoomed)
```

## Pairwise Gene Expression

```{r genes-cs13-rand1, fig.height=10, fig.width=11, out.width='100%', fig.cap='Random1-Normalized CS1 vs. CS3 Gene Expression'}
genes_cs13_rand1 <- train_ref_comb %>%
  rownames_to_column("FileName") %>%
  group_by(ottaID) %>%
  mutate(n_codeset = n_distinct(CodeSet)) %>%
  filter(all(c("CS1", "CS3") %in% CodeSet)) %>%
  group_by(ottaID, CodeSet) %>%
  filter(n_codeset > 1, !duplicated(ottaID)) %>%
  ungroup() %>%
  pivot_longer(
    cols = where(is.double),
    names_to = "Gene",
    names_ptypes = list(Gene = factor()),
    values_to = "Value"
  ) %>%
  pivot_wider(
    id_cols = c(ottaID, Gene),
    names_from = "CodeSet",
    values_from = c("Value", "FileName")
  ) %>%
  group_by(Gene) %>%
  mutate(Rc = epiR::epi.ccc(Value_CS1, Value_CS3)[["rho.c"]][["est"]]) %>%
  ungroup() %>%
  mutate(Gene = fct_reorder(Gene, Rc, .desc = TRUE),
         Rc = paste0("Rc = ", round(Rc, digits = 3)))

p_genes_cs13_rand1 <-
  ggplot(genes_cs13_rand1, aes(x = Value_CS1, y = Value_CS3)) +
  geom_point() +
  geom_text(
    x = -24,
    y = 5,
    size = 3,
    hjust = 0,
    vjust = 1,
    aes(label = Rc),
    check_overlap = TRUE
  ) +
  geom_abline(slope = 1,
              linetype = "dashed",
              color = "red") +
  facet_wrap(~ Gene, nrow = 8, ncol = 9) +
  theme_bw() +
  labs(
    title = "Random1-Normalized CS1 vs. CS3 Gene Expression",
    subtitle = paste0("Samples=", n_distinct(genes_cs13_rand1[["ottaID"]])),
    x = "CS1",
    y = "CS3"
  )

print(p_genes_cs13_rand1)
```

```{r genes-cs23-rand1, fig.height=10, fig.width=11, out.width='100%', fig.cap='Random1-Normalized CS2 vs. CS3 Gene Expression'}
genes_cs23_rand1 <- train_ref_comb %>%
  rownames_to_column("FileName") %>%
  group_by(ottaID) %>%
  mutate(n_codeset = n_distinct(CodeSet)) %>%
  filter(all(c("CS2", "CS3") %in% CodeSet)) %>%
  group_by(ottaID, CodeSet) %>%
  filter(n_codeset > 1, !duplicated(ottaID)) %>%
  ungroup() %>%
  pivot_longer(
    cols = where(is.double),
    names_to = "Gene",
    names_ptypes = list(Gene = factor()),
    values_to = "Value"
  ) %>%
  pivot_wider(
    id_cols = c(ottaID, Gene),
    names_from = "CodeSet",
    values_from = c("Value", "FileName")
  ) %>%
  group_by(Gene) %>%
  mutate(Rc = epiR::epi.ccc(Value_CS2, Value_CS3)[["rho.c"]][["est"]]) %>%
  ungroup() %>%
  mutate(Gene = fct_reorder(Gene, Rc, .desc = TRUE),
         Rc = paste0("Rc = ", round(Rc, digits = 3)))

p_genes_cs23_rand1 <-
  ggplot(genes_cs23_rand1, aes(x = Value_CS2, y = Value_CS3)) +
  geom_point() +
  geom_text(
    x = -24,
    y = 5,
    size = 3,
    hjust = 0,
    vjust = 1,
    aes(label = Rc),
    check_overlap = TRUE
  ) +
  geom_abline(slope = 1,
              linetype = "dashed",
              color = "red") +
  facet_wrap(~ Gene, nrow = 8, ncol = 9) +
  theme_bw() +
  labs(
    title = "Random1-Normalized CS2 vs. CS3 Gene Expression",
    subtitle = paste0("Samples=", n_distinct(genes_cs23_rand1[["ottaID"]])),
    x = "CS2",
    y = "CS3"
  )

print(p_genes_cs23_rand1)
```

```{r genes-cs13-hkgenes, fig.height=10, fig.width=11, out.width='100%', fig.cap='HKgenes-Normalized CS1 vs. CS3 Gene Expression'}
genes_cs13_hkgenes <-
  list(CS1 = cs1_norm, CS3 = cs3_norm) %>%
  imap(~ {
    .x %>%
      rename_all(~ gsub("^X", "", .)) %>%
      pivot_longer(where(is.double),
                   names_to = "FileName",
                   values_to = "Value") %>%
      inner_join(genes_cs13_rand1,
                 by = c("Name" = "Gene", "FileName" = paste0("FileName_", .y))) %>%
      select(Name, FileName, ottaID, Value)
  }) %>%
  reduce(inner_join,
         by = c("Name", "ottaID"),
         suffix = c("_CS1", "_CS3")) %>%
  select(ottaID, Gene = Name, everything()) %>%
  group_by(Gene) %>%
  mutate(Rc = epiR::epi.ccc(Value_CS1, Value_CS3)[["rho.c"]][["est"]]) %>%
  ungroup() %>%
  mutate(Gene = fct_reorder(Gene, Rc, .desc = TRUE),
         Rc = paste0("Rc = ", round(Rc, digits = 3)))

p_genes_cs13_hkgenes <- 
  ggplot(genes_cs13_hkgenes, aes(x = Value_CS1, y = Value_CS3)) +
  geom_point() +
  geom_text(
    x = -24,
    y = 5,
    size = 3,
    hjust = 0,
    vjust = 1,
    aes(label = Rc),
    check_overlap = TRUE
  ) +
  geom_abline(slope = 1,
              linetype = "dashed",
              color = "red") +
  facet_wrap(~ Gene, nrow = 8, ncol = 9) +
  theme_bw() +
  labs(
    title = "HKgenes-Normalized CS1 vs. CS3 Gene Expression",
    subtitle = paste0("Samples=",
                      n_distinct(genes_cs13_hkgenes[["ottaID"]])),
    x = "CS1",
    y = "CS3"
  )

print(p_genes_cs13_hkgenes)
```

```{r genes-cs23-hkgenes, fig.height=10, fig.width=11, out.width='100%', fig.cap='HKgenes-Normalized CS2 vs. CS3 Gene Expression'}
genes_cs23_hkgenes <-
  list(CS2 = cs2_norm, CS3 = cs3_norm) %>%
  imap(~ {
    .x %>%
      rename_all(~ gsub("^X", "", .)) %>%
      pivot_longer(where(is.double),
                   names_to = "FileName",
                   values_to = "Value") %>%
      inner_join(genes_cs23_rand1,
                 by = c("Name" = "Gene", "FileName" = paste0("FileName_", .y))) %>%
      select(Name, FileName, ottaID, Value)
  }) %>%
  reduce(inner_join,
         by = c("Name", "ottaID"),
         suffix = c("_CS2", "_CS3")) %>%
  select(ottaID, Gene = Name, everything()) %>%
  group_by(Gene) %>%
  mutate(Rc = epiR::epi.ccc(Value_CS2, Value_CS3)[["rho.c"]][["est"]]) %>%
  ungroup() %>%
  mutate(Gene = fct_reorder(Gene, Rc, .desc = TRUE),
         Rc = paste0("Rc = ", round(Rc, digits = 3)))

p_genes_cs23_hkgenes <- 
  ggplot(genes_cs23_hkgenes, aes(x = Value_CS2, y = Value_CS3)) +
  geom_point() +
  geom_text(
    x = -24,
    y = 5,
    size = 3,
    hjust = 0,
    vjust = 1,
    aes(label = Rc),
    check_overlap = TRUE
  ) +
  geom_abline(slope = 1,
              linetype = "dashed",
              color = "red") +
  facet_wrap(~ Gene, nrow = 8, ncol = 9) +
  theme_bw() +
  labs(
    title = "HKgenes-Normalized CS2 vs. CS3 Gene Expression",
    subtitle = paste0("Samples=",
                      n_distinct(genes_cs23_hkgenes[["ottaID"]])),
    x = "CS2",
    y = "CS3"
  )

print(p_genes_cs23_hkgenes)
```
