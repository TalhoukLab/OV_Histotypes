# Distributions

```{r setup-03}
library(Amisc)
library(batchAdj)
library(forcats)
library(scales)
library(patchwork)
library(here)
source(here("validation/cs_classifier.R"))
```

## Histotypes in Classifier Data

```{r preqc-hist-codeset}
cs1_samples_preqc <- cohorts %>%
  filter(
    file_source == "cs1",
    cohort %in% c("MAYO", "OOU", "OOUE", "VOA", "MTL")
  ) %>%
  pull(col_name)

cs2_samples_preqc <- cohorts %>%
  filter(
    file_source == "cs2",
    cohort %in% c("MAYO", "OOU", "OOUE", "OVAR3", "VOA", "ICON7", "JAPAN", "MTL", "POOL-CTRL"),
  ) %>%
  pull(col_name)

cs3_samples_preqc <- cohorts %>%
  filter(
    file_source == "cs3",
    cohort %in% c("DOVE4", "OOU", "OOUE", "TNCO", "VOA", "POOL-1", "POOL-2", "POOL-3"),
    !cohort %in% c("TNCO", "DOVE4"),
    !grepl("pool", col_name, ignore.case = TRUE)
  ) %>%
  pull(col_name)

preqc_df <-
  list(list(cs1, cs2, cs3),
       list(cs1_samples_preqc, cs2_samples_preqc, cs3_samples_preqc)) %>%
  pmap( ~ {
    ..1 %>%
      dplyr::select(Name, all_of(..2)) %>%
      column_to_rownames("Name") %>%
      t() %>%
      as.data.frame() %>%
      select(all_of(common_genes123))
  }) %>% 
  bind_rows() %>%
  rownames_to_column("FileName") %>%
  mutate(FileName = gsub("^X", "", FileName)) %>% 
  inner_join(hist, by = "FileName") %>%
  filter(revHist %in% c("CCOC", "ENOC", "HGSC", "LGSC", "MUC")) %>%
  column_to_rownames("FileName")

preqc_hist_codeset <- preqc_df %>% 
  mutate(revHist = fct_infreq(revHist)) %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE
  )

knitr::kable(preqc_hist_codeset,
             caption = "Pre-QC Training Set Histotype Distribution by CodeSet")
```

```{r train-hist-codeset}
train_hist_codeset <- train_ref %>% 
  mutate(revHist = fct_infreq(revHist)) %>% 
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "CodeSet",
    test = FALSE,
    total = "bottom",
    bold_var = FALSE
  )

knitr::kable(train_hist_codeset,
             caption = "Full Training Set Histotype Distribution by CodeSet")
```

```{r hist-conf-val}
hist_conf_val <- list(Confirmation = conf_ref,
                      Validation = val_ref) %>% 
  map_dfr(~ select(., revHist), .id = "Data") %>%
  mutate(Data = factor(Data, levels = c("Confirmation", "Validation")),
         revHist = factor(revHist, levels = c("HGSC", "CCOC", "ENOC", "MUC", "LGSC"))) %>%
  describeBy(
    var.names = "revHist",
    var.labels = "Histotype",
    by1 = "Data",
    total = "bottom",
    test = FALSE,
    bold_var = FALSE
  ) %>% 
  select(-Total)

knitr::kable(hist_conf_val,
             caption = "Histotype Distribution in Confirmation and Validation Sets")
```

## Quality Control

### Failed Samples

```{r qc-failed}
qc_failed <- list(CS1 = cs1_qc_failed,
                  CS2 = cs2_qc_failed,
                  CS3 = cs1_qc_failed) %>% 
  map_df(length)

qc_failed %>% 
  kable(caption = "Number of failed sampled by CodeSet")
```


### %GD vs. SNR

```{r qc-gd-snr-all, fig.height=8, fig.cap='% Genes Detected vs. Signal to Noise Ratio'}
p1 <- ggplot(cs1_qc, aes(sn, pergd)) + 
  geom_point() +
  labs(title = "CS1")
p2 <- ggplot(cs2_qc, aes(sn, pergd)) + 
  geom_point() +
  labs(title = "CS2")
p3 <- ggplot(cs3_qc, aes(sn, pergd)) + 
  geom_point() +
  labs(title = "CS3")

p_gd_snr_all <- p1 / p2 / p3 &
  labs(x = "SNR", y = "% GD") &
  geom_vline(xintercept = 100, color = "red", linetype = "dashed") &
  geom_hline(yintercept = 50, color = "red", linetype = "dashed") &
  plot_annotation(title = "% Genes Detected vs. SNR",
                  tag_levels = "a")
print(p_gd_snr_all)
```

```{r qc-gd-snr-zoomed, fig.height=8, fig.cap='% Genes Detected vs. Signal to Noise Ratio (Zoomed)'}
p_gd_snr_zoomed <- p_gd_snr_all &
  lims(x = c(0, 2000)) &
    plot_annotation(title = "% Genes Detected vs. SNR (Zoomed)",
                  tag_levels = "a")
print(p_gd_snr_zoomed)
```
