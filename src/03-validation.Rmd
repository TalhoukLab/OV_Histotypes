# Validation

```{r setup-03}
source(here::here("src/funs.R"))
source(here::here("validation/cs_process.R"))
cs1_class <- readRDS(here::here("data/cs1_class.rds"))
cs2_class <- readRDS(here::here("data/cs2_class.rds"))
```
<!--
## Concordance

First we validate the CS2 normalization process by looking at the distribution of CS3 non-normalized samples with:

- CS2 non-normalized
- CS2 pools-normalized
- CS2 reference-normalized

```{r methods}
# Dataset Split -----------------------------------------------------------

# CS2 gene order
cs2_genes <- names(cs2_clean)[-1:-2]

# Split CS2 common samples into Reference and Validation sets
# Reference set: duplicate samples
cs2_ref <- cs2_clean %>%
  dplyr::filter(duplicated(ottaID) | duplicated(ottaID, fromLast = TRUE)) %>%
  dplyr::select(-FileName)

# Validation set: unique samples
cs2_val <- dplyr::anti_join(cs2_clean, cs2_ref, by = "ottaID") %>%
  dplyr::select(-FileName)


# No Normalization --------------------------------------------------------

# Sort CS2 validation set without normalization to preserve sample order
cs2_val_norm0 <- dplyr::arrange(cs2_val, ottaID)

# Extract CS3 samples corresponding to CS2 validation set without normalization
# Averaged gene expression within duplicates
cs3_val_norm0 <- cs3_clean %>%
  dplyr::select(names(cs2_val_norm0)) %>%
  dplyr::semi_join(cs2_val_norm0, by = "ottaID") %>%
  dplyr::group_by(ottaID) %>%
  dplyr::summarize_if(is.double, mean)


# Pool Method -------------------------------------------------------------

# Pool set: pool samples from CS2
pool_samples <-
  gsub("-|\\.RCC", "", grep("POOL", pools[["CS2-FileName"]], value = TRUE))
cs2_pools <- dplyr::select(cs2_norm, Name, paste0("X", pool_samples))

# Locked down reference pools weights
weights <- c("Pool1", "Pool2", "Pool3") %>%
  purrr::set_names() %>%
  purrr::map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs2_pools_mgx <- weights %>%
  purrr::imap_dfc(~ .x * rowMeans(dplyr::select(cs2_pools, dplyr::matches(.y)))) %>%
  dplyr::transmute(Name = cs2_pools[["Name"]], cs2_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  tibble::enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Transposed validation set
cs2_val_t <- cs2_val %>%
  tidyr::gather(Name, value, -1) %>%
  tidyr::spread(ottaID, value)

# Normalize each gene by adding batch effect (diff in mean gx)
cs2_val_norm1 <-
  dplyr::inner_join(cs3_pools_mgx, cs2_pools_mgx, by = "Name") %>%
  dplyr::transmute(Name, be = cs3_exp - cs2_exp) %>%
  dplyr::inner_join(cs2_val_t, by = "Name") %>%
  tidyr::gather(ottaID, exp, -1:-2) %>%
  dplyr::transmute(Name = factor(Name, levels = cs2_genes), ottaID, exp = be + exp) %>%
  tidyr::spread(Name, exp)


# Reference Method --------------------------------------------------------

# Corresponding samples in CS3 found in CS2 reference set
cs3_ref <- cs3_clean %>%
  dplyr::semi_join(cs2_ref, by = "ottaID") %>%
  dplyr::select(all_of(cs2_genes))

# Remove non-numeric column names
cs2_ref2 <- dplyr::select_if(cs2_ref, is.double)
cs2_val2 <- dplyr::select_if(cs2_val, is.double)

# Normalize by reference method using reference samples
cs2_val_norm2 <- nanostringr::refMethod(cs2_val2, cs2_ref2, cs3_ref) %>%
  tibble::as_tibble() %>%
  tibble::add_column(ottaID = cs2_val[["ottaID"]], .before = 1) %>%
  dplyr::arrange(ottaID)
```

```{r validation}
# Method Comparisons ------------------------------------------------------

# Compare cs2_val_norm0, cs2_val_norm1, cs2_val_norm2, with cs3_val_norm0
cs_combined <-
  tibble::lst(cs2_val_norm0, cs2_val_norm1, cs2_val_norm2, cs3_val_norm0) %>%
  dplyr::bind_rows(.id = "dataset") %>%
  tidyr::gather(gene, exp, -1:-2, factor_key = TRUE) %>%
  tidyr::spread(dataset, exp)

# Common plotting layers
n_samples <- dplyr::n_distinct(cs_combined[["ottaID"]])
layers <- list(
  geom_point(alpha = 0.3),
  geom_abline(slope = 1, intercept = 0, color = "blue"),
  facet_wrap(~ gene, nrow = 8, ncol = 9),
  labs(
    y = "CS3 No Normalization",
    title = paste0("CS2 Validation Set (n=", n_samples,
                   ") vs. Corresponding CS3 Samples")
  )
)
```

```{r cs2-none-vs-cs3, fig.cap='Gene Expression CS2 No Normalization vs. CS3', fig.height=8, fig.width=8}
# Scatterplots of each CS2 dataset vs CS3
p0 <- ggplot(cs_combined, aes(cs2_val_norm0, cs3_val_norm0)) +
  xlab("CS2 No Normalization") +
  layers
print(p0)
```

```{r cs2-pools-vs-cs3, fig.cap='Gene Expression CS2 Pools Normalization vs. CS3', fig.height=8, fig.width=8}
p1 <- ggplot(cs_combined, aes(cs2_val_norm1, cs3_val_norm0)) +
  xlab("CS2 Pools Normalization") +
  layers
print(p1)
```

```{r cs2-reference-vs-cs3, fig.cap='Gene Expression CS2 Reference Normalization vs. CS3', fig.height=8, fig.width=8}
p2 <- ggplot(cs_combined, aes(cs2_val_norm2, cs3_val_norm0)) +
  xlab("CS2 Reference Normalization") +
  layers
print(p2)
```

```{r cc-hist, fig.cap='Concordance Histograms'}
# Concordance Histograms --------------------------------------------------

# Concordance measures between samples of same gene, for each dataset comparison
all_metrics <- cs_combined %>%
  tidyr::gather(Methods, cs2_val_norm, dplyr::matches("cs2")) %>%
  dplyr::mutate(
    Methods = dplyr::recode_factor(
      Methods,
      cs2_val_norm0 = "CS2 None vs. CS3 None",
      cs2_val_norm1 = "CS2 Pools vs. CS3 None",
      cs2_val_norm2 = "CS2 Common vs. CS3 None"
    )
  ) %>%
  dplyr::group_by(Methods, ottaID) %>%
  dplyr::summarize(
    R2 = cor(cs2_val_norm, cs3_val_norm0) ^ 2,
    Ca = epiR::epi.ccc(cs2_val_norm, cs3_val_norm0)[["C.b"]],
    Rc = epiR::epi.ccc(cs2_val_norm, cs3_val_norm0)[["rho.c"]][["est"]]
  ) %>%
  dplyr::ungroup() %>%
  tidyr::gather(Metric, Expression, c("R2", "Ca", "Rc"), factor_key = TRUE)

# Plot all combinations of cross-dataset concordance measure histograms
p <- ggplot(all_metrics, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  facet_grid(rows = vars(Methods), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS2 Datasets vs. CS3 Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p)
```
-->
## Full Data Distributions

The histotype distributions on the full data are shown below.

```{r dist-all-gr}
# Histotype Distributions -------------------------------------------------
all_hist <- hist %>% dplyr::filter(!is.na(revHist))
all_hist %>%
  dplyr::count(CodeSet, hist_gr) %>%
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "All CodeSet Histotype Groups")
```

```{r dist-all}
all_counts <- all_hist %>% dplyr::count(CodeSet, revHist)
all_counts %>%
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "All CodeSet Histotypes")
```

```{r dist-common}
common_counts <- all_hist %>%
  dplyr::filter(FileName %in% common_samples) %>% 
  dplyr::count(CodeSet, revHist)
common_counts %>% 
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  knitr::kable(caption = "Common Summary ID CodeSet Histotypes")
```

```{r dist-major-hist}
all_maj_counts <- all_hist %>% 
  dplyr::filter(revHist %in% c("HGSC", "LGSC", "ENOC", "CCOC", "MUC")) %>% 
  dplyr::count(CodeSet, revHist)
all_maj_counts %>% 
  tidyr::spread(CodeSet, n, fill = 0L) %>% 
  dplyr::mutate(CS1_percent = CS1 /sum(CS1) * 100, CS1_percent = round(CS1_percent,1))  %>% 
  dplyr::mutate(CS2_percent = CS2 /sum(CS2) * 100, CS2_percent = round(CS2_percent,1))  %>% 
  dplyr::mutate(CS3_percent = CS3 /sum(CS3) * 100, CS3_percent = round(CS3_percent,1))  %>% 
  knitr::kable(caption = "All CodeSet Major Histotypes")
```

```{r dist-cs1}
all_counts %>% 
  dplyr::filter(CodeSet == "CS1") %>% 
  knitr::kable(caption = "CS1 Histotypes")
```

```{r dist-cs2}
all_counts %>% 
  dplyr::filter(CodeSet == "CS2") %>% 
  knitr::kable(caption = "CS2 Histotypes")
```

```{r dist-cs3}
all_counts %>% 
  dplyr::filter(CodeSet == "CS3") %>% 
  knitr::kable(caption = "CS3 Histotypes")
```

## Training Set Distributions

The training set distributions for CS1 and CS2 are shown below.

```{r training-dist-cs1}
cs1_class %>% 
  tibble::enframe(value = "histotype") %>% 
  dplyr::count(histotype) %>% 
  knitr::kable(caption = "CS1 Training Set Histotypes")
```

```{r training-dist-cs2}
cs2_class %>% 
  tibble::enframe(value = "histotype") %>% 
  dplyr::count(histotype) %>% 
  knitr::kable(caption = "CS2 Training Set Histotypes")
```

## Normalization

```{r process-cohorts}
source(here::here("validation/cs_process_cohorts.R"))
```

```{r cs-raw}
cs1_raw_avg <- cs1 %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.integer, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

cs2_raw_avg <- cs2 %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.integer, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

cs3_raw_avg <- cs3 %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.integer, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

raw_list <-
  set_names(list(cs1_raw_avg, cs2_raw_avg, cs3_raw_avg), codesets)
```

```{r cc-raw}
metrics_raw <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(raw_list[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

# Plot all combinations of cross-codeset concordance measure histograms
p_raw <- ggplot(metrics_raw, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Raw Non-Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_raw)
```

```{r cs-hknorm}
cs1_hknorm_avg <- cs1_norm %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.double, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

cs2_hknorm_avg <- cs2_norm %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.double, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

cs3_hknorm_avg <- cs3_norm %>%
  rename_all(~ gsub("^X", "", .)) %>%
  filter(Name %in% common_genes) %>%
  select_if(names(.) %in% c("Name", common_samples)) %>%
  mutate(Name = fct_inorder(Name)) %>%
  gather(FileName, value, -Name) %>%
  inner_join(hist, by = "FileName") %>%
  spread(Name, value) %>%
  select(FileName, ottaID, all_of(common_genes)) %>% 
  group_by(ottaID) %>% 
  summarize_if(is.double, mean) %>% 
  ungroup() %>% 
  column_to_rownames("ottaID")

hknorm_list <-
  set_names(list(cs1_hknorm_avg, cs2_hknorm_avg, cs3_hknorm_avg), codesets)
```

```{r cc-hknorm}
metrics_hknorm <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(hknorm_list[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

# Plot all combinations of cross-codeset concordance measure histograms
p_hknorm <- ggplot(metrics_hknorm, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "HK genes Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_hknorm)
```

### Common Samples Method

We employ a new normalization technique using randomly selected samples common to all three CodeSets with a uniform distribution of histotypes as the reference dataset. The number of randomly selected samples ranges from 1-3 per histotype. Hence, the reference dataset has either 5, 10, or 15 samples and we validate on the remaining. Note that ottaID duplicates are collapsed by mean averaging the gene expression. There are n=72 common samples.

CodeSets 1 and 2 are calibrated to CodeSet3 as follows: 

- `X^1(norm) = X^1 - R^1 + R^3`  
- `X^2(norm) = X^2 - R^2 + R^3`  
- `X^3(norm) = X^3`

#### Random3

Randomly choose 3 samples from each of the 5 histotypes as the reference set (n=15). The rest are validated.

```{r cs-norm-rand3}
# Random selection of common samples with equal number of histotypes
set.seed(2020)
hist_rand3 <- hist %>%
  filter(FileName %in% c(cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName)) %>%
  distinct(ottaID, revHist) %>%
  group_by(revHist) %>%
  slice_sample(n = 3) %>%
  ungroup()

# Gene expression from random common samples, preserving gene order
cs1_rand3 <- join_avg(cs1_clean, hist_rand3, "ottaID", "keep")
cs2_rand3 <- join_avg(cs2_clean, hist_rand3, "ottaID", "keep")
cs3_rand3 <- join_avg(cs3_clean, hist_rand3, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs1_counts3 <- join_avg(cs1_clean, hist_rand3, "ottaID", "discard")
cs2_counts3 <- join_avg(cs2_clean, hist_rand3, "ottaID", "discard")
cs3_counts3 <- join_avg(cs3_clean, hist_rand3, "ottaID", "discard")

# Normalize by reference method using common samples, add histotypes from annot
cs1_norm_rand3 <-
  as.data.frame(refMethod(cs1_counts3, cs3_rand3, cs1_rand3))
cs2_norm_rand3 <-
  as.data.frame(refMethod(cs2_counts3, cs3_rand3, cs2_rand3))

# Combined gene expression
counts3 <-
  set_names(list(cs1_counts3, cs2_counts3, cs3_counts3), codesets)
norm_rand3 <-
  set_names(list(cs1_norm_rand3, cs2_norm_rand3, cs3_counts3), codesets) 
# Concordance measures for all genes averaged across samples
metrics_non3 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(counts3[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

metrics_rand3 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(norm_rand3[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()
```

```{r cc-non3, fig.cap='Random3 Non-Normalized Concordance Measure Distributions'}
# Plot all combinations of cross-codeset concordance measure histograms
p_non3 <- ggplot(metrics_non3, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random3 Non-Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_non3)
```

```{r cc-rand3, fig.cap='Random3 Normalized Concordance Measure Distributions'}
p_rand3 <- ggplot(metrics_rand3, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random3 Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand3)
```

#### Random2

Randomly choose 2 samples from each of the 5 histotypes as the reference set (n=10). The rest are validated.

```{r cs-norm-rand2}
# Random selection of common samples with equal number of histotypes
set.seed(2020)
hist_rand2 <- hist %>%
  filter(FileName %in% c(cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName)) %>%
  distinct(ottaID, revHist) %>%
  group_by(revHist) %>%
  slice_sample(n = 2) %>%
  ungroup()

# Gene expression from random common samples, preserving gene order
cs1_rand2 <- join_avg(cs1_clean, hist_rand2, "ottaID", "keep")
cs2_rand2 <- join_avg(cs2_clean, hist_rand2, "ottaID", "keep")
cs3_rand2 <- join_avg(cs3_clean, hist_rand2, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs1_counts2 <- join_avg(cs1_clean, hist_rand2, "ottaID", "discard")
cs2_counts2 <- join_avg(cs2_clean, hist_rand2, "ottaID", "discard")
cs3_counts2 <- join_avg(cs3_clean, hist_rand2, "ottaID", "discard")

# Normalize by reference method using common samples, add histotypes from annot
cs1_norm_rand2 <-
  as.data.frame(refMethod(cs1_counts2, cs3_rand2, cs1_rand2))
cs2_norm_rand2 <-
  as.data.frame(refMethod(cs2_counts2, cs3_rand2, cs2_rand2))

# Combined gene expression
counts2 <-
  set_names(list(cs1_counts2, cs2_counts2, cs3_counts2), codesets)
norm_rand2 <-
  set_names(list(cs1_norm_rand2, cs2_norm_rand2, cs3_counts2), codesets)

# Concordance measures for all genes averaged across samples
metrics_non2 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(counts2[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

metrics_rand2 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(norm_rand2[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()
```

```{r cc-non2, fig.cap='Random2 Non-Normalized Concordance Measure Distributions'}
# Plot all combinations of cross-codeset concordance measure histograms
p_non2 <- ggplot(metrics_non2, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random2 Non-Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_non2)
```

```{r cc-rand2, fig.cap='Random2 Normalized Concordance Measure Distributions'}
p_rand2 <- ggplot(metrics_rand2, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 50, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random2 Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand2)
```

#### Random1

Randomly choose 1 sample from each of the 5 histotypes as the reference set (n=5). The rest are validated.

```{r cs-norm-rand1}
# Random selection of common samples with equal number of histotypes
set.seed(2020)
hist_rand1 <- hist %>%
  filter(FileName %in% c(cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName)) %>%
  distinct(ottaID, revHist) %>%
  group_by(revHist) %>%
  slice_sample(n = 1) %>%
  ungroup()

# Gene expression from random common samples, preserving gene order
cs1_rand1 <- join_avg(cs1_clean, hist_rand1, "ottaID", "keep")
cs2_rand1 <- join_avg(cs2_clean, hist_rand1, "ottaID", "keep")
cs3_rand1 <- join_avg(cs3_clean, hist_rand1, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs1_counts1 <- join_avg(cs1_clean, hist_rand1, "ottaID", "discard")
cs2_counts1 <- join_avg(cs2_clean, hist_rand1, "ottaID", "discard")
cs3_counts1 <- join_avg(cs3_clean, hist_rand1, "ottaID", "discard")

# Normalize by reference method using common samples, add histotypes from annot
cs1_norm_rand1 <-
  as.data.frame(refMethod(cs1_counts1, cs3_rand1, cs1_rand1))
cs2_norm_rand1 <-
  as.data.frame(refMethod(cs2_counts1, cs3_rand1, cs2_rand1))

# Combined gene expression
counts1 <-
  set_names(list(cs1_counts1, cs2_counts1, cs3_counts1), codesets)
norm_rand1 <-
  set_names(list(cs1_norm_rand1, cs2_norm_rand1, cs3_counts1), codesets)

# Concordance measures for all genes averaged across samples
metrics_non1 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(counts1[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

metrics_rand1 <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(norm_rand1[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()
```

```{r cc-non1, fig.cap='Random1 Non-Normalized Concordance Measure Distributions'}
# Plot all combinations of cross-codeset concordance measure histograms
p_non1 <- ggplot(metrics_non1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random1 Non-Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_non1)
```

```{r cc-rand1, fig.cap='Random1 Normalized Concordance Measure Distributions'}
p_rand1 <- ggplot(metrics_rand1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random1 Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand1)
```

In Tables \@ref(tab:rand1-cs1-vs-cs3) and \@ref(tab:rand1-cs2-vs-cs3), we calculate the concordance measures for CS1 vs. CS3 and CS2 cs. CS3, respectively. The measures are calculated for both non-normalized and normalized datasets (CS1, CS2), and split by histotype.

```{r rand1-cc-by-hist}
cs1_norm_rand1_byhist <- split_hist(cs1_norm_rand1, hist_df)
cs2_norm_rand1_byhist <-  split_hist(cs2_norm_rand1, hist_df)
cs1_counts1_byhist <- split_hist(cs1_counts1, hist_df)
cs2_counts1_byhist <- split_hist(cs2_counts1, hist_df)
cs3_counts1_byhist <- split_hist(cs3_counts1, hist_df)
```

```{r rand1-cs1-vs-cs3}
rand1_cs1_vs_cs3_non <- list(cs1_counts1_byhist, cs3_counts1_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Non"))
rand1_cs1_vs_cs3_norm <- list(cs1_norm_rand1_byhist, cs3_counts1_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Norm"))
rand1_cs1_vs_cs3 <-
  inner_join(rand1_cs1_vs_cs3_non, rand1_cs1_vs_cs3_norm, by = "hist")

knitr::kable(rand1_cs1_vs_cs3,
             caption = "Random1 CS1 vs. CS3 Median Concordance Measures by Histotypes",
             digits = 2)
```

```{r rand1-cs2-vs-cs3}
rand1_cs2_vs_cs3_non <- list(cs2_counts1_byhist, cs3_counts1_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Non"))
rand1_cs2_vs_cs3_norm <- list(cs2_norm_rand1_byhist, cs3_counts1_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Norm"))
rand1_cs2_vs_cs3 <-
  inner_join(rand1_cs2_vs_cs3_non, rand1_cs2_vs_cs3_norm, by = "hist")

knitr::kable(rand1_cs2_vs_cs3,
             caption = "Random1 CS2 vs. CS3 Median Concordance Measures by Histotypes",
             digits = 2)
```

#### Random3 HGSC

Randomly choose n=3 HGSC samples as the reference set, and use the rest as validation. This was tried in lieu of the fact that some non-HGSC histotypes have at most n=3 samples in total, so using Random3 or even Random2 would leave no samples remaining in the validation set for these histotypes.

```{r cs-norm-hgsc3}
# Random selection of common samples with equal number of histotypes
set.seed(2020)
hist_rand <- hist %>%
  filter(ottaID %in% unique(c(
    cs1_clean$ottaID, cs2_clean$ottaID, cs3_clean$ottaID
  ))) %>%
  distinct(ottaID, revHist) %>%
  filter(revHist == "HGSC") %>%
  slice_sample(n = 3)

# Gene expression from random common samples, preserving gene order
cs1_rand <- join_avg(cs1_clean, hist_rand, "ottaID", "keep")
cs2_rand <- join_avg(cs2_clean, hist_rand, "ottaID", "keep")
cs3_rand <- join_avg(cs3_clean, hist_rand, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs1_counts <- join_avg(cs1_clean, hist_rand, "ottaID", "discard")
cs2_counts <- join_avg(cs2_clean, hist_rand, "ottaID", "discard")
cs3_counts <- join_avg(cs3_clean, hist_rand, "ottaID", "discard")

# Normalize by reference method using common samples, add histotypes from annot
cs1_norm_rand <-
  as.data.frame(refMethod(cs1_counts, cs3_rand, cs1_rand))
cs2_norm_rand <-
  as.data.frame(refMethod(cs2_counts, cs3_rand, cs2_rand))

norm_rand <-
  set_names(list(cs1_norm_rand, cs2_norm_rand, cs3_counts), codesets)

metrics_rand <- all_codesets %>%
  imap_dfr(~ {
    pmap_dfr(norm_rand[.x], ~ cor_stats(.x, .y)) %>%
      mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()
```

```{r cc-rand, fig.cap='Random3 HGSC Normalized Concordance Measure Distributions'}
p_rand <- ggplot(metrics_rand, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random3 HGSC Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand)
```

In Tables \@ref(tab:rand3-hgsc-cs1-vs-cs3) and \@ref(tab:rand3-hgsc-cs2-vs-cs3), we calculate the concordance measures for CS1 vs. CS3 and CS2 cs. CS3, respectively. The measures are calculated for both non-normalized and normalized datasets (CS1, CS2), and split by histotype.

```{r rand3-hgsc-cc-by-hist}
cs1_norm_byhist <- split_hist(cs1_norm_rand, hist_df)
cs2_norm_byhist <- split_hist(cs2_norm_rand, hist_df)
cs1_byhist <- split_hist(cs1_counts, hist_df)
cs2_byhist <- split_hist(cs2_counts, hist_df)
cs3_byhist <- split_hist(cs3_counts, hist_df)
```

```{r rand3-hgsc-cs1-vs-cs3}
rand3_hgsc_cs1_vs_cs3_non <- list(cs1_byhist, cs3_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, ~ cor_stats(.x, .y), .id = "gene"),
          .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Non"))
rand3_hgsc_cs1_vs_cs3_norm <- list(cs1_norm_byhist, cs3_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, ~ cor_stats(.x, .y), .id = "gene"),
          .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Norm"))
rand3_hgsc_cs1_vs_cs3 <- 
  inner_join(rand3_hgsc_cs1_vs_cs3_non, rand3_hgsc_cs1_vs_cs3_norm, by = "hist")

knitr::kable(rand3_hgsc_cs1_vs_cs3, caption = "Random3 HGSC CS1 vs. CS3 Median Concordance Measures by Histotypes", digits = 2)
```

```{r rand3-hgsc-cs2-vs-cs3}
rand3_hgsc_cs2_vs_cs3_non <- list(cs2_byhist, cs3_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, ~ cor_stats(.x, .y), .id = "gene"),
          .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Non"))
rand3_hgsc_cs2_vs_cs3_norm <- list(cs2_norm_byhist, cs3_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, ~ cor_stats(.x, .y), .id = "gene"),
          .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup() %>% 
  rename_if(is.double, ~ paste0(., "-Norm"))
rand3_hgsc_cs2_vs_cs3 <- 
  inner_join(rand3_hgsc_cs2_vs_cs3_non, rand3_hgsc_cs2_vs_cs3_norm, by = "hist")

knitr::kable(rand3_hgsc_cs2_vs_cs3, caption = "Random3 HGSC CS2 vs. CS3 Median Concordance Measures by Histotypes", digits = 2)
```

#### Random1 for Sites

We use the Random1 method to normalize CS3-USC and CS3-AOC to CS3-VAN. There aren't enough samples in the USC and AOC cohorts to perform Random2 or Random3.

```{r site-norm-rand1}
set.seed(2020)
hist_site_rand1 <- hist %>%
  filter(
    FileName %in%
      c(cs3_clean_van$FileName,
        cs3_clean_aoc$FileName,
        cs3_clean_usc$FileName)
  ) %>%
  distinct(ottaID, revHist) %>%
  group_by(revHist) %>%
  slice_sample(n = 1) %>%
  ungroup()

# Gene expression from random common samples, preserving gene order
cs3_usc_rand1 <- join_avg(cs3_clean_usc, hist_site_rand1, "ottaID", "keep")
cs3_aoc_rand1 <- join_avg(cs3_clean_aoc, hist_site_rand1, "ottaID", "keep")
cs3_van_rand1 <- join_avg(cs3_clean_van, hist_site_rand1, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs3_usc_counts1 <- join_avg(cs3_clean_usc, hist_site_rand1, "ottaID", "discard")
cs3_aoc_counts1 <- join_avg(cs3_clean_aoc, hist_site_rand1, "ottaID", "discard")
cs3_van_counts1 <- join_avg(cs3_clean_van, hist_site_rand1, "ottaID", "discard")

# Normalize by reference method using common samples, add histotypes from annot
cs3_norm_usc_rand1 <-
  refMethod(cs3_usc_counts1, cs3_van_rand1, cs3_usc_rand1) %>%
  as.data.frame() %>%
  rownames_to_column("ottaID") %>%
  inner_join(hist %>% distinct(ottaID, revHist), by = "ottaID") %>%
  column_to_rownames("ottaID")

cs3_norm_aoc_rand1 <-
  refMethod(cs3_aoc_counts1, cs3_van_rand1, cs3_aoc_rand1) %>%
  as.data.frame() %>%
  rownames_to_column("ottaID") %>%
  inner_join(hist %>% distinct(ottaID, revHist), by = "ottaID") %>%
  column_to_rownames("ottaID")

# Combined gene expression
site_counts1 <-
  set_names(list(cs3_usc_counts1, cs3_aoc_counts1, cs3_van_counts1), sites)
norm_site_rand1 <- list(cs3_norm_usc_rand1, cs3_norm_aoc_rand1, cs3_van_counts1) %>%
  set_names(sites) %>%
  map_at(1:2, select, -"revHist")

# Concordance measures for all genes averaged across samples
metrics_site_non1 <- all_xsites %>%
  imap_dfr(~ {
    pmap_dfr(site_counts1[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

metrics_site_rand1 <- all_xsites %>%
  imap_dfr(~ {
    pmap_dfr(norm_site_rand1[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()
```

```{r cc-site-non1, fig.cap='Cross-Site Random1 Non-Normalized Concordance Measure Distributions'}
# Plot all combinations of cross-codeset concordance measure histograms
p_site_non1 <- ggplot(metrics_site_non1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 400, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Cross-Site Random1 Non-Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_site_non1)
```

```{r cc-site-rand1}
p_site_rand1 <- ggplot(metrics_site_rand1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 400, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Cross-Site Random1 Normalized Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_site_rand1)
```


### Pools Method

#### CS2 vs. CS3

CodeSet2 contains 12 ref pool samples (Pool 1 = 4, Pool 2 = 4, Pool 3 = 4). CodeSet3 contains 22 ref pool samples (Pool 1 = 12, Pool 2 = 5, Pool 3 = 5). n=84 common samples.

CodeSet2 is calibrated to CodeSet3 as follows:  
`X^2(norm) = X^2 - R^2 + R^3`  
`X^3(norm) = X^3`  

```{r cs-norm-pools}
# Pool set: pool samples from CS2
pool_samples <- cohorts %>% 
  filter(file_source == "cs2", cohort == "POOL-CTRL") %>% 
  pull(col_name)
cs2_pools <- select(cs2_norm, Name, all_of(pool_samples))

# Locked down reference pools weights
weights <- c("Pool1", "Pool2", "Pool3") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs2_pools_mgx <- weights %>%
  imap_dfc(~ .x * rowMeans(select(cs2_pools, matches(.y)))) %>%
  transmute(Name = cs2_pools[["Name"]], cs2_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Extract cs2 norm counts (not pools)
cs2_norm_counts <- cs2_norm %>% select(-one_of(names(cs2_pools)[-1]))

# Normalize each gene by adding batch effect (diff in mean gx)
cs2_normalized_data_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs2_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)

## Summary
# CS2 pools: 9 samples, 365 genes # dim(t(cs2_pools))
# CS3 pools: 22 samples, 513 genes # dim(t(ref_pools))
# CS2 normalized: 891 samples (903 original - 12 from pools), 136 common genes # dim(cs2_normalized_data_pools)


# Keep only common samples between codesets, average out duplicates
tmp2 <- cs2_norm_counts %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>% 
  filter(Name %in% names(cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

tmp3 <- cs3_norm_van %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>% 
  filter(Name %in% names(cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

cs2_common_non <- semi_join(tmp2, tmp3, by = "ottaID")
cs3_common_non <- semi_join(tmp3, tmp2, by = "ottaID")

# Extract cs2 common pools-normalized
cs2_common_pools <- cs2_normalized_data_pools %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>% 
  group_by(ottaID) %>%
  summarize_if(is.double, mean) %>%
  ungroup() %>% 
  semi_join(cs3_common_non, by = "ottaID") %>% 
  column_to_rownames("ottaID")

# Move ottaID to rownames
cs2_common_non <- column_to_rownames(cs2_common_non, "ottaID")
cs3_common_non <- column_to_rownames(cs3_common_non, "ottaID")

# Combined gene expression
sets <- c("CS2Non", "CS2Pools", "CS3Non")
all_comps <- combn(sets, 2) %>%
  as_tibble(.name_repair = "unique") %>%
  set_names(map_chr(., paste, collapse = "_vs_"))
common_gx <-
  set_names(list(cs2_common_non, cs2_common_pools, cs3_common_non), sets)

# Concordance measures for all genes averaged across samples
metrics_pools <- all_comps %>%
  imap_dfr(~ {
    pmap_dfr(common_gx[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>% 
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>% 
  mutate(Sites = factor(Sites, levels = names(all_comps)))
```

```{r cc-cs2non-vs-cs2pools, fig.cap='CS2Non vs. CS2Pools Concordance Measure Distributions', fig.height=2}
p_cs2non_vs_cs2pools <-
  ggplot(metrics_pools %>% filter(Sites == "CS2Non_vs_CS2Pools"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 120, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS2Non vs. CS2Pools Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_cs2non_vs_cs2pools)
```

```{r cc-cs2non-vs-cs3, fig.cap='CS2 Non-Normalized Pools vs. CS3 Concordance Measure Distributions', fig.height=2}
p_cs2non_vs_cs3 <-
  ggplot(metrics_pools %>% filter(Sites == "CS2Non_vs_CS3Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS2 Non-Normalized Pools vs. CS3 Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_cs2non_vs_cs3)
```

```{r cc-cs2pools-vs-cs3, fig.cap='CS2 Normalized Pools vs. CS3 Concordance Measure Distributions', fig.height=2}
p_cs2pools_vs_cs3 <-
  ggplot(metrics_pools %>% filter(Sites == "CS2Pools_vs_CS3Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS2 Normalized Pools vs. CS3 Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_cs2pools_vs_cs3)
```

```{r pools-cc-by-hist}
cs2_common_non_byhist <- split_hist(cs2_common_non, hist_df)
cs2_common_pools_byhist <- split_hist(cs2_common_pools, hist_df)
cs3_common_non_byhist <- split_hist(cs3_common_non, hist_df)
```

```{r pools-cs2non-vs-cs3}
pools_cs2non_vs_cs3 <- list(cs2_common_non_byhist,
                            cs3_common_non_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup()

knitr::kable(pools_cs2non_vs_cs3,
             caption = "Pools Non-Normalized CS2 vs. CS3 Median Concordance Measures by Histotypes",
             digits = 2)
```

```{r pools-cs2norm-vs-cs3}
pools_cs2norm_vs_cs3 <- list(cs2_common_pools_byhist,
                             cs3_common_non_byhist) %>%
  transpose() %>%
  map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
  group_by(hist) %>%
  summarize_if(is.double, median) %>%
  ungroup()

knitr::kable(pools_cs2norm_vs_cs3,
             caption = "Pools Normalized CS2 vs. CS3 Median Concordance Measures by Histotypes",
             digits = 2)
```

#### USC vs. VAN

In CodeSet 3, we normalize the USC and AOC cohorts to the VAN cohort which is used as the reference dataset.

```{r usc-vs-van-pools}
# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs3_usc_pools_mgx <- weights %>%
  imap_dfc(~ .x * rowMeans(select(cs3_usc_R, matches(.y)))) %>%
  transmute(Name = cs3_usc_R[["Name"]], cs3_usc_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_van_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_van_exp")

# Normalize each gene by adding batch effect (diff in mean gx)
cs3_usc_normalized_data_pools <-
  inner_join(cs3_usc_pools_mgx, cs3_van_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_van_exp - cs3_usc_exp) %>%
  inner_join(cs3_usc_X, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)

## Summary
# CS3-USC pools: 17 samples, 513 genes # dim(t(cs3_usc_R))
# CS3-VAN pools: 22 samples, 513 genes # dim(t(ref_pools))
# CS3-USC normalized: 30 samples (47 original - 17 from pools), 513 common genes # dim(cs3_usc_normalized_data_pools)

tmp_usc_X <- cs3_usc_X %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs3_usc_normalized_data_pools)[-1],
         FileName %in% common_site_samples) %>%
  mutate(Name = factor(Name, levels = names(cs3_usc_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, revHist, exp) %>%
  group_by(Name, ottaID, revHist) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

tmp_van_X <- cs3_van_X %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs3_usc_normalized_data_pools)[-1],
         FileName %in% common_site_samples) %>%
  mutate(Name = factor(Name, levels = names(cs3_usc_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, revHist, exp) %>%
  group_by(Name, ottaID, revHist) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

usc_X_common <- semi_join(tmp_usc_X, tmp_van_X, by = "ottaID")
van_X_common <- semi_join(tmp_van_X, tmp_usc_X, by = "ottaID")

# Extract USC common pools-normalized
cs3_usc_common_pools <- cs3_usc_normalized_data_pools %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  group_by(ottaID, revHist) %>%
  summarize_if(is.double, mean) %>%
  ungroup() %>%
  semi_join(van_X_common, by = "ottaID")

# Combined gene expression
sets <- c("USC-Non", "USC-Pools", "VAN-Non")
all_comps <- combn(sets, 2) %>%
  as_tibble(.name_repair = "unique") %>%
  set_names(map_chr(., paste, collapse = "_vs_"))
common_gx_usc_van <-
  set_names(list(usc_X_common, cs3_usc_common_pools, van_X_common), sets) %>%
  map(column_to_rownames, "ottaID") %>%
  map(select, -"revHist")

# Concordance measures for all genes averaged across samples
metrics_sites_usc_van <- all_comps %>%
  imap_dfr(~ {
    pmap_dfr(common_gx_usc_van[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>%
  mutate(Sites = factor(Sites, levels = names(all_comps)))
```

```{r cc-uscnon-vs-uscpools, fig.cap='USC-Non vs. USC-Pools Concordance Measure Distributions', fig.height=2}
p_uscnon_vs_uscpools <-
  ggplot(metrics_sites_usc_van %>% filter(Sites == "USC-Non_vs_USC-Pools"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "USC-Non vs. USC-Pools Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_uscnon_vs_uscpools)
```

```{r cc-uscnon-vs-vannon, fig.cap='USC-Non vs. VAN-Non Concordance Measure Distributions', fig.height=2}
p_uscnon_vs_vannon <-
  ggplot(metrics_sites_usc_van %>% filter(Sites == "USC-Non_vs_VAN-Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "USC-Non vs. VAN-Non Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_uscnon_vs_vannon)
```

```{r cc-uscpools-vs-vannon, fig.cap='USC-Pools vs. VAN-Non Concordance Measure Distributions', fig.height=2}
p_uscpools_vs_vannon <-
  ggplot(metrics_sites_usc_van %>% filter(Sites == "USC-Pools_vs_VAN-Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "USC-Pools vs. VAN-Non Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_uscpools_vs_vannon)
```

```{r usc-vs-van-comps, fig.cap='USC vs. VAN Comparisons of Concordance Measure Distributions'}
usc_vs_van_non1 <- metrics_site_non1 %>%
  filter(Sites == "USC_vs_VAN") %>%
  add_column(Method = "Non-Normalized")

usc_vs_van_rand1 <- metrics_site_rand1 %>%
  filter(Sites == "USC_vs_VAN") %>%
  add_column(Method = "Common Samples")

usc_vs_van_pool <- metrics_sites_usc_van %>%
  filter(Sites == "USC-Pools_vs_VAN-Non") %>%
  add_column(Method = "Pools")

usc_vs_van_comps <-
  bind_rows(usc_vs_van_non1, usc_vs_van_rand1, usc_vs_van_pool) %>%
  mutate(Method = factor(Method, levels = c(
    "Non-Normalized", "Common Samples", "Pools"
  )))

p_usc_vs_van <- ggplot(usc_vs_van_comps, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 400, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Method), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "USC vs. VAN Comparisons of Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_usc_vs_van)
```

#### AOC vs. VAN

```{r aoc-vs-van-pools}
# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs3_aoc_pools_mgx <- weights %>%
  imap_dfc(~ .x * rowMeans(select(cs3_aoc_R, matches(.y)))) %>%
  transmute(Name = cs3_aoc_R[["Name"]], cs3_aoc_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_van_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_van_exp")

# Normalize each gene by adding batch effect (diff in mean gx)
cs3_aoc_normalized_data_pools <-
  inner_join(cs3_aoc_pools_mgx, cs3_van_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_van_exp - cs3_aoc_exp) %>%
  inner_join(cs3_aoc_X, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)

## Summary
# CS3-AOC pools: 19 samples, 513 genes # dim(t(cs3_aoc_R))
# CS3-VAN pools: 22 samples, 513 genes # dim(t(ref_pools))
# CS3-AOC normalized: 24 samples (43 original - 19 from pools), 513 common genes # dim(cs3_aoc_normalized_data_pools)

tmp_aoc_X <- cs3_aoc_X %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs3_aoc_normalized_data_pools)[-1],
         FileName %in% common_site_samples) %>%
  mutate(Name = factor(Name, levels = names(cs3_aoc_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, revHist, exp) %>%
  group_by(Name, ottaID, revHist) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

tmp_van_X <- cs3_van_X %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs3_aoc_normalized_data_pools)[-1],
         FileName %in% common_site_samples) %>%
  mutate(Name = factor(Name, levels = names(cs3_aoc_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, revHist, exp) %>%
  group_by(Name, ottaID, revHist) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

aoc_X_common <- semi_join(tmp_aoc_X, tmp_van_X, by = "ottaID")
van_X_common <- semi_join(tmp_van_X, tmp_aoc_X, by = "ottaID")

# Extract AOC common pools-normalized
cs3_aoc_common_pools <- cs3_aoc_normalized_data_pools %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  group_by(ottaID, revHist) %>%
  summarize_if(is.double, mean) %>%
  ungroup() %>%
  semi_join(van_X_common, by = "ottaID")

# Combined gene expression
sets <- c("AOC-Non", "AOC-Pools", "VAN-Non")
all_comps <- combn(sets, 2) %>%
  as_tibble(.name_repair = "unique") %>%
  set_names(map_chr(., paste, collapse = "_vs_"))
common_gx_aoc_van <-
  set_names(list(aoc_X_common, cs3_aoc_common_pools, van_X_common), sets) %>%
  map(column_to_rownames, "ottaID") %>%
  map(select, -"revHist")

# Concordance measures for all genes averaged across samples
metrics_sites_aoc_van <- all_comps %>%
  imap_dfr(~ {
    pmap_dfr(common_gx_aoc_van[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>%
  mutate(Sites = factor(Sites, levels = names(all_comps)))
```

```{r cc-aocnon-vs-aocpools, fig.cap='AOC-Non vs. AOC-Pools Concordance Measure Distributions', fig.height=2}
p_aocnon_vs_aocpools <-
  ggplot(metrics_sites_aoc_van %>% filter(Sites == "AOC-Non_vs_AOC-Pools"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "AOC-Non vs. AOC-Pools Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_aocnon_vs_aocpools)
```

```{r cc-aocnon-vs-vannon, fig.cap='AOC-Non vs. VAN-Non Concordance Measure Distributions', fig.height=2}
p_aocnon_vs_vannon <-
  ggplot(metrics_sites_aoc_van %>% filter(Sites == "AOC-Non_vs_VAN-Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "AOC-Non vs. VAN-Non Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_aocnon_vs_vannon)
```

```{r cc-aocpools-vs-vannon, fig.cap='AOC-Pools vs. VAN-Non Concordance Measure Distributions', fig.height=2}
p_aocpools_vs_vannon <-
  ggplot(metrics_sites_aoc_van %>% filter(Sites == "AOC-Pools_vs_VAN-Non"),
         aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 500, label = Median),
            hjust = 0,
            check_overlap = TRUE) +
  facet_grid(cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "AOC-Pools vs. VAN-Non Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_aocpools_vs_vannon)
```

```{r aoc-vs-van-comps, fig.cap='AOC vs. VAN Comparisons of Concordance Measure Distributions'}
aoc_vs_van_non1 <- metrics_site_non1 %>%
  filter(Sites == "AOC_vs_VAN") %>%
  add_column(Method = "Non-Normalized")

aoc_vs_van_rand1 <- metrics_site_rand1 %>%
  filter(Sites == "AOC_vs_VAN") %>%
  add_column(Method = "Common Samples")

aoc_vs_van_pool <- metrics_sites_aoc_van %>%
  filter(Sites == "AOC-Pools_vs_VAN-Non") %>%
  add_column(Method = "Pools")

aoc_vs_van_comps <-
  bind_rows(aoc_vs_van_non1, aoc_vs_van_rand1, aoc_vs_van_pool) %>%
  mutate(Method = factor(Method, levels = c(
    "Non-Normalized", "Common Samples", "Pools"
  )))

p_aoc_vs_van <- ggplot(aoc_vs_van_comps, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 400, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Method), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "AOC vs. VAN Comparisons of Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_aoc_vs_van)
```

### Common Samples vs. Pools Comparison

Since only CS2 and CS3 have pools, we make three comparisons between these two CodeSets:

- Non-Normalized
- Common Samples Method
- Pools Method

```{r rand3-vs-pools, fig.cap='Random3 Samples Comparisons of Concordance Measure Distributions'}
cs2_vs_cs3_non3 <- metrics_non3 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Non-Normalized")

cs2_vs_cs3_rand3 <- metrics_rand3 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Common Samples")

cs2_counts3_t <- cs2_counts3 %>%
  rownames_to_column("ottaID") %>%
  gather(Name, exp,-1) %>%
  spread(ottaID, exp)

cs2_counts3_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs2_counts3_t, by = "Name") %>%
  gather(ottaID, exp, -1:-2) %>%
  transmute(Name = factor(Name, levels = common_genes), ottaID, exp = be + exp) %>%
  spread(Name, exp) %>% 
  column_to_rownames("ottaID")

cs2_vs_cs3_pools3 <- list(cs2_counts3_pools, cs3_counts3) %>% 
  pmap_dfr(~ cor_stats(.x, .y)) %>% 
  mutate(Sites = "CS2_vs_CS3") %>% 
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>% 
  add_column(Method = "Pools")

cs2_vs_cs3_comps3 <-
  bind_rows(cs2_vs_cs3_non3, cs2_vs_cs3_rand3, cs2_vs_cs3_pools3) %>% 
  mutate(Method = factor(Method, levels = c(
    "Non-Normalized", "Common Samples", "Pools"
  )))

p_comps3 <- ggplot(cs2_vs_cs3_comps3, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Method), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random3 Samples Comparisons of Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_comps3)
```

```{r rand3-vs-pools-stats}
cs2_norm_rand3_byhist <- split_hist(cs2_norm_rand3, hist_df)
cs2_counts3_byhist <- split_hist(cs2_counts3, hist_df)
cs2_counts3_pools_byhist <- split_hist(cs2_counts3_pools, hist_df)
cs3_counts3_byhist <- split_hist(cs3_counts3, hist_df)

rand3_stats <-
  list(Non = cs2_counts3_byhist,
       Common = cs2_norm_rand3_byhist,
       Pools = cs2_counts3_pools_byhist) %>%
  imap(function(x, y) {
    list(x, cs3_counts3_byhist) %>%
      transpose() %>%
      map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
      group_by(hist) %>%
      summarize_if(is.double, median) %>%
      ungroup() %>%
      rename_if(is.double, ~ paste(., y, sep = "-"))
  }) %>%
  reduce(inner_join, by = "hist")

knitr::kable(rand3_stats,
             caption = "Random3 Samples Comparisons Statistics by Histotypes",
             digits = 2)
```

```{r rand2-vs-pools, fig.cap='Random2 Samples Comparisons of Concordance Measure Distributions'}
cs2_vs_cs3_non2 <- metrics_non2 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Non-Normalized")

cs2_vs_cs3_rand2 <- metrics_rand2 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Common Samples")

cs2_counts2_t <- cs2_counts2 %>%
  rownames_to_column("ottaID") %>%
  gather(Name, exp,-1) %>%
  spread(ottaID, exp)

cs2_counts2_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs2_counts2_t, by = "Name") %>%
  gather(ottaID, exp, -1:-2) %>%
  transmute(Name = factor(Name, levels = common_genes), ottaID, exp = be + exp) %>%
  spread(Name, exp) %>% 
  column_to_rownames("ottaID")

cs2_vs_cs3_pools2 <- list(cs2_counts2_pools, cs3_counts2) %>% 
  pmap_dfr(~ cor_stats(.x, .y)) %>% 
  mutate(Sites = "CS2_vs_CS3") %>% 
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>% 
  add_column(Method = "Pools")

cs2_vs_cs3_comps2 <-
  bind_rows(cs2_vs_cs3_non2, cs2_vs_cs3_rand2, cs2_vs_cs3_pools2) %>% 
  mutate(Method = factor(Method, levels = c(
    "Non-Normalized", "Common Samples", "Pools"
  )))

p_comps2 <- ggplot(cs2_vs_cs3_comps2, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Method), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random2 Samples Comparisons of Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_comps2)
```

```{r rand2-vs-pools-stats}
cs2_norm_rand2_byhist <- split_hist(cs2_norm_rand2, hist_df)
cs2_counts2_byhist <- split_hist(cs2_counts2, hist_df)
cs2_counts2_pools_byhist <- split_hist(cs2_counts2_pools, hist_df)
cs3_counts2_byhist <- split_hist(cs3_counts2, hist_df)

rand2_stats <-
  list(Non = cs2_counts2_byhist,
       Common = cs2_norm_rand2_byhist,
       Pools = cs2_counts2_pools_byhist) %>%
  imap(function(x, y) {
    list(x, cs3_counts2_byhist) %>%
      transpose() %>%
      map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
      group_by(hist) %>%
      summarize_if(is.double, median) %>%
      ungroup() %>%
      rename_if(is.double, ~ paste(., y, sep = "-"))
  }) %>%
  reduce(inner_join, by = "hist")

knitr::kable(rand2_stats,
             caption = "Random2 Samples Comparisons Statistics by Histotypes",
             digits = 2)
```

```{r rand1-vs-pools, fig.cap='Random1 Samples Comparisons of Concordance Measure Distributions'}
cs2_vs_cs3_non1 <- metrics_non1 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Non-Normalized")

cs2_vs_cs3_rand1 <- metrics_rand1 %>%
  filter(Sites == "CS2_vs_CS3") %>%
  add_column(Method = "Common Samples")

cs2_counts1_t <- cs2_counts1 %>%
  rownames_to_column("ottaID") %>%
  gather(Name, exp,-1) %>%
  spread(ottaID, exp)

cs2_counts1_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs2_counts1_t, by = "Name") %>%
  gather(ottaID, exp, -1:-2) %>%
  transmute(Name = factor(Name, levels = common_genes), ottaID, exp = be + exp) %>%
  spread(Name, exp) %>% 
  column_to_rownames("ottaID")

cs2_vs_cs3_pools1 <- list(cs2_counts1_pools, cs3_counts1) %>% 
  pmap_dfr(~ cor_stats(.x, .y)) %>% 
  mutate(Sites = "CS2_vs_CS3") %>% 
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup() %>% 
  add_column(Method = "Pools")

cs2_vs_cs3_comps1 <-
  bind_rows(cs2_vs_cs3_non1, cs2_vs_cs3_rand1, cs2_vs_cs3_pools1) %>% 
  mutate(Method = factor(Method, levels = c(
    "Non-Normalized", "Common Samples", "Pools"
  )))

p_comps1 <- ggplot(cs2_vs_cs3_comps1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Method), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random1 Samples Comparisons of Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_comps1)
```

```{r rand1-vs-pools-stats}
cs2_norm_rand1_byhist <- split_hist(cs2_norm_rand1, hist_df)
cs2_counts1_byhist <- split_hist(cs2_counts1, hist_df)
cs2_counts1_pools_byhist <- split_hist(cs2_counts1_pools, hist_df)
cs3_counts1_byhist <- split_hist(cs3_counts1, hist_df)

rand1_stats <-
  list(Non = cs2_counts1_byhist,
       Common = cs2_norm_rand1_byhist,
       Pools = cs2_counts1_pools_byhist) %>%
  imap(function(x, y) {
    list(x, cs3_counts1_byhist) %>%
      transpose() %>%
      map_dfr(~ pmap_df(.x, cor_stats, .id = "gene"), .id = "hist") %>%
      group_by(hist) %>%
      summarize_if(is.double, median) %>%
      ungroup() %>%
      rename_if(is.double, ~ paste(., y, sep = "-"))
  }) %>%
  reduce(inner_join, by = "hist")

knitr::kable(rand1_stats,
             caption = "Random1 Samples Comparisons Statistics by Histotypes",
             digits = 2)
```

### CodeSet Chaining

#### CS1, CS2, CS3

```{r codeset-chaining-cs123}
# Random selection of common samples with equal number of histotypes
set.seed(2020)
hist_rand1 <- hist %>%
  filter(FileName %in% c(cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName)) %>%
  distinct(ottaID, revHist) %>%
  group_by(revHist) %>%
  slice_sample(n = 1) %>%
  ungroup()

# Gene expression from random common samples, preserving gene order
cs1_rand1 <- join_avg(cs1_clean, hist_rand1, "ottaID", "keep")
cs2_rand1 <- join_avg(cs2_clean, hist_rand1, "ottaID", "keep")
cs3_rand1 <- join_avg(cs3_clean, hist_rand1, "ottaID", "keep")

# Remove common samples from CS1, preserving gene order
cs1_counts1 <- join_avg(cs1_clean, hist_rand1, "ottaID", "discard")
cs2_counts1 <- join_avg(cs2_clean, hist_rand1, "ottaID", "discard")
cs3_counts1 <- join_avg(cs3_clean, hist_rand1, "ottaID", "discard")

# Normalize by reference method using common samples
cs1_norm_rand1 <-
  as.data.frame(refMethod(cs1_counts1, cs2_rand1, cs1_rand1))

# Pool set: pool samples from CS2
pool_samples <- cohorts %>%
  filter(file_source == "cs2", cohort == "POOL-CTRL") %>%
  pull(col_name)
cs2_pools <- select(cs2_norm, Name, all_of(pool_samples))

# Locked down reference pools weights
weights <- c("Pool1", "Pool2", "Pool3") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS2 pools (using reference pools weights)
cs2_pools_mgx <- weights %>%
  imap_dfc(~ .x * rowMeans(select(cs2_pools, matches(.y)))) %>%
  transmute(Name = cs2_pools[["Name"]], cs2_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Extract cs2 norm counts (not pools) and add cs1 norm counts
cs1_norm_rand1_t <- cs1_norm_rand1 %>%
  rownames_to_column("ottaID") %>%
  pivot_longer(names_to = "Name", values_to = "exp", -1) %>%
  pivot_wider(names_from = "ottaID", values_from = "exp")
cs1_cs2_norm_counts <- cs2_norm %>%
  select(-one_of(names(cs2_pools)[-1])) %>%
  inner_join(cs1_norm_rand1_t, by = "Name")

# Normalize each gene by adding batch effect (diff in mean gx)
cs1_cs2_normalized_data_pools <-
  inner_join(cs2_pools_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs2_exp) %>%
  inner_join(cs1_cs2_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)
```

```{r cs-chain-rand1, fig.cap='Random1 Concordance Measure Distributions'}
counts1 <- list(cs1_counts1, cs2_counts1, cs1_norm_rand1) %>%
  set_names(c("CS1-Non", "CS2-Non", "CS1-Random1"))

comps1 <- tibble(
  `CS1-Non_vs_CS2-Non` = c("CS1-Non", "CS2-Non"),
  `CS1-Random1_vs_CS2-Non` = c("CS1-Random1", "CS2-Non")
)

metrics_rand1 <- comps1 %>%
  imap_dfr(~ {
    pmap_dfr(counts1[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

p_rand1 <- ggplot(metrics_rand1, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random1 Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand1)
```

```{r cs-chain-rand1-cs2pools, fig.cap='Random1 + Pools Concordance Measure Distributions'}
tmp12 <- cs1_cs2_norm_counts %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs1_cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs1_cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>%
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

tmp3 <- cs3_norm_van %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  filter(Name %in% names(cs1_cs2_normalized_data_pools)[-1]) %>%
  mutate(Name = factor(Name, levels = names(cs1_cs2_normalized_data_pools)[-1])) %>%
  select(Name, ottaID, exp) %>%
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

cs12_common <- semi_join(tmp12, tmp3, by = "ottaID")
cs3_common <- semi_join(tmp3, tmp12, by = "ottaID")

# Extract cs1 random 1 + cs2 common pools-normalized
cs2_common_pools <- cs1_cs2_normalized_data_pools %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "FileName") %>%
  group_by(ottaID) %>%
  summarize_if(is.double, mean) %>%
  ungroup() %>%
  semi_join(cs3_common, by = "ottaID") %>%
  column_to_rownames("ottaID")

cs12_rand1_pools <- cs1_cs2_normalized_data_pools %>%
  mutate(ottaID = gsub("^X", "", FileName)) %>%
  inner_join(hist, by = "ottaID") %>%
  group_by(ottaID) %>%
  summarize_if(is.double, mean) %>%
  ungroup()

cs3_common_rand1 <- cs3_common %>%
  semi_join(cs12_rand1_pools, by = "ottaID") %>%
  column_to_rownames("ottaID")

cs12_rand1_pools <-  column_to_rownames(cs12_rand1_pools, "ottaID")
cs3_common_pools <- column_to_rownames(cs3_common, "ottaID")

counts2 <- list(cs12_rand1_pools, cs3_common_rand1,
                cs2_common_pools, cs3_common_pools) %>%
  set_names(c("CS1-Random1+Pools", "CS3-Van-CS1/2",
              "CS2-Pools", "CS3-VAN-CS2"))

comps2 <- tibble(
  `CS1-Random1+Pools_vs_CS3-Van` = c("CS1-Random1+Pools", "CS3-Van-CS1/2"),
  `CS2-Pools_vs_CS3-Van` = c("CS2-Pools", "CS3-VAN-CS2")
)

metrics_rand1_pools <- comps2 %>%
  imap_dfr(~ {
    pmap_dfr(counts2[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

p_rand1_pools <- ggplot(metrics_rand1_pools, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "Random1 + Pools Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand1_pools)
```

```{r cs-chain-rand1-cs1v3, fig.cap='CS1 CodeSet Chaining Concordance Measure Distributions'}
counts1v3 <-
  list(cs1_counts1, cs1_norm_rand1, cs12_rand1_pools, cs3_common_rand1) %>%
  set_names(c("CS1-Non", "CS1-Random1", "CS1-Random1+Pools", "CS3")) %>% 
  map(select, names(cs3_common_rand1))

comps1v3 <- tibble(
  `CS1-Non` = c("CS1-Non", "CS3"),
  `CS1-Random1` = c("CS1-Random1", "CS3"),
  `CS1-Random1+Pools` = c("CS1-Random1+Pools", "CS3")
)

metrics_rand1v3 <- comps1v3 %>%
  imap_dfr(~ {
    pmap_dfr(counts1v3[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

p_rand1v3 <- ggplot(metrics_rand1v3, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS1 CodeSet Chaining Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand1v3)
```

```{r cs-chain-rand1-cs2v3, fig.cap='CS2 CodeSet Chaining Concordance Measure Distributions'}
counts2v3 <-
  list(cs2_counts1, cs3_common_rand1, cs2_common_pools) %>%
  set_names(c("CS2-Non", "CS3-VAN", "CS2-Pools")) %>% 
  map_at(1, select, names(cs3_common_rand1)) %>% 
  map_at(3, `[`, rownames(cs2_counts1), )

comps2v3 <- tibble(
  `CS2-Non` = c("CS2-Non", "CS3-VAN"),
  `CS2-Pools` = c("CS2-Pools", "CS3-VAN")
)

metrics_rand2v3 <- comps2v3 %>%
  imap_dfr(~ {
    pmap_dfr(counts2v3[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.01))) %>%
  ungroup()

p_rand2v3 <- ggplot(metrics_rand2v3, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS2 CodeSet Chaining Concordance Measure Distributions") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_rand2v3)
```

#### CS3, CS4, CS5 using Set B/A

```{r codeset-chaining-cs345}
# Add ottaID and CodeSet to annotNEW
annotNEW <- annotNEW %>%
  mutate(
    ottaID = gsub(".*_(.*)_[0-9]{2}$", "\\1", File.Name) %>%
      gsub("-N1$", "", .),
    CodeSet = recode_factor(
      geneRLF,
      OTTA2017_C6082 = "CS4",
      OTTA2018_C6830 = "CS5",
      OTTA2018_C8440 = "CS6"
    )
  )

# CS4 data excluding samples that failed QC
cs4_exp <- filter(annotNEW, CodeSet == "CS4")
cs4_qc <- NanoStringQC(raw = cs4, exp = cs4_exp, detect = 50, sn = 170)
cs4_qc_failed <- filter(cs4_qc, normFlag == "Failed")[["File.Name"]]
cs4_dat <- HKnorm(cs4) %>% select(-any_of(cs4_qc_failed))

# Pools Set A, B, C from CS4
cs4_pools <- cs4_dat %>% 
  select(Name, matches("pool", ignore.case = TRUE))
cs4_poolsA <- cs4_pools %>% 
  select(Name, matches("Pool ?[1-3|A-C](?!0|1)", perl = TRUE)) %>% 
  rename_with( ~ str_replace_all(
    .,
    c("A_" = "1A_", "B_" = "2B_", "C_" = "3C_", " " = "")
  ))
cs4_poolsB <- cs4_pools %>% 
  select(Name, matches("Pool ?(9|10|11).*")) %>% 
  column_to_rownames("Name")
cs4_poolsC <- cs4_pools %>% 
  select(Name, matches("Pool ?[4-5|7-8].*")) %>% 
  column_to_rownames("Name")

# CS5 data excluding samples that failed QC
cs5_exp <- filter(annotNEW, CodeSet == "CS5")
cs5_qc <- NanoStringQC(raw = cs5, exp = cs5_exp, detect = 50, sn = 170)
cs5_qc_failed <- filter(cs5_qc, normFlag == "Failed", !grepl("POOL", File.Name))[["File.Name"]]
cs5_dat <- HKnorm(cs5) %>% select(-any_of(cs5_qc_failed))

# Pools Set B, C from CS5
cs5_pools <- select(cs5_dat, Name, matches("pool", ignore.case = TRUE))
cs5_poolsB <- select(cs5_pools, Name, matches("POOL(9|10|11)"))
cs5_poolsC <- select(cs5_pools, Name, matches("POOL[4-5|7-8]"))
```

```{r codeset-chaining-cs345-setBA}
# CS4/CS5 overlap 74 (removed 6 samples failed QC)
cs45_overlap <-
  inner_join(cs4_exp, cs5_exp, by = "ottaID", suffix = c(".CS4", ".CS5")) %>%
  filter(!File.Name.CS4 %in% cs4_qc_failed, !File.Name.CS5 %in% cs5_qc_failed) %>%
  select(ottaID, File.Name.CS4, File.Name.CS5)

# Common samples and genes
cs345_common_samples <- unique(cs45_overlap[["ottaID"]])
cs345_common_genes <- cs5_dat[["Name"]]

# Subtitle for common counts
cs345_subtitle <-
  paste0(c("Samples=", "Genes="),
         c(length(cs345_common_samples), length(cs345_common_genes)),
         collapse = ", ")

## Normalize CS5 to CS4 using Set B pools
# CS4 Set B pools weights
cs4_weightsB <- c("Pool ?9.*", "Pool ?10.*", "Pool ?11.*") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(cs4_poolsB), ignore.case = TRUE)))

# Weighted mean gene expression for CS5 pools (using CS4 pools weights)
cs5_poolsB_mgx <- cs4_weightsB %>%
  imap_dfc(~ .x * rowMeans(select(cs5_poolsB, matches(.y)))) %>%
  transmute(Name = cs5_poolsB[["Name"]], cs5_exp = rowSums(.))

# Mean gene expression for CS4 reference pools
cs4_poolsB_mgx <-
  enframe(rowMeans(cs4_poolsB), name = "Name", value = "cs4_exp")

# Extract cs5 norm counts (not pools)
cs5_norm_counts <- cs5_dat %>%
  select(-one_of("Code.Class", "Accession", names(cs5_pools)[-1])) %>% 
  mutate(Name = fct_inorder(Name))

# Normalize each gene by adding batch effect (diff in mean gx)
cs5_norm_B <-
  inner_join(cs5_poolsB_mgx, cs4_poolsB_mgx, by = "Name") %>%
  transmute(Name, be = cs4_exp - cs5_exp) %>%
  inner_join(cs5_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-2) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(FileName, exp) %>% 
  select(all_of(names(cs5_norm_counts)))

## Normalize cs5_norm_B to CS3 using CS4 Set A pools as if originally run in CS4
# Locked down reference pools weights
cs3_weights <- c("Pool ?1.*", "Pool ?2.*", "Pool ?3.*") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS4 pools (using CS3 pools weights)
cs4_poolsA_mgx <- cs3_weights %>%
  imap_dfc(~ .x * rowMeans(select(cs4_poolsA, matches(.y)))) %>%
  transmute(Name = cs4_poolsA[["Name"]], cs4_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Normalize each gene by adding batch effect (diff in mean gx)
cs5_norm_A <-
  inner_join(cs4_poolsA_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs4_exp) %>%
  inner_join(cs5_norm_B, by = "Name") %>%
  gather(FileName, exp, -1:-2) %>%
  transmute(Name = factor(Name, levels = cs5_norm_B$Name),
            FileName, exp = be + exp) %>%
  spread(FileName, exp) %>% 
  select(all_of(names(cs5_norm_counts)))

## Normalize CS4 to CS3 using Set A Pools
# Extract cs4 norm counts (not pools)
cs4_norm_counts <- cs4_dat %>%
  select(-one_of(names(cs4_pools)[-1])) %>% 
  filter(Name %in% cs345_common_genes)

# Normalize each gene by adding batch effect (diff in mean gx)
cs4_norm_A <- 
  inner_join(cs4_poolsA_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs4_exp) %>%
  inner_join(cs4_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)
```

```{r cs-chain-cs5-setBA, fig.cap='CS5 Set B/A Chaining Concordance  Measure Distributions', fig.height=6}
cs35_norm <- cs3_norm_full %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist_all, by = "FileName") %>% 
  filter(Name %in% cs5_norm_counts$Name,
         ottaID %in% cs345_common_samples) %>% 
  mutate(Name = factor(Name, levels = levels(cs5_norm_counts$Name))) %>% 
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

counts5_BA <-
  list(cs35_norm, cs5_norm_counts, cs5_norm_B, cs5_norm_A) %>%
  set_names(c("CS3-Non", "CS5-Non", "CS5-NormB", "CS5-NormA")) %>% 
  map_at(-1, ~ gather(., File.Name.CS5, exp, -Name) %>% 
           spread(Name, exp) %>% 
           inner_join(cs45_overlap, by = "File.Name.CS5") %>% 
           select(-matches("File.Name")) %>% 
           group_by(ottaID) %>% 
           summarize_if(is.double, mean) %>% 
           `rownames<-`(NULL)
  ) %>% 
  map(column_to_rownames, "ottaID")

comps5_BA <- tibble(
  `CS3-Non_vs_CS5-Non` = c("CS3-Non", "CS5-Non"),
  `CS3-Non_vs_CS5-NormB` = c("CS3-Non", "CS5-NormB"),
  `CS3-Non_vs_CS5-NormA` = c("CS3-Non", "CS5-NormA"),
)

metrics_pools5_BA <- comps5_BA %>%
  imap_dfr(~ {
    pmap_dfr(counts5_BA[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  mutate(Sites = fct_inorder(Sites)) %>% 
  group_by(Sites, Metric) %>%
  mutate(
    Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.001))) %>%
  ungroup()

p_pools5_BA <- ggplot(metrics_pools5_BA, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS5 Set B/A Chaining Concordance Measure Distributions",
       subtitle = cs345_subtitle) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_pools5_BA)
```

```{r cs-chain-cs4-setA, fig.cap='CS4 Set A Chaining Concordance Measure Distributions'}
cs34_norm <- cs3_norm_full %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist_all, by = "FileName") %>%
  filter(Name %in% cs4_norm_counts$Name,
         ottaID %in% cs345_common_samples) %>%
  mutate(Name = factor(Name, levels = cs4_norm_counts$Name)) %>%
  select(Name, ottaID, exp) %>%
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

cs4_non <- cs4_norm_counts %>% 
  select(-c(Code.Class, Accession)) %>% 
  gather(FileName, exp, -1) %>% 
  spread(Name, exp) %>% 
  select(any_of(names(cs4_norm_A)))

counts4_A <-
  list(cs34_norm, cs4_non, cs4_norm_A) %>%
  set_names(c("CS3-Non", "CS4-Non", "CS4-NormA")) %>% 
  map_at(-1, ~ inner_join(., cs45_overlap,
                          by = c("FileName" = "File.Name.CS4")) %>% 
           select(-matches("File.Name")) %>% 
           group_by(ottaID) %>% 
           summarize_if(is.double, mean) %>% 
           `rownames<-`(NULL)
  ) %>% 
  map(column_to_rownames, "ottaID")

comps4_A <- tibble(
  `CS3-Non_vs_CS4-Non` = c("CS3-Non", "CS4-Non"),
  `CS3-Non_vs_CS4-NormA` = c("CS3-Non", "CS4-NormA")
)

metrics_pools4_A <- comps4_A %>%
  imap_dfr(~ {
    pmap_dfr(counts4_A[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.001))) %>%
  ungroup()

p_pools4_A <- ggplot(metrics_pools4_A, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 100, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS4 Set A Chaining Concordance Measure Distributions",
       subtitle = cs345_subtitle) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_pools4_A)
```

```{r cs-chain-cs5-cs4-B, fig.cap='CS4 and CS5 using Set B Concordance Measure Distributions'}
cs45_norm <- cs4_norm_counts %>%
  gather(FileName, exp, -1:-3) %>% 
  inner_join(cs45_overlap, by = c("FileName" = "File.Name.CS4")) %>% 
  filter(ottaID %in% cs345_common_samples) %>% 
  mutate(Name = factor(Name, levels = cs345_common_genes)) %>%
  select(ottaID, Name, exp) %>% 
  group_by(ottaID, Name) %>%
  summarize_if(is.double, mean) %>% 
  ungroup() %>% 
  spread(Name, exp)

counts45_B <-
  list(cs45_norm, cs5_norm_counts, cs5_norm_B) %>% 
  set_names(c("CS4-Non", "CS5-Non", "CS5-NormB")) %>% 
  map_at(-1, ~ gather(., File.Name.CS5, exp, -Name) %>% 
           spread(Name, exp) %>% 
           inner_join(cs45_overlap, by = "File.Name.CS5") %>% 
           select(-matches("File.Name")) %>% 
           group_by(ottaID) %>% 
           summarize_if(is.double, mean) %>% 
           `rownames<-`(NULL)
  ) %>%
  map(column_to_rownames, "ottaID")

comps45_B <- tibble(
  `CS4-Non_vs_CS5-Non` = c("CS4-Non", "CS5-Non"),
  `CS4-Non_vs_CS5-NormB` = c("CS4-Non", "CS5-NormB")
)

metrics_pools45_B <- comps45_B %>%
  imap_dfr(~ {
    pmap_dfr(counts45_B[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.001))) %>%
  ungroup()

p_pools45_B <- ggplot(metrics_pools45_B, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS4 and CS5 using Set B Concordance Measure Distributions",
       subtitle = cs345_subtitle) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_pools45_B)
```

#### CS3, CS4, CS5 using Set C/A

```{r codeset-chaining-cs345-setCA}
## Normalize CS5 to CS4 using Set C pools
# CS4 Set B pools weights
cs4_weightsC <- paste0("Pool ?", c(4:5, 7:8)) %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(cs4_poolsC), ignore.case = TRUE)))

# Weighted mean gene expression for CS5 pools (using CS4 pools weights)
cs5_poolsC_mgx <- cs4_weightsC %>%
  imap_dfc(~ .x * rowMeans(select(cs5_poolsC, matches(.y, ignore.case = TRUE)))) %>%
  transmute(Name = cs5_poolsC[["Name"]], cs5_exp = rowSums(., na.rm = TRUE))

# Mean gene expression for CS4 reference pools
cs4_poolsC_mgx <-
  enframe(rowMeans(cs4_poolsC), name = "Name", value = "cs4_exp")

# Extract cs5 norm counts (not pools)
cs5_norm_counts <- cs5_dat %>%
  select(-one_of("Code.Class", "Accession", names(cs5_pools)[-1])) %>% 
  mutate(Name = fct_inorder(Name))

# Normalize each gene by adding batch effect (diff in mean gx)
cs5_norm_C <-
  inner_join(cs5_poolsC_mgx, cs4_poolsC_mgx, by = "Name") %>%
  transmute(Name, be = cs4_exp - cs5_exp) %>%
  inner_join(cs5_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-2) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(FileName, exp) %>% 
  select(all_of(names(cs5_norm_counts)))

## Normalize cs5_norm_C to CS3 using CS4 Set A pools as if originally run in CS4
# Locked down reference pools weights
cs3_weights <- c("Pool ?1.*", "Pool ?2.*", "Pool ?3.*") %>%
  set_names() %>%
  map_dbl(~ mean(grepl(., names(ref_pools), ignore.case = TRUE)))

# Weighted mean gene expression for CS4 pools (using CS3 pools weights)
cs4_poolsA_mgx <- cs3_weights %>%
  imap_dfc(~ .x * rowMeans(select(cs4_poolsA, matches(.y)))) %>%
  transmute(Name = cs4_poolsA[["Name"]], cs4_exp = rowSums(.))

# Mean gene expression for CS3 reference pools
cs3_pools_mgx <-
  enframe(rowMeans(ref_pools), name = "Name", value = "cs3_exp")

# Normalize each gene by adding batch effect (diff in mean gx)
cs5_norm_A <-
  inner_join(cs4_poolsA_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs4_exp) %>%
  inner_join(cs5_norm_C, by = "Name") %>%
  gather(FileName, exp, -1:-2) %>%
  transmute(Name = factor(Name, levels = cs5_norm_C$Name),
            FileName, exp = be + exp) %>%
  spread(FileName, exp) %>% 
  select(all_of(names(cs5_norm_counts)))

## Normalize CS4 to CS3 using Set A Pools
# Normalize each gene by adding batch effect (diff in mean gx)
cs4_norm_A <- 
  inner_join(cs4_poolsA_mgx, cs3_pools_mgx, by = "Name") %>%
  transmute(Name, be = cs3_exp - cs4_exp) %>%
  inner_join(cs4_norm_counts, by = "Name") %>%
  gather(FileName, exp, -1:-4) %>%
  transmute(Name = fct_inorder(Name), FileName, exp = be + exp) %>%
  spread(Name, exp)
```

```{r cs-chain-cs5-setCA, fig.cap='CS5 Set C/A Chaining Concordance  Measure Distributions', fig.height=6}
cs35_norm <- cs3_norm_full %>%
  select(-one_of(names(ref_pools))) %>%
  gather(FileName, exp, -1:-3) %>%
  mutate(FileName = gsub("^X", "", FileName)) %>%
  inner_join(hist_all, by = "FileName") %>% 
  filter(Name %in% cs5_norm_counts$Name,
         ottaID %in% cs345_common_samples) %>% 
  mutate(Name = factor(Name, levels = levels(cs5_norm_counts$Name))) %>% 
  select(Name, ottaID, exp) %>% 
  group_by(Name, ottaID) %>%
  summarize(exp = mean(exp)) %>%
  ungroup() %>%
  spread(Name, exp)

counts5_CA <-
  list(cs35_norm, cs5_norm_counts, cs5_norm_C, cs5_norm_A) %>%
  set_names(c("CS3-Non", "CS5-Non", "CS5-NormC", "CS5-NormA")) %>% 
  map_at(-1, ~ gather(., File.Name.CS5, exp, -Name) %>% 
           spread(Name, exp) %>% 
           inner_join(cs45_overlap, by = "File.Name.CS5") %>% 
           select(-matches("File.Name")) %>% 
           group_by(ottaID) %>% 
           summarize_if(is.double, mean) %>% 
           `rownames<-`(NULL)
  ) %>% 
  # map_at(-1, ~ gather(., ottaID, exp, -Name) %>%
  #          spread(Name, exp) %>%
  #          semi_join(cs35_norm, by = "ottaID")) %>% 
  map(column_to_rownames, "ottaID")

comps5_CA <- tibble(
  `CS3-Non_vs_CS5-Non` = c("CS3-Non", "CS5-Non"),
  `CS3-Non_vs_CS5-NormC` = c("CS3-Non", "CS5-NormC"),
  `CS3-Non_vs_CS5-NormA` = c("CS3-Non", "CS5-NormA"),
)

metrics_pools5_CA <- comps5_CA %>%
  imap_dfr(~ {
    pmap_dfr(counts5_CA[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  mutate(Sites = fct_inorder(Sites)) %>% 
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.001))) %>%
  ungroup()

p_pools5_CA <- ggplot(metrics_pools5_CA, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS5 Set C/A Chaining Concordance Measure Distributions",
       subtitle = cs345_subtitle) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_pools5_CA)
```

```{r cs-chain-cs5-cs4-C, fig.cap='CS4 and CS5 using Set C Concordance Measure Distributions'}
counts45_C <-
  list(cs45_norm, cs5_norm_counts, cs5_norm_C) %>% 
  set_names(c("CS4-Non", "CS5-Non", "CS5-NormC")) %>% 
  map_at(-1, ~ gather(., File.Name.CS5, exp, -Name) %>% 
           spread(Name, exp) %>% 
           inner_join(cs45_overlap, by = "File.Name.CS5") %>% 
           select(-matches("File.Name")) %>% 
           group_by(ottaID) %>% 
           summarize_if(is.double, mean) %>% 
           `rownames<-`(NULL)
  ) %>%
  map(column_to_rownames, "ottaID")

comps45_C <- tibble(
  `CS4-Non_vs_CS5-Non` = c("CS4-Non", "CS5-Non"),
  `CS4-Non_vs_CS5-NormC` = c("CS4-Non", "CS5-NormC")
)

metrics_pools45_C <- comps45_C %>%
  imap_dfr(~ {
    pmap_dfr(counts45_C[.x], ~ cor_stats(.x, .y)) %>% mutate(Sites = .y)
  }) %>%
  gather(key = "Metric", value = "Expression", -Sites) %>%
  group_by(Sites, Metric) %>%
  mutate(Median = paste0("Median = ", scales::number(median(Expression), accuracy = 0.001))) %>%
  ungroup()

p_pools45_C <- ggplot(metrics_pools45_C, aes(Expression)) +
  geom_histogram(bins = 30, fill = "blue") +
  geom_text(aes(x = 0, y = 40, label = Median),
            hjust = 0,
            vjust = 1,
            check_overlap = TRUE) +
  facet_grid(rows = vars(Sites), cols = vars(Metric), scales = "free_x") +
  labs(y = "Count",
       title = "CS4 and CS5 using Set C Concordance Measure Distributions",
       subtitle = cs345_subtitle) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
print(p_pools45_C)
```

## Common Sample Distributions

```{r common-dist-all}
common_dist_all <- hist %>% 
  filter(FileName %in% c(
    cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName
  )) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(common_dist_all, caption = "All Common Samples Histotype Distribution")
```

```{r common-dist-distinct}
common_dist_distinct <- hist %>% 
  filter(FileName %in% c(
    cs1_clean$FileName, cs2_clean$FileName, cs3_clean$FileName
  )) %>% 
  distinct(ottaID, CodeSet, revHist) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(common_dist_distinct, caption = "Distinct Common Samples Histotype Distribution")
```

```{r common-cs2-cs3-dist-distinct}
common_cs2_cs3_dist_distinct <- hist %>%
  filter(ottaID %in% c(rownames(cs2_common_non),
                       rownames(cs3_common_non))) %>%
  distinct(ottaID, CodeSet, revHist) %>%
  count(CodeSet, revHist) %>%
  pivot_wider(names_from = "CodeSet", values_from = "n") %>%
  select(-CS1)
knitr::kable(common_cs2_cs3_dist_distinct, caption = "Distinct Common CS2 and CS3 Samples Histotype Distribution")
```

```{r common-dist-sites}
common_dist_sites <- hist %>%
  filter(
    FileName %in% c(
      cs3_clean_van$FileName,
      cs3_clean_aoc$FileName,
      cs3_clean_usc$FileName
    )
  ) %>%
  count(site, revHist) %>%
  pivot_wider(names_from = "site", values_from = "n")
knitr::kable(common_dist_sites, caption = "Common Samples Across Sites Histotype Distribution")
```

```{r common-dist-sites-distinct}
common_dist_sites_distinct <- hist %>%
  filter(
    FileName %in% c(
      cs3_clean_van$FileName,
      cs3_clean_aoc$FileName,
      cs3_clean_usc$FileName
    )
  ) %>%
  distinct(ottaID, site, revHist) %>% 
  count(site, revHist) %>%
  pivot_wider(names_from = "site", values_from = "n")
knitr::kable(common_dist_sites_distinct, caption = "Distinct Common Samples Across Sites Histotype Distribution")
```

```{r cs345-overlap}
# CS3/CS4/CS5 overlap 72 (2 duplicates)
cs345_overlap <- 
  inner_join(hist_all, cs45_overlap, by = "ottaID") %>%
  filter(CodeSet == "CS3") %>%
  select(ottaID, CS3 = FileName, CS4 = File.Name.CS4, CS5 = File.Name.CS5, revHist) %>%
  pivot_longer(names_to = "CodeSet", values_to = "File.Name", 2:4) %>% 
  distinct(ottaID, CodeSet, revHist) %>% 
  count(CodeSet, revHist) %>% 
  pivot_wider(names_from = "CodeSet", values_from = "n")
knitr::kable(cs345_overlap, caption = "CS3/CS4/CS5 Common Samples Histotype Distribution")
```

```{r cs345-pools}
cs3_pool_counts <- paste0("Pool", 1:3) %>%
  set_names() %>%
  map_df(~ sum(grepl(., names(ref_pools), ignore.case = TRUE)))

cs4_pools_names <- names(cs4_pools) %>% 
  str_replace_all(c("A" = "1", "B" = "2", "C" = "3")) %>% 
  str_remove_all("\\.(x|y)| ")
cs4_pool_counts <- paste0("^Pool", 1:11, "$") %>% 
  set_names() %>%
  map_df(~ sum(grepl(., cs4_pools_names, ignore.case = TRUE))) %>% 
  rename_all(~ gsub("\\^|\\$", "", .))

cs5_pools_names <- names(cs5_pools) %>% 
   str_remove_all("\\.(x|y)| ")
cs5_pool_counts <- paste0("^Pool", 1:11, "$") %>%
  set_names() %>%
  map_df(~ sum(grepl(., cs5_pools_names, ignore.case = TRUE))) %>% 
  rename_all(~ gsub("\\^|\\$", "", .))

cs345_pools <- 
  bind_rows(cs3_pool_counts, cs4_pool_counts, cs5_pool_counts) %>% 
  add_column(CodeSet = c("CS3", "CS4", "CS5"), .before = 1) %>% 
  pivot_longer(cols = -CodeSet, names_to = "Pool", values_to = "Samples") %>% 
  pivot_wider(names_from = "CodeSet", values_from = "Samples")

knitr::kable(cs345_pools, caption = "CS3/CS4/CS5 Pools Distribution")
```
