# Results

```{r setup-04}
# Load packages and data
library(dplyr)
library(purrr)
library(tibble)
library(tidyr)
library(ggplot2)
library(forcats)
library(knitr)
library(kableExtra)
library(RankAggreg)
library(splendid)
library(magrittr)
library(DT)
library(plotly)
library(here)
source(here("validation/cs_process_cohorts.R"))
source(here("src/funs.R"))
ivst <- readRDS(here("data/iv_summary_train.rds"))
ivsts1 <- readRDS(here("data/iv_summary_train_step1.rds"))
ivsts2 <- readRDS(here("data/iv_summary_train_step2.rds"))
ivs1 <- readRDS(here("data/iv_summary_cs1_all.rds"))
ivs2 <- readRDS(here("data/iv_summary_cs2_all.rds"))
ivs2s <- readRDS(here("data/iv_summary_two_step.rds"))
ivsseq <- readRDS(here("data/iv_summary_seq.rds"))
train_data <- readRDS(here("data/train_data.rds"))
coefmat <- readRDS(here("data/coefmat.rds"))
geneseq <- readRDS(here("data/merge_eval_seq.rds"))
gene2s <- readRDS(here("data/merge_eval_two_step.rds"))
# ranked_vi_seq <- readRDS(here("data/ranked_vi_seq.rds"))
# ranked_vi_2s <- readRDS(here("data/ranked_vi_two_step.rds"))

all_metrics_train <- readRDS(here("data/all_metrics_train.rds"))
all_metrics_seq <- readRDS(here("data/all_metrics_seq.rds"))
all_metrics_two_step <- readRDS(here("data/all_metrics_two_step.rds"))

gene_opt_all_metrics_seq <-
  readRDS(here("data/gene_opt_all_metrics_seq.rds"))
gene_opt_all_metrics_two_step <- 
  readRDS(here("data/gene_opt_all_metrics_two_step.rds"))

all_vi_seq <- readRDS(here("data/all_vi_seq.rds"))
all_vi_two_step <- readRDS(here("data/all_vi_two_step.rds"))
```

```{r ivs-combine}
ivst <- ivst %>% mutate(sampling = fct_inorder(sampling))
ivsts1 <- ivsts1 %>% mutate(sampling = fct_inorder(sampling))
ivsts2 <- ivsts2 %>% mutate(sampling = fct_inorder(sampling))
ivs1 <- ivs1 %>% mutate(sampling = fct_inorder(sampling))
ivs2 <- ivs2 %>% mutate(sampling = fct_inorder(sampling))
ivs <- bind_rows(ivst, ivs1, ivs2) %>%
  mutate(dataset = factor(
    dataset,
    levels = c("train", "cs1_all", "cs2_all"),
    labels = c("Training", "CS1", "CS2")
  ),
  sampling = fct_inorder(sampling))
```

We show internal validation summaries for the combined classifier training set, as well as the CS1 and CS2 sets with duplicates included. The F1-scores, kappa, and G-mean are the measures of interest. Algorithms are sorted by descending value based on the overallaccuracy of the training set. The point ranges show the median, 5th and 95th percentiles, coloured by subsampling methods.

## Training Set

### Accuracy

```{r train-accuracy, fig.cap='Training Set Accuracy'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "accuracy"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Accuracy",
       title = "Cross-Validated Training Set Overall Accuracy")
print(p)
```

```{r train-accuracy-table}
overall_accuracy_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "accuracy") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_accuracy_train,
      caption = "Cross-Validated Training Set Overall Accuracy",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-accuracy-class, fig.cap='Training Set Class-Specific Accuracy', fig.width=8, fig.height=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "accuracy"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Accuracy",
       title = "Cross-Validated Training Set Class-Specific Accuracy")
print(p)
```

```{r train-accuracy-class-table}
class_accuracy_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "accuracy") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_accuracy_train,
      caption = "Cross-Validated Training Set Class-Specific Accuracy",
      escape = FALSE) %>%
  kable_styling()
```

### F1-Score

```{r train-f1, fig.cap='Training Set F1-Score'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "f_meas"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "F1-Score",
       title = "Cross-Validated Training Set Overall F1-Score")
print(p)
```

```{r train-f1-table}
overall_f1_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "f_meas") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_f1_train,
      caption = "Cross-Validated Training Set Overall F1-Score",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-f1-class, fig.cap='Training Set Class-Specific F1-Score', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "f_meas"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "F1-Score",
       title = "Cross-Validated Training Set Class-Specific F1-Score")
print(p)
```

```{r train-f1-class-table}
class_f1_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "f_meas") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_f1_train,
      caption = "Cross-Validated Training Set Class-Specific F1-Score",
      escape = FALSE) %>%
  kable_styling()
```

### Kappa

```{r train-kappa, fig.cap='Training Set Kappa'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "kap"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Overall Kappa")
print(p)
```

```{r train-kappa-table}
overall_kappa_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "kap") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_kappa_train,
      caption = "Cross-Validated Training Set Overall Kappa",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-kappa-class, fig.cap='Training Set Class-Specific Kappa', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "kap"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Class-Specific Kappa")
print(p)
```

```{r train-kappa-class-table}
class_kappa_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "kap") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_kappa_train,
      caption = "Cross-Validated Training Set Class-Specific Kappa",
      escape = FALSE) %>%
  kable_styling()
```

### G-mean

```{r train-gmean, fig.cap='Training Set G-mean'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "gmean"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "G-mean",
       title = "Cross-Validated Training Set Overall G-mean")
print(p)
```

```{r train-gmean-table}
overall_gmean_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "gmean") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_gmean_train,
      caption = "Cross-Validated Training Set Overall G-mean",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-gmean-class, fig.cap='Training Set Class-Specific G-mean', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "gmean"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Class-Specific G-mean")
print(p)
```

```{r train-gmean-class-table}
class_gmean_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "gmean") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_gmean_train,
      caption = "Cross-Validated Training Set Class-Specific G-mean",
      escape = FALSE) %>%
  kable_styling()
```

<!-- ## Two-Step Training Set -->

<!-- ### Accuracy -->

<!-- ```{r train-step1-accuracy, fig.cap='Training Set Step 1 Accuracy'} -->
<!-- ivsts1_accuracy <- ivsts1 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts1_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts1_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy, fig.cap='Training Set Step 2 Accuracy'} -->
<!-- ivsts2_accuracy <- ivsts2 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts2_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts2_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-table} -->
<!-- ivsts1_accuracy_table <- ivsts1_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_table, -->
<!--       caption = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-table} -->
<!-- ivsts2_accuracy_table <- ivsts2_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_table, -->
<!--       caption = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class, fig.cap='Training Set Step 1 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts1_accuracy_class <- ivsts1 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class, fig.cap='Training Set Step 2 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts2_accuracy_class <- ivsts2 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class-table} -->
<!-- ivsts1_accuracy_class_table <- ivsts1_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class-table} -->
<!-- ivsts2_accuracy_class_table <- ivsts2_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r train-step1-f1, fig.cap='Training Set Step 1 F1-Score'} -->
<!-- ivsts1_f1 <- ivsts1 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1, fig.cap='Training Set Step 2 F1-Score'} -->
<!-- ivsts2_f1 <- ivsts2 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-table} -->
<!-- ivsts1_f1_table <- ivsts1_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_f1_table, -->
<!--       caption = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-f1-table} -->
<!-- ivsts2_f1_table <- ivsts2_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_f1_table, -->
<!--       caption = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class, fig.cap='Training Set Step 1 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts1_f1_class <- ivsts1 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class, fig.cap='Training Set Step 2 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts2_f1_class <- ivsts2 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class-table} -->
<!-- ivsts1_f1_class_table <- ivsts1_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts1_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class-table} -->
<!-- ivsts2_f1_class_table <- ivsts2_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts2_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r train-step1-kappa, fig.cap='Training Set Step 1 Kappa'} -->
<!-- ivsts1_kappa <- ivsts1 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa, fig.cap='Training Set Step 2 Kappa'} -->
<!-- ivsts2_kappa <- ivsts2 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-table} -->
<!-- ivsts1_kappa_table <- ivsts1_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_table, -->
<!--       caption = "Training Set Step 1 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-table} -->
<!-- ivsts2_kappa_table <- ivsts2_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_table, -->
<!--       caption = "Training Set Step 2 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class, fig.cap='Training Set Step 1 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts1_kappa_class <- ivsts1 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class, fig.cap='Training Set Step 2 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts2_kappa_class <- ivsts2 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class-table} -->
<!-- ivsts1_kappa_class_table <- ivsts1_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class-table} -->
<!-- ivsts2_kappa_class_table <- ivsts2_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r train-step1-gmean, fig.cap='Training Set Step 1 G-mean'} -->
<!-- ivsts1_gmean <- ivsts1 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean, fig.cap='Training Set Step 2 G-mean'} -->
<!-- ivsts2_gmean <- ivsts2 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-table} -->
<!-- ivsts1_gmean_table <- ivsts1_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_table, -->
<!--       caption = "Training Set Step 1 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-table} -->
<!-- ivsts2_gmean_table <- ivsts2_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_table, -->
<!--       caption = "Training Set Step 2 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class, fig.cap='Training Set Step 1 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts1_gmean_class <- ivsts1 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-class, fig.cap='Training Set Step 2 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts2_gmean_class <- ivsts2 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class-table} -->
<!-- ivsts1_gmean_class_table <- ivsts1_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->







<!-- ```{r train-step2-gmean-class-table} -->
<!-- ivsts2_gmean_class_table <- ivsts2_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## CS1 Set -->

<!-- ### Accuracy -->

<!-- ```{r cs1-accuracy, fig.cap='CS1 Set Accuracy'} -->
<!-- ivs1_accuracy <- ivs1 %>% -->
<!--   filter(measure == "accuracy") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-table} -->
<!-- ivs1_accuracy_table <- ivs1_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_accuracy_table, -->
<!--       caption = "CS1 Set Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-class, fig.cap='CS1 Set Class-Specific Accuracy', fig.width=8} -->
<!-- ivs1_accuracy_class <- ivs1 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-class-table} -->
<!-- ivs1_accuracy_class_table <- ivs1_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_accuracy_class_table, -->
<!--       caption = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r cs1-f1, fig.cap='CS1 Set F1-Score'} -->
<!-- ivs1_f1 <- ivs1 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-f1-table} -->
<!-- ivs1_f1_table <- ivs1_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_f1_table, -->
<!--       caption = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r cs1-f1-class, fig.cap='CS1 Set Class-Specific F1-Score', fig.width=8} -->
<!-- ivs1_f1_class <- ivs1 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-f1-class-table} -->
<!-- ivs1_f1_class_table <- ivs1_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_f1_class_table, -->
<!--       caption = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r cs1-kappa, fig.cap='CS1 Set Kappa'} -->
<!-- ivs1_kappa <- ivs1 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-kappa-table} -->
<!-- ivs1_kappa_table <- ivs1_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_kappa_table, -->
<!--       caption = "CS1 Set Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-kappa-class, fig.cap='CS1 Set Class-Specific Kappa', fig.width=8} -->
<!-- ivs1_kappa_class <- ivs1 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-kappa-class-table} -->
<!-- ivs1_kappa_class_table <- ivs1_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_kappa_class_table, -->
<!--       caption = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r cs1-gmean, fig.cap='CS1 Set G-mean'} -->
<!-- ivs1_gmean <- ivs1 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-gmean-table} -->
<!-- ivs1_gmean_table <- ivs1_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_gmean_table, -->
<!--       caption = "CS1 Set G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-gmean-class, fig.cap='CS1 Set Class-Specific G-mean', fig.width=8} -->
<!-- ivs1_gmean_class <- ivs1 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-gmean-class-table} -->
<!-- ivs1_gmean_class_table <- ivs1_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_gmean_class_table, -->
<!--       caption = "CS1 Set Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## CS2 Set -->

<!-- ### Accuracy -->

<!-- ```{r cs2-accuracy, fig.cap='CS2 Set Accuracy'} -->
<!-- ivs2_accuracy <- ivs2 %>% -->
<!--   filter(measure == "accuracy") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-table} -->
<!-- ivs2_accuracy_table <- ivs2_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_accuracy_table, -->
<!--       caption = "CS2 Set Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-class, fig.cap='CS2 Set Class-Specific Accuracy', fig.width=8} -->
<!-- ivs2_accuracy_class <- ivs2 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-class-table} -->
<!-- ivs2_accuracy_class_table <- ivs2_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_accuracy_class_table, -->
<!--       caption = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r cs2-f1, fig.cap='CS2 Set F1-Score'} -->
<!-- ivs2_f1 <- ivs2 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-f1-table} -->
<!-- ivs2_f1_table <- ivs2_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_f1_table, -->
<!--       caption = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r cs2-f1-class, fig.cap='CS2 Set Class-Specific F1-Score', fig.width=8} -->
<!-- ivs2_f1_class <- ivs2 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-f1-class-table} -->
<!-- ivs2_f1_class_table <- ivs2_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_f1_class_table, -->
<!--       caption = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r cs2-kappa, fig.cap='CS2 Set Kappa'} -->
<!-- ivs2_kappa <- ivs2 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-kappa-table} -->
<!-- ivs2_kappa_table <- ivs2_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_kappa_table, -->
<!--       caption = "CS2 Set Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-kappa-class, fig.cap='CS2 Set Class-Specific Kappa', fig.width=8} -->
<!-- ivs2_kappa_class <- ivs2 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-kappa-class-table} -->
<!-- ivs2_kappa_class_table <- ivs2_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_kappa_class_table, -->
<!--       caption = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r cs2-gmean, fig.cap='CS2 Set G-mean'} -->
<!-- ivs2_gmean <- ivs2 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-gmean-table} -->
<!-- ivs2_gmean_table <- ivs2_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_gmean_table, -->
<!--       caption = "CS2 Set G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-gmean-class, fig.cap='CS2 Set Class-Specific G-mean', fig.width=8} -->
<!-- ivs2_gmean_class <- ivs2 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-gmean-class-table} -->
<!-- ivs2_gmean_class_table <- ivs2_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_gmean_class_table, -->
<!--       caption = "CS2 Set Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## SMOTE Kappa Summary -->

<!-- ```{r smote-kappa, fig.cap='SMOTE Kappa by Algorithm and Dataset'} -->
<!-- ivs_smote_kappa <- ivs %>% -->
<!--   filter(sampling == "smote", measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- -->
<!--   ggplot(ivs_smote_kappa, aes(x = algorithm, y = percentile_50, color = dataset)) + -->
<!--   geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95), -->
<!--                   position = position_dodge(width = 0.4)) + -->

<!--   theme_bw() + -->
<!--   theme(plot.title = element_text(face = "bold")) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   labs( -->
<!--     x = "Algorithm", -->
<!--     y = "Kappa", -->
<!--     color = "Dataset", -->
<!--     title = "SMOTE Kappa by Algorithm and Dataset" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r smote-kappa-table} -->
<!-- ivs_smote_kappa_table <- ivs_smote_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = dataset, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs_smote_kappa_table, -->
<!--       caption = "SMOTE Kappa by Algorithm and Dataset", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r smote-kappa-class, fig.cap='SMOTE Class-Specific Kappa by Algorithm and Dataset', fig.width=8} -->
<!-- ivs_smote_kappa_class <- ivs %>% -->
<!--   filter(sampling == "smote", grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- -->
<!--   ggplot(ivs_smote_kappa_class, aes(x = algorithm, y = percentile_50, color = dataset)) + -->
<!--   geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95), -->
<!--                   position = position_dodge(width = 0.4)) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   theme_bw() + -->
<!--   theme(plot.title = element_text(face = "bold")) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     x = "Algorithm", -->
<!--     y = "Kappa", -->
<!--     color = "Dataset", -->
<!--     title = "SMOTE Class-Specific Kappa by Algorithm and Dataset" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

## Gene Optimization

### Overlap with Other Sets

```{r overlap-protype}
overlap_PrOTYPE <- intersect(names(train_data), cs5$Name)
```

There are `r length(overlap_PrOTYPE)` genes out of the `r ncol(train_data)` common classifier set that overlap with the PrOTYPE classifier: `r paste(overlap_PrOTYPE, collapse = ", ")`

```{r overlap-SPOT}
overlap_SPOT <- intersect(names(train_data), coefmat[["Symbol"]])
```

There are `r length(overlap_SPOT)` genes out of the `r ncol(train_data)` classifier set that overlap with the SPOT signature: `r paste(overlap_SPOT, collapse = ", ")`.

### Optimal Gene Set

```{r overlap-all}
overlap_all <- unique(c(overlap_PrOTYPE, overlap_SPOT))
candidates <- setdiff(names(train_data), overlap_all)
```

There are `r length(overlap_all)` unique genes from the combined PrOTYPE and SPOT lists that we want to use for the final classifier. We then incrementally add genes from the remaining `r length(candidates)` candidates based on variable importance scores to this list and recalculate performance metrics. The number of genes at which the performance starts to plateau may indicate an optimal gene set for us to carry forward for a particular model.

Variable importance is calculated using either a model-based approach if it is available, or a SHAP-based VI score otherwise (e.g. for SVM). For the sequential and two-step classifiers, we calculate overall VI scores by aggregating the base classifier VI scores using rank aggregation.

```{r gene-seq, fig.height=8, fig.cap='Gene Optimization for Sequential Classifier'}
gene_seq_names <- all_vi_seq %>% 
  select(Name = Variable) %>% 
  rowid_to_column("Genes")

dat_gene_seq <- gene_opt_all_metrics_seq %>% 
  filter(.metric == "f_meas") %>% 
  mutate(
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Workflow: ",
      wflow,
      ", Measure: ",
      .metric)
  ) %>% 
  inner_join(gene_seq_names, by = "Genes")

p_gene_seq <-
  ggplot(dat_gene_seq, aes(x = Genes, y = .estimate, text = Name)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "F1-Score",
       title = "Gene Optimziation for Sequential Classifier")
ggplotly(p_gene_seq)

n_genes_seq <- 28
genes_add_seq <- gene_seq_names %>%
  slice_min(order_by = Genes, n = n_genes_seq) %>% 
  pull(Name)
opt_genes_seq <- c(overlap_all, genes_add_seq)
```

In the sequential classifier, we use the per-class median F1-scores pertaining to the histotype that had the best performance from each retraining, and sort them on number of genes added. For instance, in sequence 2, we look at the CCOC F1-scores because CCOC had the best performance from retraining after HGSC was removed.

We can observe that in sequence 3, the F1-score stabilizes at around 0.93 when we reach `r n_genes_seq` genes added, hence the optimal number of genes used will be n=28+34=62. The added genes are: `r str_flatten_comma(genes_add_seq, last = " and ")`.

```{r gene-2s, fig.cap='Gene Optimization for Two-Step Classifier'}
gene_2s_names <- all_vi_two_step %>% 
  select(Name = Variable) %>% 
  rowid_to_column("Genes")

dat_gene_2s <- gene_opt_all_metrics_two_step %>% 
  filter(.metric == "f_meas") %>% 
  mutate(
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Workflow: ",
      wflow,
      ", Measure: ",
      .metric)
  ) %>% 
  inner_join(gene_seq_names, by = "Genes")

p_gene_2s <-
  ggplot(dat_gene_2s, aes(x = Genes, y = .estimate, text = Name)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "F1-Score",
       title = "Gene Optimziation for Two-Step Classifier")
ggplotly(p_gene_2s)

n_genes_2s <- 31
genes_add_2s <- gene_2s_names %>%
  slice_min(order_by = Genes, n = n_genes_2s) %>% 
  pull(Name)
opt_genes_2s <- c(overlap_all, genes_add_2s)
```

Since the second step of the classifier fits a multinomial model, we use the macro F1-score as the measure to analyze gene entry. In the two-step classifier, we see that in Step 2, the F1-score stabilizes at around 0.88 when we reach `r n_genes_2s` added. The optimal number of genes used will be n=28+`r n_genes_2s`=52. The added genes are: `r str_flatten_comma(genes_add_2s, last = " and ")`.

## Rank Aggregation

```{r summary}
# IV summary from multinomial, 2-stage, and sequential algorithm
ivs_comb <- bind_rows(ivst, ivs2s, ivsseq)
ivs_comb_f1 <- ivs_comb %>% 
  filter(grepl("f1\\.", measure)) %>%
  transmute(
    model = ifelse(algorithm %in% c("seq", "two_step"),
                   algorithm,
                   paste(algorithm, sampling, sep = "-")),
    class = gsub("f1\\.", "", measure),
    median_f1 = percentile_50
  )

# Rank aggregation
f1_ranks <- ivs_comb_f1 %>% 
  group_by(class) %>% 
  mutate(rank = factor(row_number(-median_f1))) %>% 
  ungroup() %>% 
  select(-median_f1) %>% 
  arrange(rank) %>% 
  pivot_wider(names_from = "rank", values_from = "model") %>% 
  column_to_rownames("class") %>% 
  as.matrix()

f1_top <- splendid:::sink_output(RankAggreg(
  x = f1_ranks,
  k = ncol(f1_ranks),
  method = "GA",
  seed = 2022,
  verbose = FALSE
))

# F1-score summary
ivs_f1_summary <- ivs_comb_f1 %>% 
  pivot_wider(names_from = "class", values_from = "median_f1") %>% 
  mutate(across(where(is.numeric), round, digits = 3)) %>% 
  magrittr::extract(match(f1_top[["top.list"]], .$model), )

datatable(
  ivs_f1_summary,
  options = list(
    scrollX = TRUE,
    fixedColumns = TRUE,
    columnDefs = list(
      list(
        targets = 1,
        render = JS("$.fn.dataTable.render.ellipsis( 10 )")
      ),
      list(type = "natural", targets = 0)
    ),
    pageLength = 50
  ), 
  rownames = FALSE,
  caption = "F1-Score Summary by Model and Class",
  filter = "top",
  extensions = "FixedColumns",
  plugins = c("ellipsis", "natural")
)
```

The `r ncol(f1_ranks)` methods (algorithm-sampling combinations) are ordered in the table by their aggregated ranks using the Genetic Algorithm. We see that the best performing methods involve the 2-stage and sequential algorithms.

## Top 4 Model Summary

### Overall Metrics

```{r ivs-top4-overall, fig.cap='Top 4 Model Evaluation Metrics'}
models_top4 <- f1_top[["top.list"]][seq_len(4)]
ivs_comb_top4 <- ivs_comb %>% 
  mutate(model = ifelse(
    algorithm %in% c("seq", "two_step"),
    algorithm,
    paste(algorithm, sampling, sep = "-")
  ),
  .after = sampling) %>% 
  filter(
    algorithm %in% c("seq", "two_step") |
      model %in% c("adaboost-up", "rf-smote")
  )

ivs_top4_overall <- ivs_comb_top4 %>% 
  filter(measure %in% c("auc", "accuracy", "kappa", "macro_f1", "gmean")) %>% 
  mutate(model = fct_reorder(model, percentile_50, .desc = TRUE))

p <- 
  ggplot(ivs_top4_overall, aes(x = model, y = percentile_50, color = measure)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4),
                  fatten = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Model",
    y = "Measure",
    color = "Measure",
    title = "Top 4 Model Overall Evaluation Metrics"
  )
print(p)
```

### Per-Class Metrics

```{r ivs-top4-per-class, fig.cap='Top 4 Model Per-Class Evaluation Metrics'}
ivs_top4_per_class <- ivs_comb_top4 %>% 
  filter(grepl("\\.", measure)) %>%
  separate(measure, c("measure", "class")) %>% 
  filter(measure %in% c("accuracy", "kappa", "f1", "gmean")) %>% 
  mutate(model = fct_reorder(model, percentile_50, .desc = TRUE))

p <- 
  ggplot(ivs_top4_per_class, aes(x = model, y = percentile_50, color = measure)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4),
                  fatten = 1) +
  facet_wrap(vars(class), ncol = 2) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Model",
    y = "Measure",
    color = "Measure",
    title = "Top 4 Model Per-Class Evaluation Metrics"
  )
print(p)
```

```{r ivs-top4-per-class-f1, fig.cap='Top 4 Model Per-Class F1-Scores'}
ivs_top4_per_class_f1 <- ivs_comb_top4 %>% 
  filter(grepl("\\.", measure)) %>%
  separate(measure, c("measure", "class")) %>% 
  filter(measure %in% "f1") %>% 
  mutate(model = fct_reorder(model, percentile_50, .desc = TRUE))

p <- 
  ggplot(ivs_top4_per_class_f1, aes(x = class, y = percentile_50, color = model)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4),
                  fatten = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Class",
    y = "Measure",
    color = "Model",
    title = "Top 4 Model Per-Class F1-Score"
  )
print(p)
```

## Test Set Performance

Now we'd like to see how our best methods perform in the confirmation and validation sets. The class-specific F1-scores will be used.

The top 2 methods are:

- **sequential**: sequential algorithm with upsampling at every step. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using adaboost
  - CCOC vs. non-CCOC using random forest
  - ENOC vs. non-ENOC using ridge regression
  - MUC vs. LGSC using adaboost
- **two_step**: two-step algorithm with upsampling at both steps. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using adaboost
  - CCOC vs. ENOC vs. MUC vs. LGSC using random forest
  
We can test 2 additional methods by using either the full set of genes or the optimal set of genes for both of these methods.

```{r top-models}
# Two-step data
two_step_data <- readRDS(here("data", "two_step_data.rds"))
two_step_class <- readRDS(here("data", "two_step_class.rds"))
two_step_algs <- readRDS(here("data", "two_step_algs.rds"))

# Two-step full model
mod_two_step_full <-
  pmap(list(two_step_data, two_step_class, two_step_algs), ~ {
    classification(
      data = ..1,
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# Two-step optimal gene list model
mod_two_step_opt <- 
  pmap(list(two_step_data, two_step_class, two_step_algs), ~ {
    classification(
      data = ..1 %>% select(all_of(opt_genes_2s)),
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# sequential data
seq_data <- readRDS(here("data", "seq_data.rds"))
seq_class <- readRDS(here("data", "seq_class.rds"))
seq_algs <- readRDS(here("data", "seq_algs.rds"))

# Sequential full model
mod_seq_full <-
  pmap(list(seq_data, seq_class, seq_algs), ~ {
    classification(
      data = ..1,
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# Sequential optimal gene list model
mod_seq_opt <-
  pmap(list(seq_data, seq_class, seq_algs), ~ {
    classification(
      data = ..1 %>% select(all_of(opt_genes_seq)),
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })
```

### Confirmation Set

```{r confirmation-set}
# Load data
conf_class <- readRDS(here("data", "conf_class.rds"))
conf_data <- readRDS(here("data", "conf_data.rds"))

# Create step 1 and step 2 splits
## Full
conf_step1_data_full <- conf_data
conf_step1_data_opt <- conf_step1_data_full %>% 
  select(all_of(opt_genes_2s))
conf_step1_class <- factor(ifelse(conf_class == "HGSC", "HGSC", "non-HGSC"))

## Optimal
conf_step2_data_full <- conf_data[conf_step1_class != "HGSC", ]
conf_step2_data_opt <- conf_step2_data_full %>% 
  select(all_of(opt_genes_2s))
conf_step2_class <- factor(conf_class[conf_step1_class != "HGSC"])

# Predict and evaluate
## Full
conf_step1_pred_full <-
  prediction(mod_two_step_full[[1]],
             conf_step1_data_full,
             conf_step1_class)
conf_step1_eval_full <-
  evaluation(conf_step1_class, conf_step1_pred_full)

conf_step2_pred_full <-
  prediction(mod_two_step_full[[2]],
             conf_step2_data_full,
             conf_step2_class)
conf_step2_eval_full <-
  evaluation(conf_step2_class, conf_step2_pred_full)

## Optimal
conf_step1_pred_opt <-
  prediction(mod_two_step_opt[[1]],
             conf_step1_data_opt,
             conf_step1_class)
conf_step1_eval_opt <-
  evaluation(conf_step1_class, conf_step1_pred_opt)

conf_step2_pred_opt <-
  prediction(mod_two_step_opt[[2]],
             conf_step2_data_opt,
             conf_step2_class)
conf_step2_eval_opt <-
  evaluation(conf_step2_class, conf_step2_pred_opt)

# Combine evaluations from both steps
## Full
conf_2S_eval_full <-
  list(conf_step1_eval_full, conf_step2_eval_full) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("\\.(?!non)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  pivot_longer(
    cols = everything(),
    names_to = c("measure", "class"),
    names_sep = "\\.",
    values_to = "value"
  ) %>% 
  filter(measure %in% c("accuracy", "f1", "kappa", "gmean")) %>% 
  pivot_wider(
    id_cols = measure,
    names_from = "class",
    values_from = "value"
  ) %>% 
  add_column(method = "two_step_full", .before = 1)

## Optimal
conf_2S_eval_opt <-
  list(conf_step1_eval_opt, conf_step2_eval_opt) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("\\.(?!non)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  pivot_longer(
    cols = everything(),
    names_to = c("measure", "class"),
    names_sep = "\\.",
    values_to = "value"
  ) %>% 
  filter(measure %in% c("accuracy", "f1", "kappa", "gmean")) %>% 
  pivot_wider(
    id_cols = measure,
    names_from = "class",
    values_from = "value"
  ) %>% 
  add_column(method = "two_step_optimal", .before = 1)

# Create sequential splits
conf_df <- cbind(conf_data, class = conf_class)

seq_conf_ranks <- seq_class %>%
  map(unique) %>%
  map(~ purrr::discard(., .p = ~ . == "class_0")) %>%
  unlist() %>%
  accumulate(c) %>%
  head(-1)

seq_conf_class <- imap(seq_conf_ranks, ~ {
  cl <- conf_df %>%
    filter(!class %in% head(.x, -1)) %>%
    pull(class)
  if (.y != length(seq_conf_ranks)) {
    factor(ifelse(cl == tail(.x, 1), tail(.x, 1), "class_0"))
  } else {
    factor(cl)
  }
})

## Full
seq_conf_data_full <- map(seq_conf_ranks, ~ {
  conf_df %>%
    filter(!class %in% head(.x, -1)) %>%
    select(-class)
})

## Optimal
seq_conf_data_opt <- seq_conf_data_full %>% 
  map(~ .x %>% select(all_of(opt_genes_seq)))

# Predict and evaluate
## Full
conf_seq_eval_full <-
  pmap(list(mod_seq_full, seq_conf_data_full, seq_conf_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap( ~ .x[grepl("\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  pivot_longer(
    cols = everything(),
    names_to = c("measure", "class"),
    names_sep = "\\.",
    values_to = "value"
  ) %>% 
  filter(measure %in% c("accuracy", "f1", "kappa", "gmean")) %>% 
  pivot_wider(
    id_cols = measure,
    names_from = "class",
    values_from = "value"
  ) %>% 
  add_column(method = "sequential_full", .before = 1)

conf_seq_eval_opt <-
  pmap(list(mod_seq_opt, seq_conf_data_opt, seq_conf_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap( ~ .x[grepl("\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  pivot_longer(
    cols = everything(),
    names_to = c("measure", "class"),
    names_sep = "\\.",
    values_to = "value"
  ) %>% 
  filter(measure %in% c("accuracy", "f1", "kappa", "gmean")) %>% 
  pivot_wider(
    id_cols = measure,
    names_from = "class",
    values_from = "value"
  ) %>% 
  add_column(method = "sequential_optimal", .before = 1)
```

```{r conf-eval-per-class}
conf_eval_per_class <- bind_rows(conf_2S_eval_full,
                                 conf_2S_eval_opt,
                                 conf_seq_eval_full,
                                 conf_seq_eval_opt)

kable(conf_eval_per_class,
      caption = "Class-specific Evaluation Metrics on Confirmation Set Models",
      digits = 3) %>% 
  kable_styling() %>% 
  collapse_rows(columns = 1)
```

In the confirmation set, **sequential_full** and **sequential_optimal** are very similar. Both sequential algorithms have moderate improvement in LGSC and MUC classification. We will select the **sequential_optimal** model to test in the validation set.

```{r conf-eval-overall}
# Confirmation set overall predictions
conf_pred_overall <- data.frame(FileName = rownames(conf_data),
                                Truth = conf_class) %>%
  mutate(
    p_2s1_full = predict(mod_two_step_full[[1]], conf_data),
    p_2s2_full = predict(mod_two_step_full[[2]], conf_data),
    
    p_2s1_opt = predict(mod_two_step_opt[[1]], conf_step1_data_opt),
    p_2s2_opt = predict(mod_two_step_opt[[2]], conf_step1_data_opt),
    
    p_seq1_full = predict(mod_seq_full[[1]], conf_data),
    p_seq2_full = predict(mod_seq_full[[2]], conf_data),
    p_seq3_full = predict(mod_seq_full[[3]], as.matrix(conf_data), type = "class"),
    p_seq4_full = predict(mod_seq_full[[4]], conf_data),
    
    p_seq1_opt = predict(mod_seq_opt[[1]], seq_conf_data_opt[[1]]),
    p_seq2_opt = predict(mod_seq_opt[[2]], seq_conf_data_opt[[1]]),
    p_seq3_opt = predict(mod_seq_opt[[3]], as.matrix(seq_conf_data_opt[[1]]), type = "class"),
    p_seq4_opt = predict(mod_seq_opt[[4]], seq_conf_data_opt[[1]]),
    
    across(matches("p"), as.character),
    Prediction_two_step_full = ifelse(Truth == "HGSC" & p_2s1_full == "HGSC",
                                      "HGSC",
                                      p_2s2_full),
    Prediction_two_step_optimal = ifelse(Truth == "HGSC" & p_2s1_opt == "HGSC",
                                         "HGSC",
                                         p_2s2_opt),
    Prediction_sequential_full = case_when(
      Truth == "HGSC" & p_seq1_full == "HGSC" ~ "HGSC",
      Truth == "CCOC" & p_seq2_full == "CCOC" ~ "CCOC",
      Truth == "ENOC" & p_seq3_full == "ENOC" ~ "ENOC",
      .default = p_seq4_full
    ),
    Prediction_sequential_optimal = case_when(
      Truth == "HGSC" & p_seq1_opt == "HGSC" ~ "HGSC",
      Truth == "CCOC" & p_seq2_opt == "CCOC" ~ "CCOC",
      Truth == "ENOC" & p_seq3_opt == "ENOC" ~ "ENOC",
      .default = p_seq4_opt
    ), 
    across(c("Truth", matches("Prediction")), factor)
  ) %>%
  select(-starts_with("p", ignore.case = FALSE)) %>%
  pivot_longer(
    cols = matches("Prediction"),
    names_to = "method",
    names_prefix = "Prediction_",
    values_to = "Prediction"
  )

# Confimation set overall metrics
conf_eval_overall <- conf_pred_overall %>%
  group_by(method) %>%
  summarize(
    accuracy = yardstick::accuracy_vec(Truth, Prediction),
    kappa = yardstick::kap_vec(Truth, Prediction),
    f1 = yardstick::f_meas_vec(Truth, Prediction),
    gmean = splendid:::gmean(table(Prediction, Truth))
  )

kable(conf_eval_overall,
      caption = "Overall Evaluation Metrics on Confirmation Set Models",
      digits = 3) %>%
  kable_styling()
```

### Validation Set

```{r validation-set}
# Load data
val_class <- readRDS(here("data", "val_class.rds"))
val_data <- readRDS(here("data", "val_data.rds"))

# Create sequential splits
val_df <- cbind(val_data, class = val_class)

seq_val_ranks <- seq_class %>%
  map(unique) %>%
  map(~ purrr::discard(., .p = ~ . == "class_0")) %>%
  unlist() %>%
  accumulate(c) %>%
  head(-1)

seq_val_class <- imap(seq_val_ranks, ~ {
  cl <- val_df %>%
    filter(!class %in% head(.x, -1)) %>%
    pull(class)
  if (.y != length(seq_val_ranks)) {
    factor(ifelse(cl == tail(.x, 1), tail(.x, 1), "class_0"))
  } else {
    factor(cl)
  }
})

## Full
seq_val_data_full <- map(seq_val_ranks, ~ {
  val_df %>%
    filter(!class %in% head(.x, -1)) %>%
    select(-class)
})

## Optimal
seq_val_data_opt <- seq_val_data_full %>% 
  map(~ .x %>% select(all_of(opt_genes_seq)))
```

```{r val-eval-per-class}
val_eval_per_class <-
  pmap(list(mod_seq_opt, seq_val_data_opt, seq_val_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
   pivot_longer(
    cols = everything(),
    names_to = c("measure", "class"),
    names_sep = "\\.",
    values_to = "value"
  ) %>% 
  filter(measure %in% c("accuracy", "f1", "kappa", "gmean")) %>% 
  pivot_wider(
    id_cols = measure,
    names_from = "class",
    values_from = "value"
  ) %>% 
  add_column(method = "sequential_opt", .before = 1)

kable(val_eval_per_class,
      caption = "Class-specific Evaluation Metrics on Validation Set Model",
      digits = 3) %>% 
  kable_styling() %>% 
  collapse_rows(columns = 1)
```

Per-class F1-scores in the validation set are all above 0.9.

```{r val-eval-overall}
# Validation set overall predictions
val_pred_overall <- data.frame(FileName = rownames(conf_data),
                               Truth = conf_class) %>%
  mutate(
    p_seq1_opt = predict(mod_seq_opt[[1]], seq_conf_data_opt[[1]]),
    p_seq2_opt = predict(mod_seq_opt[[2]], seq_conf_data_opt[[1]]),
    p_seq3_opt = predict(mod_seq_opt[[3]], as.matrix(seq_conf_data_opt[[1]]), type = "class"),
    p_seq4_opt = predict(mod_seq_opt[[4]], seq_conf_data_opt[[1]]),
    
    across(matches("p"), as.character),
    Prediction_sequential_optimal = case_when(
      Truth == "HGSC" & p_seq1_opt == "HGSC" ~ "HGSC",
      Truth == "CCOC" & p_seq2_opt == "CCOC" ~ "CCOC",
      Truth == "ENOC" & p_seq3_opt == "ENOC" ~ "ENOC",
      .default = p_seq4_opt
    ), 
    across(c("Truth", matches("Prediction")), factor)
  ) %>%
  select(-starts_with("p", ignore.case = FALSE)) %>%
  pivot_longer(
    cols = matches("Prediction"),
    names_to = "method",
    names_prefix = "Prediction_",
    values_to = "Prediction"
  )

# Valiation set overall metrics
val_eval_overall <- val_pred_overall %>%
  group_by(method) %>%
  summarize(
    accuracy = yardstick::accuracy_vec(Truth, Prediction),
    kappa = yardstick::kap_vec(Truth, Prediction),
    f1 = yardstick::f_meas_vec(Truth, Prediction),
    gmean = splendid:::gmean(table(Prediction, Truth))
  )

kable(val_eval_overall,
      caption = "Overall valuation Metrics on Validation Set Model",
      digits = 3) %>% 
  kable_styling()
```
