# Results

```{r setup-04}
# Load packages and data
library(dplyr)
library(purrr)
library(tibble)
library(tidyr)
library(ggplot2)
library(forcats)
library(knitr)
library(kableExtra)
library(RankAggreg)
library(splendid)
library(magrittr)
library(DT)
library(plotly)
library(tidymodels)
library(here)
source(here("validation/cs_process_cohorts.R"))
source(here("src/funs.R"))

ivst <- readRDS(here("data/iv_summary_train.rds"))
ivsts1 <- readRDS(here("data/iv_summary_train_step1.rds"))
ivsts2 <- readRDS(here("data/iv_summary_train_step2.rds"))
ivs1 <- readRDS(here("data/iv_summary_cs1_all.rds"))
ivs2 <- readRDS(here("data/iv_summary_cs2_all.rds"))
ivs2s <- readRDS(here("data/iv_summary_two_step.rds"))
ivsseq <- readRDS(here("data/iv_summary_seq.rds"))
train_data <- readRDS(here("data/train_data.rds"))
coefmat <- readRDS(here("data/coefmat.rds"))
geneseq <- readRDS(here("data/merge_eval_seq.rds"))
gene2s <- readRDS(here("data/merge_eval_two_step.rds"))

all_metrics_train <- readRDS(here("data/all_metrics_train.rds"))

per_class_metrics_seq <-
  readRDS(here("data/per_class_metrics_seq.rds"))
per_class_metrics_two_step <-
  readRDS(here("data/per_class_metrics_two_step.rds"))


all_models_seq <- readRDS(here("data/all_models_seq.rds"))
all_models_two_step <- readRDS(here("data/all_models_two_step.rds"))

gene_opt_all_metrics_seq <-
  readRDS(here("data/gene_opt_all_metrics_seq.rds"))
gene_opt_all_metrics_two_step <- 
  readRDS(here("data/gene_opt_all_metrics_two_step.rds"))

all_vi_seq <- readRDS(here("data/all_vi_seq.rds"))
all_vi_two_step <- readRDS(here("data/all_vi_two_step.rds"))
```

```{r ivs-combine}
ivst <- ivst %>% mutate(sampling = fct_inorder(sampling))
ivsts1 <- ivsts1 %>% mutate(sampling = fct_inorder(sampling))
ivsts2 <- ivsts2 %>% mutate(sampling = fct_inorder(sampling))
ivs1 <- ivs1 %>% mutate(sampling = fct_inorder(sampling))
ivs2 <- ivs2 %>% mutate(sampling = fct_inorder(sampling))
ivs <- bind_rows(ivst, ivs1, ivs2) %>%
  mutate(dataset = factor(
    dataset,
    levels = c("train", "cs1_all", "cs2_all"),
    labels = c("Training", "CS1", "CS2")
  ),
  sampling = fct_inorder(sampling))
```

We show internal validation summaries for the combined classifier training set, as well as the CS1 and CS2 sets with duplicates included. The F1-scores, kappa, and G-mean are the measures of interest. Algorithms are sorted by descending value based on the overallaccuracy of the training set. The point ranges show the median, 5th and 95th percentiles, coloured by subsampling methods.

## Training Set

### Accuracy

```{r train-accuracy, fig.cap='Training Set Accuracy'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "accuracy"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Accuracy",
       title = "Cross-Validated Training Set Overall Accuracy")
print(p)
```

```{r train-accuracy-table}
overall_accuracy_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "accuracy") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_accuracy_train,
      caption = "Cross-Validated Training Set Overall Accuracy",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-accuracy-class, fig.cap='Training Set Class-Specific Accuracy', fig.width=8, fig.height=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "accuracy"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Accuracy",
       title = "Cross-Validated Training Set Class-Specific Accuracy")
print(p)
```

```{r train-accuracy-class-table}
class_accuracy_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "accuracy") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_accuracy_train,
      caption = "Cross-Validated Training Set Class-Specific Accuracy",
      escape = FALSE) %>%
  kable_styling()
```

### F1-Score

```{r train-f1, fig.cap='Training Set F1-Score'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "f_meas"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "F1-Score",
       title = "Cross-Validated Training Set Overall F1-Score")
print(p)
```

```{r train-f1-table}
overall_f1_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "f_meas") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_f1_train,
      caption = "Cross-Validated Training Set Overall F1-Score",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-f1-class, fig.cap='Training Set Class-Specific F1-Score', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "f_meas"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "F1-Score",
       title = "Cross-Validated Training Set Class-Specific F1-Score")
print(p)
```

```{r train-f1-class-table}
class_f1_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "f_meas") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_f1_train,
      caption = "Cross-Validated Training Set Class-Specific F1-Score",
      escape = FALSE) %>%
  kable_styling()
```

### Kappa

```{r train-kappa, fig.cap='Training Set Kappa'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "kap"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Overall Kappa")
print(p)
```

```{r train-kappa-table}
overall_kappa_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "kap") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_kappa_train,
      caption = "Cross-Validated Training Set Overall Kappa",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-kappa-class, fig.cap='Training Set Class-Specific Kappa', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "kap"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Class-Specific Kappa")
print(p)
```

```{r train-kappa-class-table}
class_kappa_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "kap") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_kappa_train,
      caption = "Cross-Validated Training Set Class-Specific Kappa",
      escape = FALSE) %>%
  kable_styling()
```

### G-mean

```{r train-gmean, fig.cap='Training Set G-mean'}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group == "Overall", .metric == "gmean"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE), y = .estimate)
) +
  geom_point() +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "G-mean",
       title = "Cross-Validated Training Set Overall G-mean")
print(p)
```

```{r train-gmean-table}
overall_gmean_train <-
  all_metrics_train %>% 
  filter(class_group == "Overall", .metric == "gmean") %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = samp,
              names_from = "alg",
              values_from = ".estimate")

kable(overall_gmean_train,
      caption = "Cross-Validated Training Set Overall G-mean",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-gmean-class, fig.cap='Training Set Class-Specific G-mean', fig.width=8}
p <- ggplot(
  all_metrics_train %>%
    filter(class_group != "Overall", .metric == "gmean"),
  aes(x = fct_reorder(wflow, .estimate, .desc = TRUE, .na_rm = FALSE), y = .estimate)
) +
  geom_point() +
  facet_wrap(~ class_group, ncol = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Workflow",
       y = "Kappa",
       title = "Cross-Validated Training Set Class-Specific G-mean")
print(p)
```

```{r train-gmean-class-table}
class_gmean_train <-
  all_metrics_train %>% 
  filter(class_group != "Overall", .metric == "gmean") %>% 
  rename(histotype = class_group) %>% 
  separate(wflow, into = c("samp", "alg"), remove = FALSE) %>%
  mutate(
    samp = factor(samp, levels = c("none", "down", "up", "smote", "hybrid")),
    .estimate = round(.estimate, digits = 3),
    .estimate = ifelse(
      .estimate == max(.estimate, na.rm = TRUE),
      cell_spec(.estimate, bold = TRUE),
      .estimate
    )
  ) %>% 
  arrange(samp) %>% 
  pivot_wider(id_cols = c(samp, histotype),
              names_from = "alg",
              values_from = ".estimate")

kable(class_gmean_train,
      caption = "Cross-Validated Training Set Class-Specific G-mean",
      escape = FALSE) %>%
  kable_styling()
```

<!-- ## Two-Step Training Set -->

<!-- ### Accuracy -->

<!-- ```{r train-step1-accuracy, fig.cap='Training Set Step 1 Accuracy'} -->
<!-- ivsts1_accuracy <- ivsts1 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts1_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts1_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy, fig.cap='Training Set Step 2 Accuracy'} -->
<!-- ivsts2_accuracy <- ivsts2 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts2_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts2_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-table} -->
<!-- ivsts1_accuracy_table <- ivsts1_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_table, -->
<!--       caption = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-table} -->
<!-- ivsts2_accuracy_table <- ivsts2_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_table, -->
<!--       caption = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class, fig.cap='Training Set Step 1 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts1_accuracy_class <- ivsts1 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class, fig.cap='Training Set Step 2 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts2_accuracy_class <- ivsts2 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class-table} -->
<!-- ivsts1_accuracy_class_table <- ivsts1_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class-table} -->
<!-- ivsts2_accuracy_class_table <- ivsts2_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r train-step1-f1, fig.cap='Training Set Step 1 F1-Score'} -->
<!-- ivsts1_f1 <- ivsts1 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1, fig.cap='Training Set Step 2 F1-Score'} -->
<!-- ivsts2_f1 <- ivsts2 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-table} -->
<!-- ivsts1_f1_table <- ivsts1_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_f1_table, -->
<!--       caption = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-f1-table} -->
<!-- ivsts2_f1_table <- ivsts2_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_f1_table, -->
<!--       caption = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class, fig.cap='Training Set Step 1 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts1_f1_class <- ivsts1 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class, fig.cap='Training Set Step 2 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts2_f1_class <- ivsts2 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class-table} -->
<!-- ivsts1_f1_class_table <- ivsts1_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts1_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class-table} -->
<!-- ivsts2_f1_class_table <- ivsts2_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts2_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r train-step1-kappa, fig.cap='Training Set Step 1 Kappa'} -->
<!-- ivsts1_kappa <- ivsts1 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa, fig.cap='Training Set Step 2 Kappa'} -->
<!-- ivsts2_kappa <- ivsts2 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-table} -->
<!-- ivsts1_kappa_table <- ivsts1_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_table, -->
<!--       caption = "Training Set Step 1 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-table} -->
<!-- ivsts2_kappa_table <- ivsts2_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_table, -->
<!--       caption = "Training Set Step 2 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class, fig.cap='Training Set Step 1 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts1_kappa_class <- ivsts1 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class, fig.cap='Training Set Step 2 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts2_kappa_class <- ivsts2 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class-table} -->
<!-- ivsts1_kappa_class_table <- ivsts1_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class-table} -->
<!-- ivsts2_kappa_class_table <- ivsts2_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r train-step1-gmean, fig.cap='Training Set Step 1 G-mean'} -->
<!-- ivsts1_gmean <- ivsts1 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean, fig.cap='Training Set Step 2 G-mean'} -->
<!-- ivsts2_gmean <- ivsts2 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-table} -->
<!-- ivsts1_gmean_table <- ivsts1_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_table, -->
<!--       caption = "Training Set Step 1 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-table} -->
<!-- ivsts2_gmean_table <- ivsts2_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_table, -->
<!--       caption = "Training Set Step 2 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class, fig.cap='Training Set Step 1 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts1_gmean_class <- ivsts1 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-class, fig.cap='Training Set Step 2 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts2_gmean_class <- ivsts2 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class-table} -->
<!-- ivsts1_gmean_class_table <- ivsts1_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->







<!-- ```{r train-step2-gmean-class-table} -->
<!-- ivsts2_gmean_class_table <- ivsts2_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## CS1 Set -->

<!-- ### Accuracy -->

<!-- ```{r cs1-accuracy, fig.cap='CS1 Set Accuracy'} -->
<!-- ivs1_accuracy <- ivs1 %>% -->
<!--   filter(measure == "accuracy") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-table} -->
<!-- ivs1_accuracy_table <- ivs1_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_accuracy_table, -->
<!--       caption = "CS1 Set Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-class, fig.cap='CS1 Set Class-Specific Accuracy', fig.width=8} -->
<!-- ivs1_accuracy_class <- ivs1 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-accuracy-class-table} -->
<!-- ivs1_accuracy_class_table <- ivs1_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_accuracy_class_table, -->
<!--       caption = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r cs1-f1, fig.cap='CS1 Set F1-Score'} -->
<!-- ivs1_f1 <- ivs1 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-f1-table} -->
<!-- ivs1_f1_table <- ivs1_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_f1_table, -->
<!--       caption = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r cs1-f1-class, fig.cap='CS1 Set Class-Specific F1-Score', fig.width=8} -->
<!-- ivs1_f1_class <- ivs1 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-f1-class-table} -->
<!-- ivs1_f1_class_table <- ivs1_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_f1_class_table, -->
<!--       caption = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r cs1-kappa, fig.cap='CS1 Set Kappa'} -->
<!-- ivs1_kappa <- ivs1 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-kappa-table} -->
<!-- ivs1_kappa_table <- ivs1_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_kappa_table, -->
<!--       caption = "CS1 Set Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-kappa-class, fig.cap='CS1 Set Class-Specific Kappa', fig.width=8} -->
<!-- ivs1_kappa_class <- ivs1 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-kappa-class-table} -->
<!-- ivs1_kappa_class_table <- ivs1_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_kappa_class_table, -->
<!--       caption = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r cs1-gmean, fig.cap='CS1 Set G-mean'} -->
<!-- ivs1_gmean <- ivs1 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs1_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-gmean-table} -->
<!-- ivs1_gmean_table <- ivs1_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_gmean_table, -->
<!--       caption = "CS1 Set G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs1-gmean-class, fig.cap='CS1 Set Class-Specific G-mean', fig.width=8} -->
<!-- ivs1_gmean_class <- ivs1 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs1_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS1 Set Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs1-gmean-class-table} -->
<!-- ivs1_gmean_class_table <- ivs1_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs1_gmean_class_table, -->
<!--       caption = "CS1 Set Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## CS2 Set -->

<!-- ### Accuracy -->

<!-- ```{r cs2-accuracy, fig.cap='CS2 Set Accuracy'} -->
<!-- ivs2_accuracy <- ivs2 %>% -->
<!--   filter(measure == "accuracy") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-table} -->
<!-- ivs2_accuracy_table <- ivs2_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_accuracy_table, -->
<!--       caption = "CS2 Set Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-class, fig.cap='CS2 Set Class-Specific Accuracy', fig.width=8} -->
<!-- ivs2_accuracy_class <- ivs2 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-accuracy-class-table} -->
<!-- ivs2_accuracy_class_table <- ivs2_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_accuracy_class_table, -->
<!--       caption = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r cs2-f1, fig.cap='CS2 Set F1-Score'} -->
<!-- ivs2_f1 <- ivs2 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-f1-table} -->
<!-- ivs2_f1_table <- ivs2_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_f1_table, -->
<!--       caption = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r cs2-f1-class, fig.cap='CS2 Set Class-Specific F1-Score', fig.width=8} -->
<!-- ivs2_f1_class <- ivs2 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-f1-class-table} -->
<!-- ivs2_f1_class_table <- ivs2_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_f1_class_table, -->
<!--       caption = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r cs2-kappa, fig.cap='CS2 Set Kappa'} -->
<!-- ivs2_kappa <- ivs2 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-kappa-table} -->
<!-- ivs2_kappa_table <- ivs2_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_kappa_table, -->
<!--       caption = "CS2 Set Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-kappa-class, fig.cap='CS2 Set Class-Specific Kappa', fig.width=8} -->
<!-- ivs2_kappa_class <- ivs2 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-kappa-class-table} -->
<!-- ivs2_kappa_class_table <- ivs2_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_kappa_class_table, -->
<!--       caption = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r cs2-gmean, fig.cap='CS2 Set G-mean'} -->
<!-- ivs2_gmean <- ivs2 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivs2_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-gmean-table} -->
<!-- ivs2_gmean_table <- ivs2_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_gmean_table, -->
<!--       caption = "CS2 Set G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r cs2-gmean-class, fig.cap='CS2 Set Class-Specific G-mean', fig.width=8} -->
<!-- ivs2_gmean_class <- ivs2 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivs2_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "CS2 Set Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r cs2-gmean-class-table} -->
<!-- ivs2_gmean_class_table <- ivs2_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs2_gmean_class_table, -->
<!--       caption = "CS2 Set Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ## SMOTE Kappa Summary -->

<!-- ```{r smote-kappa, fig.cap='SMOTE Kappa by Algorithm and Dataset'} -->
<!-- ivs_smote_kappa <- ivs %>% -->
<!--   filter(sampling == "smote", measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- -->
<!--   ggplot(ivs_smote_kappa, aes(x = algorithm, y = percentile_50, color = dataset)) + -->
<!--   geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95), -->
<!--                   position = position_dodge(width = 0.4)) + -->

<!--   theme_bw() + -->
<!--   theme(plot.title = element_text(face = "bold")) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   labs( -->
<!--     x = "Algorithm", -->
<!--     y = "Kappa", -->
<!--     color = "Dataset", -->
<!--     title = "SMOTE Kappa by Algorithm and Dataset" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r smote-kappa-table} -->
<!-- ivs_smote_kappa_table <- ivs_smote_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = dataset, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivs_smote_kappa_table, -->
<!--       caption = "SMOTE Kappa by Algorithm and Dataset", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r smote-kappa-class, fig.cap='SMOTE Class-Specific Kappa by Algorithm and Dataset', fig.width=8} -->
<!-- ivs_smote_kappa_class <- ivs %>% -->
<!--   filter(sampling == "smote", grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- -->
<!--   ggplot(ivs_smote_kappa_class, aes(x = algorithm, y = percentile_50, color = dataset)) + -->
<!--   geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95), -->
<!--                   position = position_dodge(width = 0.4)) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   theme_bw() + -->
<!--   theme(plot.title = element_text(face = "bold")) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     x = "Algorithm", -->
<!--     y = "Kappa", -->
<!--     color = "Dataset", -->
<!--     title = "SMOTE Class-Specific Kappa by Algorithm and Dataset" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

## Gene Optimization

### Overlap with Other Sets

```{r overlap-protype}
overlap_PrOTYPE <- intersect(names(train_data), cs5$Name)
```

There are `r length(overlap_PrOTYPE)` genes out of the `r ncol(train_data)` common classifier set that overlap with the PrOTYPE classifier: `r paste(overlap_PrOTYPE, collapse = ", ")`

```{r overlap-SPOT}
overlap_SPOT <- intersect(names(train_data), coefmat[["Symbol"]])
```

There are `r length(overlap_SPOT)` genes out of the `r ncol(train_data)` classifier set that overlap with the SPOT signature: `r paste(overlap_SPOT, collapse = ", ")`.

### Optimal Gene Set

```{r overlap-all}
overlap_all <- unique(c(overlap_PrOTYPE, overlap_SPOT))
candidates <- setdiff(names(train_data), overlap_all)
```

There are `r length(overlap_all)` unique genes from the combined PrOTYPE and SPOT lists that we want to use for the final classifier. We then incrementally add genes from the remaining `r length(candidates)` candidates based on variable importance scores to this list and recalculate performance metrics. The number of genes at which the performance starts to plateau may indicate an optimal gene set for us to carry forward for a particular model.

Variable importance is calculated using either a model-based approach if it is available, or a SHAP-based VI score otherwise (e.g. for SVM). For the sequential and two-step classifiers, we calculate overall VI scores by aggregating the base classifier VI scores using rank aggregation.

```{r gene-seq, fig.height=8, fig.cap='Gene Optimization for Sequential Classifier'}
gene_seq_names <- all_vi_seq %>% 
  select(Name = Variable) %>% 
  rowid_to_column("Genes")

dat_gene_seq <- gene_opt_all_metrics_seq %>% 
  filter(.metric == "f_meas") %>% 
  mutate(
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Workflow: ",
      wflow,
      ", Measure: ",
      .metric)
  ) %>% 
  inner_join(gene_seq_names, by = "Genes")

p_gene_seq <-
  ggplot(dat_gene_seq, aes(x = Genes, y = .estimate, text = Name)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "F1-Score",
       title = "Gene Optimziation for Sequential Classifier")
ggplotly(p_gene_seq)

n_genes_seq <- 28
genes_add_seq <- gene_seq_names %>%
  slice_min(order_by = Genes, n = n_genes_seq) %>% 
  pull(Name)
opt_genes_seq <- c(overlap_all, genes_add_seq)
```

In the sequential classifier, we use the per-class median F1-scores pertaining to the histotype that had the best performance from each retraining, and sort them on number of genes added. For instance, in sequence 2, we look at the CCOC F1-scores because CCOC had the best performance from retraining after HGSC was removed.

We can observe that in sequence 3, the F1-score stabilizes at around 0.93 when we reach `r n_genes_seq` genes added, hence the optimal number of genes used will be n=28+34=62. The added genes are: `r str_flatten_comma(genes_add_seq, last = " and ")`.

```{r gene-2s, fig.cap='Gene Optimization for Two-Step Classifier'}
gene_2s_names <- all_vi_two_step %>% 
  select(Name = Variable) %>% 
  rowid_to_column("Genes")

dat_gene_2s <- gene_opt_all_metrics_two_step %>% 
  filter(.metric == "f_meas") %>% 
  mutate(
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Workflow: ",
      wflow,
      ", Measure: ",
      .metric)
  ) %>% 
  inner_join(gene_seq_names, by = "Genes")

p_gene_2s <-
  ggplot(dat_gene_2s, aes(x = Genes, y = .estimate, text = Name)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "F1-Score",
       title = "Gene Optimziation for Two-Step Classifier")
ggplotly(p_gene_2s)

n_genes_2s <- 31
genes_add_2s <- gene_2s_names %>%
  slice_min(order_by = Genes, n = n_genes_2s) %>% 
  pull(Name)
opt_genes_2s <- c(overlap_all, genes_add_2s)
```

Since the second step of the classifier fits a multinomial model, we use the macro F1-score as the measure to analyze gene entry. In the two-step classifier, we see that in Step 2, the F1-score stabilizes at around 0.88 when we reach `r n_genes_2s` added. The optimal number of genes used will be n=28+`r n_genes_2s`=52. The added genes are: `r str_flatten_comma(genes_add_2s, last = " and ")`.

## Rank Aggregation

```{r per-class-metrics}
# Combine per-class metrics
per_class_metrics <- bind_rows(
  all_metrics_train,
  per_class_metrics_seq %>%
    add_column(wflow = "sequential", .before = 1),
  per_class_metrics_two_step %>%
    add_column(wflow = "two_step", .before = 1)
) %>% 
  filter(class_group != "Overall")

# Keep only workflows that predicted at least one case in each class
per_class_f1 <- per_class_metrics %>%
  filter(.metric == "f_meas") %>%
  select(wflow, class_group, .estimate) %>%
  pivot_wider(names_from = "class_group", values_from = ".estimate") %>%
  drop_na() %>%
  pivot_longer(-wflow, names_to = "class_group", values_to = ".estimate")

# Rank F1-measures
wflow_ranks <- per_class_f1 %>%
  group_by(class_group) %>%
  mutate(rank = factor(row_number(-.estimate))) %>%
  ungroup() %>%
  arrange(rank) %>%
  pivot_wider(id_cols = class_group,
              names_from = "rank",
              values_from = "wflow") %>%
  column_to_rownames("class_group") %>%
  as.matrix()

# Rank aggregation using genetic algorithm
wflow_top <- splendid:::sink_output(RankAggreg(
  x = wflow_ranks,
  k = ncol(wflow_ranks),
  method = "GA",
  seed = 2022,
  verbose = FALSE
)) %>% 
  pluck("top.list") %>% 
  enframe(name = "rank", value = "wflow")

# F1-score summary
f1_summary <- per_class_f1 %>% 
  pivot_wider(names_from = class_group, values_from = .estimate) %>% 
  mutate(across(where(is.numeric), ~ round(.x, digits = 3))) %>% 
  inner_join(wflow_top, by = "wflow") %>% 
  arrange(rank)

datatable(
  f1_summary,
  options = list(
    scrollX = TRUE,
    fixedColumns = TRUE,
    columnDefs = list(
      list(
        targets = 1,
        render = JS("$.fn.dataTable.render.ellipsis( 10 )")
      ),
      list(type = "natural", targets = 0)
    ),
    pageLength = 50
  ), 
  rownames = FALSE,
  caption = "F1-Score Summary by Workflow and Class",
  filter = "top",
  extensions = "FixedColumns",
  plugins = c("ellipsis", "natural")
)
```

The `r ncol(wflow_ranks)` workflows are ordered in the table by their aggregated ranks using the Genetic Algorithm. We see that the best performing methods involve the sequential and two-step algorithms.

### Top Workflows

We look at the per-class evaluation metrics of the top 4 workflows.

```{r metrics-top4, fig.cap='Top 4 Workflow Per-Class Evaluation Metrics'}
wflow_top4 <- wflow_top %>% 
  head(4)

metrics_top4 <- per_class_metrics %>% 
  inner_join(wflow_top4, by = "wflow") %>% 
  mutate(wflow = fct_reorder(wflow, rank)) %>% 
  arrange(rank)

p <- 
  ggplot(metrics_top4, aes(x = wflow, y = .estimate, color = .metric)) +
  geom_point(position = position_jitter(width = 0.1)) +
  facet_wrap(vars(class_group), ncol = 2) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Workflow",
    y = "Metric",
    color = "Metric",
    title = "Top 4 Workflow Per-Class Evaluation Metrics"
  )
print(p)
```

```{r metrics-f1-top4, fig.cap='Top 4 Workflow Per-Class F1-Scores'}
metrics_f1_top4 <- metrics_top4 %>% 
  filter(.metric == "f_meas")

p <- 
  ggplot(metrics_f1_top4, aes(x = class_group, y = .estimate, color = wflow)) +
  geom_point(position = position_jitter(width = 0.1)) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Class",
    y = "Metric",
    color = "Workflow",
    title = "Top 4 Workflow Per-Class F1-Scores"
  )
print(p)
```

Misclassified cases from a previous step of the sequence of classifiers are not included in subsequent steps of the training set CV folds. Thus, we cannot piece together the test set predictions from the sequential and two-step algorithms to obtain overall metrics.

## Test Set Performance

Now we'd like to see how our best methods perform in the confirmation and validation sets. The class-specific F1-scores will be used.

The top 2 methods are:

- **sequential**: sequential algorithm with hybrid subsampling at every step. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using random forest
  - CCOC vs. non-CCOC using support vector machine
  - LGSC vs. non-LGSC using support vector machine
  - ENOC vs. MUC using regularized multinomial regression
- **two_step**: two-step algorithm with hybrid subsampling at both steps. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using random forest
  - CCOC vs. ENOC vs. MUC vs. LGSC support vector machine
  
We can test 2 additional methods by using either the full set of genes or the optimal set of genes for both of these methods.

```{r top-models}
# Two-step data
two_step_data <- readRDS(here("data", "two_step_data.rds"))
two_step_class <- readRDS(here("data", "two_step_class.rds"))
two_step_algs <- readRDS(here("data", "two_step_algs.rds"))

# Two-step full model
set.seed(2024)
mod_two_step_full <- list(all_models_two_step,
                          two_step_data,
                          two_step_class) %>% 
  pmap(~ {
    data = cbind(..2, class = ..3)
    ..1 %>% fit(data = data)
  })

# Two-step optimal gene list model
set.seed(2024)
mod_two_step_opt <- list(all_models_two_step,
                         two_step_data,
                         two_step_class) %>% 
  pmap(~ {
    data = cbind(..2, class = ..3)
    ..1 %>%
      update_recipe(pluck(., "pre", "actions", "recipe", "recipe") %>%
                      step_select(c(all_of(!!opt_genes_2s), class),
                                  skip = TRUE)) %>%
      fit(data = data)
  })

# sequential data
seq_data <- readRDS(here("data", "seq_data.rds"))
seq_class <- readRDS(here("data", "seq_class.rds"))
seq_wflows <- readRDS(here("data", "seq_wflows.rds"))

# Sequential full model
set.seed(2024)
mod_seq_full <- list(all_models_seq,
                     seq_data,
                     seq_class) %>% 
  pmap(~ {
    data = cbind(..2, class = ..3)
    ..1 %>% fit(data = data)
  })

# Sequential optimal gene list model
set.seed(2024)
mod_seq_opt <- list(all_models_seq,
                    seq_data,
                    seq_class) %>% 
  pmap(~ {
    data = cbind(..2, class = ..3)
    ..1 %>%
      update_recipe(pluck(., "pre", "actions", "recipe", "recipe") %>%
                      step_select(c(all_of(!!opt_genes_seq), class),
                                  skip = TRUE)) %>%
      fit(data = data)
  })

# Per-class metric set
gmean <- new_class_metric(gmean, direction = "maximize")
per_class_mset <-
  metric_set(accuracy, f_meas, kap, gmean)
```

### Confirmation Set

```{r confirmation-set}
# Load data
conf_class <- readRDS(here("data", "conf_class.rds"))
conf_data <- readRDS(here("data", "conf_data.rds"))
```

```{r conf-eval-overall}
# Confirmation set overall predictions
conf_pred_overall <- data.frame(FileName = rownames(conf_data),
                                Truth = conf_class) %>%
  mutate(
    c(
      p_2s_full = mod_two_step_full,
      p_2s_opt = mod_two_step_opt,
      p_seq_full = mod_seq_full,
      p_seq_opt = mod_seq_opt
    ) %>%
      map(~ predict(., conf_data)[[".pred_class"]]) %>%
      bind_cols()
  ) %>% 
  rename_with(~ gsub("(.*)\\..*_(.*)", "\\1_\\2", .), where(is.factor)) %>% 
  mutate(
    across(matches("p"), as.character),
    Prediction_two_step_full = ifelse(!grepl("non", p_2s_full_s1),
                                      p_2s_full_s1, p_2s_full_s2),
    Prediction_two_step_optimal = ifelse(!grepl("non", p_2s_opt_s1),
                                         p_2s_opt_s1, p_2s_opt_s2), 
    Prediction_sequential_full = case_when(
      !grepl("non", p_seq_full_s1) ~ p_seq_full_s1,
      !grepl("non", p_seq_full_s2) ~ p_seq_full_s2,
      !grepl("non", p_seq_full_s3) ~ p_seq_full_s3,
      .default = p_seq_full_s4
    ),
    Prediction_sequential_optimal = case_when(
      !grepl("non", p_seq_opt_s1) ~ p_seq_opt_s1,
      !grepl("non", p_seq_opt_s2) ~ p_seq_opt_s2,
      !grepl("non", p_seq_opt_s3) ~ p_seq_opt_s3,
      .default = p_seq_opt_s4
    ),
    across(c("Truth", matches("Prediction")), factor)
  ) %>%
  select(-starts_with("p", ignore.case = FALSE)) %>%
  pivot_longer(
    cols = matches("Prediction"),
    names_to = "method",
    names_prefix = "Prediction_",
    values_to = "Prediction"
  )

# Confimation set overall metrics
conf_eval_overall <- conf_pred_overall %>%
  group_by(method) %>%
  summarize(
    accuracy = yardstick::accuracy_vec(Truth, Prediction),
    kappa = yardstick::kap_vec(Truth, Prediction),
    f1 = yardstick::f_meas_vec(Truth, Prediction),
    gmean = splendid:::gmean(table(Prediction, Truth))
  )

kable(conf_eval_overall,
      caption = "Overall Evaluation Metrics on Confirmation Set Models",
      digits = 3) %>%
  kable_styling()
```

```{r conf-eval-per-class}
conf_eval_per_class <- conf_pred_overall %>% 
  mutate(
    pred_class_ova = map(Prediction, ~ {
      ifelse(levels(Prediction) %in% .x, as.character(.x), "class_0") %>%
        set_names(paste0(".pred_class_", levels(Prediction)))
    }),
    class_ova = map(Truth, ~ {
      ifelse(levels(Truth) %in% .x, as.character(.x), "class_0") %>%
        set_names(paste0("class_", levels(Truth)))
    })
  ) %>% 
  unnest_wider(col = c(pred_class_ova, class_ova)) %>%
  pivot_longer(
    matches("^.pred_class_.*"),
    names_to = ".pred_class_group",
    names_prefix = ".pred_class_",
    values_to = ".pred_class_value"
  ) %>%
  pivot_longer(
    matches("^class_.*"),
    names_to = "class_group",
    names_prefix = "class_",
    values_to = "class_value"
  ) %>%
  filter(class_group == .pred_class_group) %>%
  nest(.by = c(method, class_group)) %>% 
  mutate(
    data = data %>%
      map(~ mutate(.x, across(
        matches("class_value"),
        ~ factor(.x, levels = unique(c(
          .pred_class_group, "class_0"
        )))
      ))) %>%
      map(per_class_mset, truth = class_value, estimate = .pred_class_value) %>%
      suppressWarnings()
  ) %>% 
  unnest(cols = data) %>% 
  select(-.estimator) %>% 
  pivot_wider(names_from = "class_group", values_from = ".estimate")

kable(conf_eval_per_class,
      caption = "Per-Class Eevaluation Metrics on Confirmation Set Model",
      digits = 3) %>% 
  kable_styling() %>% 
  collapse_rows(columns = 1)
```

### Validation Set

```{r validation-set}
# Load data
val_class <- readRDS(here("data", "val_class.rds"))
val_data <- readRDS(here("data", "val_data.rds"))
```

```{r val-eval-overall}
# Validation set overall predictions
val_pred_overall <- data.frame(FileName = rownames(val_data),
                               Truth = val_class) %>%
  mutate(
    c(p_2s_opt = mod_two_step_opt) %>%
      map(~ predict(., val_data)[[".pred_class"]]) %>%
      bind_cols()
  ) %>% 
  rename_with(~ gsub("(.*)\\..*_(.*)", "\\1_\\2", .), where(is.factor)) %>% 
  
  mutate(
    across(matches("p"), as.character),
    Prediction_two_step_optimal = ifelse(!grepl("non", p_2s_opt_s1),
                                         p_2s_opt_s1, p_2s_opt_s2),
    across(c("Truth", matches("Prediction")), factor)
  ) %>%
  select(-starts_with("p", ignore.case = FALSE)) %>%
  pivot_longer(
    cols = matches("Prediction"),
    names_to = "method",
    names_prefix = "Prediction_",
    values_to = "Prediction"
  )

# Valiation set overall metrics
val_eval_overall <- val_pred_overall %>%
  group_by(method) %>%
  summarize(
    accuracy = yardstick::accuracy_vec(Truth, Prediction),
    kappa = yardstick::kap_vec(Truth, Prediction),
    f1 = yardstick::f_meas_vec(Truth, Prediction),
    gmean = splendid:::gmean(table(Prediction, Truth))
  )

kable(val_eval_overall,
      caption = "Overall Evaluation Metrics on Validation Set Model",
      digits = 3) %>% 
  kable_styling()
```

```{r val-eval-per-class}
val_eval_per_class <- val_pred_overall %>% 
  mutate(
    pred_class_ova = map(Prediction, ~ {
      ifelse(levels(Prediction) %in% .x, as.character(.x), "class_0") %>%
        set_names(paste0(".pred_class_", levels(Prediction)))
    }),
    class_ova = map(Truth, ~ {
      ifelse(levels(Truth) %in% .x, as.character(.x), "class_0") %>%
        set_names(paste0("class_", levels(Truth)))
    })
  ) %>% 
  unnest_wider(col = c(pred_class_ova, class_ova)) %>%
  pivot_longer(
    matches("^.pred_class_.*"),
    names_to = ".pred_class_group",
    names_prefix = ".pred_class_",
    values_to = ".pred_class_value"
  ) %>%
  pivot_longer(
    matches("^class_.*"),
    names_to = "class_group",
    names_prefix = "class_",
    values_to = "class_value"
  ) %>%
  filter(class_group == .pred_class_group) %>%
  nest(.by = c(method, class_group)) %>% 
  mutate(
    data = data %>%
      map(~ mutate(.x, across(
        matches("class_value"),
        ~ factor(.x, levels = unique(c(
          .pred_class_group, "class_0"
        )))
      ))) %>%
      map(per_class_mset, truth = class_value, estimate = .pred_class_value) %>%
      suppressWarnings()
  ) %>% 
  unnest(cols = data) %>% 
  select(-.estimator) %>% 
  pivot_wider(names_from = "class_group", values_from = ".estimate")

kable(val_eval_per_class,
      caption = "Per-Class Eevaluation Metrics on Validation Set Model",
      digits = 3) %>% 
  kable_styling() %>% 
  collapse_rows(columns = 1)
```
