# Results

```{r setup-04}
# Load packages and data
library(dplyr)
library(purrr)
library(tibble)
library(tidyr)
library(ggplot2)
library(forcats)
library(knitr)
library(kableExtra)
library(RankAggreg)
library(splendid)
library(magrittr)
library(DT)
library(here)
source(here("validation/cs_process_cohorts.R"))
source(here("src/funs.R"))
ivst <- readRDS(here("data/iv_summary_train.rds"))
ivsts1 <- readRDS(here("data/iv_summary_train_step1.rds"))
ivsts2 <- readRDS(here("data/iv_summary_train_step2.rds"))
ivs1 <- readRDS(here("data/iv_summary_cs1_all.rds"))
ivs2 <- readRDS(here("data/iv_summary_cs2_all.rds"))
ivs2s <- readRDS(here("data/iv_summary_two_step.rds"))
ivsseq <- readRDS(here("data/iv_summary_seq.rds"))
train_data <- readRDS(here("data/train_data.rds"))
coefmat <- readRDS(here("data/coefmat.rds"))
geneseq <- readRDS(here("data/merge_eval_seq.rds"))
gene2s <- readRDS(here("data/merge_eval_two_step.rds"))
ranked_vi_seq <- readRDS(here("data/ranked_vi_seq.rds"))
ranked_vi_2s <- readRDS(here("data/ranked_vi_two_step.rds"))
```

```{r ivs-combine}
ivst <- ivst %>% mutate(sampling = fct_inorder(sampling))
ivsts1 <- ivsts1 %>% mutate(sampling = fct_inorder(sampling))
ivsts2 <- ivsts2 %>% mutate(sampling = fct_inorder(sampling))
ivs1 <- ivs1 %>% mutate(sampling = fct_inorder(sampling))
ivs2 <- ivs2 %>% mutate(sampling = fct_inorder(sampling))
ivs <- bind_rows(ivst, ivs1, ivs2) %>%
  mutate(dataset = factor(
    dataset,
    levels = c("train", "cs1_all", "cs2_all"),
    labels = c("Training", "CS1", "CS2")
  ),
  sampling = fct_inorder(sampling))
```

We show internal validation summaries for the combined classifier training set, as well as the CS1 and CS2 sets with duplicates included. The F1-scores, kappa, and G-mean are the measures of interest. Algorithms are sorted by descending value based on the overallaccuracy of the training set. The point ranges show the median, 5th and 95th percentiles, coloured by subsampling methods.

## Training Set

### Accuracy

```{r train-accuracy, fig.cap='Training Set Accuracy'}
ivst_accuracy <- ivst %>% 
  filter(measure == "accuracy") %>% 
  mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50))

alg_levels <- levels(ivst_accuracy[["algorithm"]])

p <- plot_measure(ivst_accuracy) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "Training Set Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-accuracy-table}
ivst_accuracy_table <- ivst_accuracy %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_accuracy_table,
      caption = "Training Set Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r train-accuracy-class, fig.cap='Training Set Class-Specific Accuracy', fig.width=8}
ivst_accuracy_class <- ivst %>%
  filter(grepl("accuracy\\.", measure)) %>%
  mutate(
    measure = gsub("accuracy\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivst_accuracy_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "Training Set Class-Specific Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-accuracy-class-table}
ivst_accuracy_class_table <- ivst_accuracy_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_accuracy_class_table,
      caption = "Training Set Class-Specific Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### F1-Score

```{r train-f1, fig.cap='Training Set F1-Score'}
ivst_f1 <- ivst %>%
  filter(measure == "macro_f1") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivst_f1) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "Training Set Macro-Averaged F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-f1-table}
ivst_f1_table <- ivst_f1 %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_f1_table,
      caption = "Training Set Macro-Averaged F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

```{r train-f1-class, fig.cap='Training Set Class-Specific F1-Score', fig.width=8}
ivst_f1_class <- ivst %>%
  filter(grepl("f1\\.", measure)) %>%
  mutate(
    measure = gsub("f1\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivst_f1_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "Training Set Class-Specific F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-f1-class-table}
ivst_f1_class_table <- ivst_f1_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_f1_class_table,
      caption = "Training Set Class-Specific F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### Kappa

```{r train-kappa, fig.cap='Training Set Kappa'}
ivst_kappa <- ivst %>%
  filter(measure == "kappa") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivst_kappa) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "Training Set Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-kappa-table}
ivst_kappa_table <- ivst_kappa %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_kappa_table,
      caption = "Training Set Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r train-kappa-class, fig.cap='Training Set Class-Specific Kappa', fig.width=8}
ivst_kappa_class <- ivst %>%
  filter(grepl("kappa\\.", measure)) %>%
  mutate(
    measure = gsub("kappa\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivst_kappa_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "Training Set Class-Specific Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-kappa-class-table}
ivst_kappa_class_table <- ivst_kappa_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_kappa_class_table,
      caption = "Training Set Class-Specific Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### G-mean

```{r train-gmean, fig.cap='Training Set G-mean'}
ivst_gmean <- ivst %>%
  filter(measure == "gmean") %>%
  mutate(
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivst_gmean) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "Training Set G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-gmean-table}
ivst_gmean_table <- ivst_gmean %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_gmean_table,
      caption = "Training Set G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r train-gmean-class, fig.cap='Training Set Class-Specific G-mean', fig.width=8}
ivst_gmean_class <- ivst %>%
  filter(grepl("gmean\\.", measure)) %>%
  mutate(
    measure = gsub("gmean\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivst_gmean_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "Training Set Class Specific G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r train-gmean-class-table}
ivst_gmean_class_table <- ivst_gmean_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivst_gmean_class_table,
      caption = "Training Set Class-Specific G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

<!-- ## Two-Step Training Set -->

<!-- ### Accuracy -->

<!-- ```{r train-step1-accuracy, fig.cap='Training Set Step 1 Accuracy'} -->
<!-- ivsts1_accuracy <- ivsts1 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts1_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts1_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy, fig.cap='Training Set Step 2 Accuracy'} -->
<!-- ivsts2_accuracy <- ivsts2 %>%  -->
<!--   filter(measure == "accuracy") %>%  -->
<!--   mutate(algorithm = fct_reorder2(algorithm, sampling, percentile_50)) -->

<!-- alg_levels <- levels(ivsts2_accuracy[["algorithm"]]) -->

<!-- p <- plot_measure(ivsts2_accuracy) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-table} -->
<!-- ivsts1_accuracy_table <- ivsts1_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_table, -->
<!--       caption = "Training Set Step 1 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-table} -->
<!-- ivsts2_accuracy_table <- ivsts2_accuracy %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_table, -->
<!--       caption = "Training Set Step 2 Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class, fig.cap='Training Set Step 1 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts1_accuracy_class <- ivsts1 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class, fig.cap='Training Set Step 2 Class-Specific Accuracy', fig.width=8} -->
<!-- ivsts2_accuracy_class <- ivsts2 %>% -->
<!--   filter(grepl("accuracy\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("accuracy\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_accuracy_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Accuracy", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-accuracy-class-table} -->
<!-- ivsts1_accuracy_class_table <- ivsts1_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_accuracy_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-accuracy-class-table} -->
<!-- ivsts2_accuracy_class_table <- ivsts2_accuracy_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_accuracy_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Accuracy by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### F1-Score -->

<!-- ```{r train-step1-f1, fig.cap='Training Set Step 1 F1-Score'} -->
<!-- ivsts1_f1 <- ivsts1 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1, fig.cap='Training Set Step 2 F1-Score'} -->
<!-- ivsts2_f1 <- ivsts2 %>% -->
<!--   filter(measure == "macro_f1") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_f1) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-table} -->
<!-- ivsts1_f1_table <- ivsts1_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_f1_table, -->
<!--       caption = "Training Set Step 1 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-f1-table} -->
<!-- ivsts2_f1_table <- ivsts2_f1 %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_f1_table, -->
<!--       caption = "Training Set Step 2 Macro-Averaged F1-Score by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class, fig.cap='Training Set Step 1 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts1_f1_class <- ivsts1 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class, fig.cap='Training Set Step 2 Class-Specific F1-Score', fig.width=8} -->
<!-- ivsts2_f1_class <- ivsts2 %>% -->
<!--   filter(grepl("f1\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("f1\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_f1_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "F1-Score", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-f1-class-table} -->
<!-- ivsts1_f1_class_table <- ivsts1_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts1_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 1 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r train-step2-f1-class-table} -->
<!-- ivsts2_f1_class_table <- ivsts2_f1_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- datatable( -->
<!--   ivsts2_f1_class_table, -->
<!--   options = list( -->
<!--     scrollX = TRUE, -->
<!--     fixedColumns = TRUE, -->
<!--     columnDefs = list( -->
<!--       list( -->
<!--         targets = 1, -->
<!--         render = JS("$.fn.dataTable.render.ellipsis( 10 )") -->
<!--       ), -->
<!--       list(type = "natural", targets = 0) -->
<!--     ), -->
<!--     pageLength = 50 -->
<!--   ), -->
<!--   escape = FALSE, -->
<!--   rownames = FALSE, -->
<!--   caption = "Training Set Step 2 Class-Specific F1-Score by Algorithm and Subsampling Method", -->
<!--   filter = "top", -->
<!--   extensions = "FixedColumns", -->
<!--   plugins = c("ellipsis", "natural") -->
<!-- ) -->
<!-- ``` -->

<!-- ### Kappa -->

<!-- ```{r train-step1-kappa, fig.cap='Training Set Step 1 Kappa'} -->
<!-- ivsts1_kappa <- ivsts1 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts1_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa, fig.cap='Training Set Step 2 Kappa'} -->
<!-- ivsts2_kappa <- ivsts2 %>% -->
<!--   filter(measure == "kappa") %>% -->
<!--   mutate(algorithm = factor(algorithm, levels = alg_levels)) -->

<!-- p <- plot_measure(ivsts2_kappa) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-table} -->
<!-- ivsts1_kappa_table <- ivsts1_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_table, -->
<!--       caption = "Training Set Step 1 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-table} -->
<!-- ivsts2_kappa_table <- ivsts2_kappa %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_table, -->
<!--       caption = "Training Set Step 2 Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class, fig.cap='Training Set Step 1 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts1_kappa_class <- ivsts1 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class, fig.cap='Training Set Step 2 Class-Specific Kappa', fig.width=8} -->
<!-- ivsts2_kappa_class <- ivsts2 %>% -->
<!--   filter(grepl("kappa\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("kappa\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_kappa_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "Kappa", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-kappa-class-table} -->
<!-- ivsts1_kappa_class_table <- ivsts1_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_kappa_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ```{r train-step2-kappa-class-table} -->
<!-- ivsts2_kappa_class_table <- ivsts2_kappa_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_kappa_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific Kappa by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- ### G-mean -->

<!-- ```{r train-step1-gmean, fig.cap='Training Set Step 1 G-mean'} -->
<!-- ivsts1_gmean <- ivsts1 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean, fig.cap='Training Set Step 2 G-mean'} -->
<!-- ivsts2_gmean <- ivsts2 %>% -->
<!--   filter(measure == "gmean") %>% -->
<!--   mutate( -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-table} -->
<!-- ivsts1_gmean_table <- ivsts1_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_table, -->
<!--       caption = "Training Set Step 1 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-table} -->
<!-- ivsts2_gmean_table <- ivsts2_gmean %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   pivot_wider(id_cols = sampling, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_table, -->
<!--       caption = "Training Set Step 2 G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling()   -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class, fig.cap='Training Set Step 1 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts1_gmean_class <- ivsts1 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts1_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 1 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step2-gmean-class, fig.cap='Training Set Step 2 Class-Specific G-mean', fig.width=8} -->
<!-- ivsts2_gmean_class <- ivsts2 %>% -->
<!--   filter(grepl("gmean\\.", measure)) %>% -->
<!--   mutate( -->
<!--     measure = gsub("gmean\\.", "", measure), -->
<!--     algorithm = factor(algorithm, levels = alg_levels) -->
<!--   ) -->

<!-- p <- plot_measure(ivsts2_gmean_class) + -->
<!--   facet_wrap(vars(measure), ncol = 2) + -->
<!--   labs( -->
<!--     y = "G-mean", -->
<!--     color = "Subsampling", -->
<!--     title = "Training Set Step 2 Class Specific G-mean by Algorithm and Subsampling Method" -->
<!--   ) -->
<!-- print(p) -->
<!-- ``` -->

<!-- ```{r train-step1-gmean-class-table} -->
<!-- ivsts1_gmean_class_table <- ivsts1_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts1_gmean_class_table, -->
<!--       caption = "Training Set Step 1 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->







<!-- ```{r train-step2-gmean-class-table} -->
<!-- ivsts2_gmean_class_table <- ivsts2_gmean_class %>% -->
<!--   arrange(algorithm) %>% -->
<!--   mutate(across(where(is.numeric), round, digits = 3)) %>% -->
<!--   mutate(percentile_50 = ifelse( -->
<!--     percentile_50 == max(percentile_50), -->
<!--     cell_spec(percentile_50, bold = TRUE), -->
<!--     percentile_50 -->
<!--   )) %>% -->
<!--   rename(histotype = measure) %>%  -->
<!--   pivot_wider(id_cols = sampling:histotype, -->
<!--               names_from = "algorithm", -->
<!--               values_from = "percentile_50") %>%  -->
<!--   rename_with(~ gsub("_", "\\\\_", .), matches("_")) -->

<!-- kable(ivsts2_gmean_class_table, -->
<!--       caption = "Training Set Step 2 Class-Specific G-mean by Algorithm and Subsampling Method", -->
<!--       escape = FALSE) %>% -->
<!--   kable_styling() -->
<!-- ``` -->

## CS1 Set

### Accuracy

```{r cs1-accuracy, fig.cap='CS1 Set Accuracy'}
ivs1_accuracy <- ivs1 %>%
  filter(measure == "accuracy") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs1_accuracy) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "CS1 Set Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-accuracy-table}
ivs1_accuracy_table <- ivs1_accuracy %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_accuracy_table,
      caption = "CS1 Set Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs1-accuracy-class, fig.cap='CS1 Set Class-Specific Accuracy', fig.width=8}
ivs1_accuracy_class <- ivs1 %>%
  filter(grepl("accuracy\\.", measure)) %>%
  mutate(
    measure = gsub("accuracy\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs1_accuracy_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-accuracy-class-table}
ivs1_accuracy_class_table <- ivs1_accuracy_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_accuracy_class_table,
      caption = "CS1 Set Class-Specific Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### F1-Score

```{r cs1-f1, fig.cap='CS1 Set F1-Score'}
ivs1_f1 <- ivs1 %>%
  filter(measure == "macro_f1") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs1_f1) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-f1-table}
ivs1_f1_table <- ivs1_f1 %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_f1_table,
      caption = "CS1 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

```{r cs1-f1-class, fig.cap='CS1 Set Class-Specific F1-Score', fig.width=8}
ivs1_f1_class <- ivs1 %>%
  filter(grepl("f1\\.", measure)) %>%
  mutate(
    measure = gsub("f1\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs1_f1_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-f1-class-table}
ivs1_f1_class_table <- ivs1_f1_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_f1_class_table,
      caption = "CS1 Set Class-Specific F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### Kappa

```{r cs1-kappa, fig.cap='CS1 Set Kappa'}
ivs1_kappa <- ivs1 %>%
  filter(measure == "kappa") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs1_kappa) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "CS1 Set Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-kappa-table}
ivs1_kappa_table <- ivs1_kappa %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_kappa_table,
      caption = "CS1 Set Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs1-kappa-class, fig.cap='CS1 Set Class-Specific Kappa', fig.width=8}
ivs1_kappa_class <- ivs1 %>%
  filter(grepl("kappa\\.", measure)) %>%
  mutate(
    measure = gsub("kappa\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs1_kappa_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-kappa-class-table}
ivs1_kappa_class_table <- ivs1_kappa_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_kappa_class_table,
      caption = "CS1 Set Class-Specific Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### G-mean

```{r cs1-gmean, fig.cap='CS1 Set G-mean'}
ivs1_gmean <- ivs1 %>%
  filter(measure == "gmean") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs1_gmean) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "CS1 Set G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-gmean-table}
ivs1_gmean_table <- ivs1_gmean %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_gmean_table,
      caption = "CS1 Set G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs1-gmean-class, fig.cap='CS1 Set Class-Specific G-mean', fig.width=8}
ivs1_gmean_class <- ivs1 %>%
  filter(grepl("gmean\\.", measure)) %>%
  mutate(
    measure = gsub("gmean\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs1_gmean_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "CS1 Set Class Specific G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs1-gmean-class-table}
ivs1_gmean_class_table <- ivs1_gmean_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs1_gmean_class_table,
      caption = "CS1 Set Class-Specific G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

## CS2 Set

### Accuracy

```{r cs2-accuracy, fig.cap='CS2 Set Accuracy'}
ivs2_accuracy <- ivs2 %>%
  filter(measure == "accuracy") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs2_accuracy) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "CS2 Set Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-accuracy-table}
ivs2_accuracy_table <- ivs2_accuracy %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_accuracy_table,
      caption = "CS2 Set Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs2-accuracy-class, fig.cap='CS2 Set Class-Specific Accuracy', fig.width=8}
ivs2_accuracy_class <- ivs2 %>%
  filter(grepl("accuracy\\.", measure)) %>%
  mutate(
    measure = gsub("accuracy\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs2_accuracy_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Accuracy",
    color = "Subsampling",
    title = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-accuracy-class-table}
ivs2_accuracy_class_table <- ivs2_accuracy_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_accuracy_class_table,
      caption = "CS2 Set Class-Specific Accuracy by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### F1-Score

```{r cs2-f1, fig.cap='CS2 Set F1-Score'}
ivs2_f1 <- ivs2 %>%
  filter(measure == "macro_f1") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs2_f1) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-f1-table}
ivs2_f1_table <- ivs2_f1 %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_f1_table,
      caption = "CS2 Set Macro-Averaged F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

```{r cs2-f1-class, fig.cap='CS2 Set Class-Specific F1-Score', fig.width=8}
ivs2_f1_class <- ivs2 %>%
  filter(grepl("f1\\.", measure)) %>%
  mutate(
    measure = gsub("f1\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs2_f1_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "F1-Score",
    color = "Subsampling",
    title = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-f1-class-table}
ivs2_f1_class_table <- ivs2_f1_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_f1_class_table,
      caption = "CS2 Set Class-Specific F1-Score by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### Kappa

```{r cs2-kappa, fig.cap='CS2 Set Kappa'}
ivs2_kappa <- ivs2 %>%
  filter(measure == "kappa") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs2_kappa) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "CS2 Set Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-kappa-table}
ivs2_kappa_table <- ivs2_kappa %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_kappa_table,
      caption = "CS2 Set Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs2-kappa-class, fig.cap='CS2 Set Class-Specific Kappa', fig.width=8}
ivs2_kappa_class <- ivs2 %>%
  filter(grepl("kappa\\.", measure)) %>%
  mutate(
    measure = gsub("kappa\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs2_kappa_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "Kappa",
    color = "Subsampling",
    title = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-kappa-class-table}
ivs2_kappa_class_table <- ivs2_kappa_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_kappa_class_table,
      caption = "CS2 Set Class-Specific Kappa by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

### G-mean

```{r cs2-gmean, fig.cap='CS2 Set G-mean'}
ivs2_gmean <- ivs2 %>%
  filter(measure == "gmean") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <- plot_measure(ivs2_gmean) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "CS2 Set G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-gmean-table}
ivs2_gmean_table <- ivs2_gmean %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = sampling,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_gmean_table,
      caption = "CS2 Set G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()  
```

```{r cs2-gmean-class, fig.cap='CS2 Set Class-Specific G-mean', fig.width=8}
ivs2_gmean_class <- ivs2 %>%
  filter(grepl("gmean\\.", measure)) %>%
  mutate(
    measure = gsub("gmean\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <- plot_measure(ivs2_gmean_class) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    y = "G-mean",
    color = "Subsampling",
    title = "CS2 Set Class Specific G-mean by Algorithm and Subsampling Method"
  )
print(p)
```

```{r cs2-gmean-class-table}
ivs2_gmean_class_table <- ivs2_gmean_class %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  rename(histotype = measure) %>% 
  pivot_wider(id_cols = sampling:histotype,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs2_gmean_class_table,
      caption = "CS2 Set Class-Specific G-mean by Algorithm and Subsampling Method",
      escape = FALSE) %>%
  kable_styling()
```

## SMOTE Kappa Summary

```{r smote-kappa, fig.cap='SMOTE Kappa by Algorithm and Dataset'}
ivs_smote_kappa <- ivs %>%
  filter(sampling == "smote", measure == "kappa") %>%
  mutate(algorithm = factor(algorithm, levels = alg_levels))

p <-
  ggplot(ivs_smote_kappa, aes(x = algorithm, y = percentile_50, color = dataset)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4)) +
  
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    x = "Algorithm",
    y = "Kappa",
    color = "Dataset",
    title = "SMOTE Kappa by Algorithm and Dataset"
  )
print(p)
```

```{r smote-kappa-table}
ivs_smote_kappa_table <- ivs_smote_kappa %>%
  arrange(algorithm) %>%
  mutate(across(where(is.numeric), round, digits = 3)) %>%
  mutate(percentile_50 = ifelse(
    percentile_50 == max(percentile_50),
    cell_spec(percentile_50, bold = TRUE),
    percentile_50
  )) %>%
  pivot_wider(id_cols = dataset,
              names_from = "algorithm",
              values_from = "percentile_50") %>% 
  rename_with(~ gsub("_", "\\\\_", .), matches("_"))

kable(ivs_smote_kappa_table,
      caption = "SMOTE Kappa by Algorithm and Dataset",
      escape = FALSE) %>%
  kable_styling()  
```

```{r smote-kappa-class, fig.cap='SMOTE Class-Specific Kappa by Algorithm and Dataset', fig.width=8}
ivs_smote_kappa_class <- ivs %>%
  filter(sampling == "smote", grepl("kappa\\.", measure)) %>%
  mutate(
    measure = gsub("kappa\\.", "", measure),
    algorithm = factor(algorithm, levels = alg_levels)
  )

p <-
  ggplot(ivs_smote_kappa_class, aes(x = algorithm, y = percentile_50, color = dataset)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4)) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  facet_wrap(vars(measure), ncol = 2) +
  labs(
    x = "Algorithm",
    y = "Kappa",
    color = "Dataset",
    title = "SMOTE Class-Specific Kappa by Algorithm and Dataset"
  )
print(p)
```

## Gene Optimization

### Overlap with Other Sets

```{r overlap-protype}
overlap_PrOTYPE <- intersect(names(train_data), cs5$Name)
```

There are `r length(overlap_PrOTYPE)` genes out of the `r ncol(train_data)` common classifier set that overlap with the PrOTYPE classifier: `r paste(overlap_PrOTYPE, collapse = ", ")`

```{r overlap-SPOT}
overlap_SPOT <- intersect(names(train_data), coefmat[["Symbol"]])
```

There are `r length(overlap_SPOT)` genes out of the `r ncol(train_data)` classifier set that overlap with the SPOT signature: `r paste(overlap_SPOT, collapse = ", ")`.

### Optimal Gene Set

```{r overlap-all}
overlap_all <- unique(c(overlap_PrOTYPE, overlap_SPOT))
candidates <- setdiff(names(train_data), overlap_all)
```

There are `r length(overlap_all)` unique genes from the combined PrOTYPE and SPOT lists that we want to use for the final classifier. We then incrementally add genes from the remaining `r length(candidates)` candidates based on variable importance scores to this list and recalculate performance metrics. The number of genes at which the performance starts to plateau may indicate an optimal gene set for us to carry foward for a particular model.

```{r gene-seq, fig.cap='Gene Optimization for Sequential Classifier'}
dat_geneseq <- geneseq %>% 
  filter(
    (measure == "f1.HGSC" & Sequence == 1) | 
      (measure == "f1.ENOC" & Sequence == 2) |
      (measure == "f1.CCOC" & Sequence == 3)
  ) %>% 
  mutate(
    Genes = as.numeric(Genes),
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Algorithm: ",
      Algorithm,
      ", Measure: ",
      measure)
  )

p_gene_seq <- ggplot(dat_geneseq, aes(x = Genes, y = `50%`)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "Median",
       title = "Gene Optimziation for Sequential Classifier")
print(p_gene_seq)

n_genes_seq <- 25
opt_genes_seq <- c(overlap_all, ranked_vi_seq[seq_len(n_genes_seq)])
```

```{r gene-2s, fig.cap='Gene Optimization for Two-Step Classifier'}
dat_gene2s <- gene2s %>% 
  filter(
    (measure == "f1.HGSC" & Sequence == 1) |
      (measure == "macro_f1" & Sequence == 2)
  ) %>% 
  mutate(
    Genes = as.numeric(Genes),
    label = paste0(
      "Sequence: ",
      Sequence,
      ", Algorithm: ",
      Algorithm,
      ", Measure: ",
      measure)
  )

p_gene_2s <- ggplot(dat_gene2s, aes(x = Genes, y = `50%`)) +
  facet_wrap(~ label, ncol = 1, scales = "free_y") +
  geom_point() +
  theme_bw() +
  labs(x = "Genes Added",
       y = "Median",
       title = "Gene Optimization for Two-Step Classifier")
print(p_gene_2s)

n_genes_2s <- 24
opt_genes_2s <- c(overlap_all, ranked_vi_2s[seq_len(n_genes_2s)])
```

## Rank Aggregation

```{r summary}
# IV summary from multinomial, 2-stage, and sequential algorithm
ivs_comb <- bind_rows(ivst, ivs2s, ivsseq)
ivs_comb_f1 <- ivs_comb %>% 
  filter(grepl("f1\\.", measure)) %>%
  transmute(
    model = ifelse(algorithm %in% c("seq", "two_step"),
                   algorithm,
                   paste(algorithm, sampling, sep = "-")),
    class = gsub("f1\\.", "", measure),
    median_f1 = percentile_50
  )

# Rank aggregation
f1_ranks <- ivs_comb_f1 %>% 
  group_by(class) %>% 
  mutate(rank = factor(row_number(-median_f1))) %>% 
  ungroup() %>% 
  select(-median_f1) %>% 
  arrange(rank) %>% 
  pivot_wider(names_from = "rank", values_from = "model") %>% 
  column_to_rownames("class") %>% 
  as.matrix()

f1_top <- splendid:::sink_output(RankAggreg(
  x = f1_ranks,
  k = ncol(f1_ranks),
  method = "GA",
  seed = 2022,
  verbose = FALSE
))

# F1-score summary
ivs_f1_summary <- ivs_comb_f1 %>% 
  pivot_wider(names_from = "class", values_from = "median_f1") %>% 
  mutate(across(where(is.numeric), round, digits = 3)) %>% 
  magrittr::extract(match(f1_top[["top.list"]], .$model), )

datatable(
  ivs_f1_summary,
  options = list(
    scrollX = TRUE,
    fixedColumns = TRUE,
    columnDefs = list(
      list(
        targets = 1,
        render = JS("$.fn.dataTable.render.ellipsis( 10 )")
      ),
      list(type = "natural", targets = 0)
    ),
    pageLength = 50
  ), 
  rownames = FALSE,
  caption = "F1-Score Summary by Model and Class",
  filter = "top",
  extensions = "FixedColumns",
  plugins = c("ellipsis", "natural")
)
```

The `r ncol(f1_ranks)` methods (algorithm-sampling combinations) are ordered in the table by their aggregated ranks using the Genetic Algorithm. We see that the best performing methods involve the 2-stage and sequential algorithms.

## Top 4 Model Summary

### Overall Metrics

```{r ivs-top4-overall, fig.cap='Top 4 Model Evaluation Metrics'}
models_top4 <- f1_top[["top.list"]][seq_len(4)]
ivs_comb_top4 <- ivs_comb %>% 
  mutate(model = ifelse(
    algorithm %in% c("seq", "two_step"),
    algorithm,
    paste(algorithm, sampling, sep = "-")
  ),
  .after = sampling) %>% 
  filter(
    algorithm %in% c("seq", "two_step") |
      model %in% c("adaboost-up", "rf-smote")
  )

ivs_top4_overall <- ivs_comb_top4 %>% 
  filter(measure %in% c("auc", "accuracy", "kappa", "macro_f1", "gmean")) %>% 
  mutate(model = fct_reorder(model, percentile_50, .desc = TRUE))

p <- 
  ggplot(ivs_top4_overall, aes(x = model, y = percentile_50, color = measure)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4),
                  fatten = 1) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Model",
    y = "Measure",
    color = "Measure",
    title = "Top 4 Model Overall Evaluation Metrics"
  )
print(p)
```

### Per-Class Metrics

```{r ivs-top4-per-class, fig.cap='Top 4 Model Per-Class Evaluation Metrics'}
ivs_top4_per_class <- ivs_comb_top4 %>% 
  filter(grepl("\\.", measure)) %>%
  separate(measure, c("measure", "class")) %>% 
  filter(measure %in% c("accuracy", "kappa", "f1", "gmean")) %>% 
  mutate(model = fct_reorder(model, percentile_50, .desc = TRUE))

p <- 
  ggplot(ivs_top4_per_class, aes(x = model, y = percentile_50, color = measure)) +
  geom_pointrange(aes(ymin = percentile_5, ymax = percentile_95),
                  position = position_dodge(width = 0.4),
                  fatten = 1) +
  facet_wrap(vars(class), ncol = 2) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = "Model",
    y = "Measure",
    color = "Measure",
    title = "Top 4 Model Per-Class Evaluation Metrics"
  )
print(p)
```

## Test Set Performance

Now we'd like to see how our best methods perform in the confirmation and validation sets. The class-specific F1-scores will be used.

The top 3 methods are:

- **seq**: sequential algorithm with upsampling at every step. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using adaboost
  - CCOC vs. non-CCOC using random forest
  - ENOC vs. non-ENOC using ridge regression
  - MUC vs. LGSC using adaboost
- **two_step**: two-step algorithm with upsampling at both steps. The sequence of algorithms used are:
  - HGSC vs. non-HGSC using adaboost
  - CCOC vs. ENOC vs. MUC vs. LGSC using random forest
- **adaboost-up**: adaboost algorithm with upsampling.

```{r top-models}
# Two-step data
two_step_data <- readRDS(here("data", "two_step_data.rds"))
two_step_class <- readRDS(here("data", "two_step_class.rds"))
two_step_algs <- readRDS(here("data", "two_step_algs.rds"))

# Two-step full model
mod_two_step_full <-
  pmap(list(two_step_data, two_step_class, two_step_algs), ~ {
    classification(
      data = ..1,
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# Two-step optimal gene list model
mod_two_step_opt <- 
  pmap(list(two_step_data, two_step_class, two_step_algs), ~ {
    classification(
      data = ..1 %>% select(all_of(opt_genes_2s)),
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# sequential data
seq_data <- readRDS(here("data", "seq_data.rds"))
seq_class <- readRDS(here("data", "seq_class.rds"))
seq_algs <- readRDS(here("data", "seq_algs.rds"))

# Sequential full model
mod_seq_full <-
  pmap(list(seq_data, seq_class, seq_algs), ~ {
    classification(
      data = ..1,
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# Sequential optimal gene list model
mod_seq_opt <-
  pmap(list(seq_data, seq_class, seq_algs), ~ {
    classification(
      data = ..1 %>% select(all_of(opt_genes_seq)),
      class = ..2,
      algorithm = ..3,
      sampling = "up",
      seed_alg = 2024
    )
  })

# adaboost-up
train_data <- readRDS(here("data", "train_data.rds"))
train_class <- readRDS(here("data", "train_class.rds"))

mod_full <- classification(
  data = train_data,
  class = train_class,
  algorithm = "adaboost",
  sampling = "up",
  seed_alg = 2024
)
```

### Confirmation Set

```{r confirmation-set}
# Load data
conf_class <- readRDS(here("data", "conf_class.rds"))
conf_data <- readRDS(here("data", "conf_data.rds"))

# Create step 1 and step 2 splits
## Full
conf_step1_data_full <- conf_data
conf_step1_data_opt <- conf_step1_data_full %>% 
  select(all_of(opt_genes_2s))
conf_step1_class <- factor(ifelse(conf_class == "HGSC", "HGSC", "non-HGSC"))

## Optimal
conf_step2_data_full <- conf_data[conf_step1_class != "HGSC", ]
conf_step2_data_opt <- conf_step2_data_full %>% 
  select(all_of(opt_genes_2s))
conf_step2_class <- factor(conf_class[conf_step1_class != "HGSC"])

# Predict and evaluate
## Full
conf_step1_pred_full <-
  prediction(mod_two_step_full[[1]],
             conf_step1_data_full,
             conf_step1_class)
conf_step1_eval_full <-
  evaluation(conf_step1_class, conf_step1_pred_full)

conf_step2_pred_full <-
  prediction(mod_two_step_full[[2]],
             conf_step2_data_full,
             conf_step2_class)
conf_step2_eval_full <-
  evaluation(conf_step2_class, conf_step2_pred_full)

## Optimal
conf_step1_pred_opt <-
  prediction(mod_two_step_opt[[1]],
             conf_step1_data_opt,
             conf_step1_class)
conf_step1_eval_opt <-
  evaluation(conf_step1_class, conf_step1_pred_opt)

conf_step2_pred_opt <-
  prediction(mod_two_step_opt[[2]],
             conf_step2_data_opt,
             conf_step2_class)
conf_step2_eval_opt <-
  evaluation(conf_step2_class, conf_step2_pred_opt)

# Combine evaluations from both steps
## Full
conf_2S_eval_full <-
  list(conf_step1_eval_full, conf_step2_eval_full) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("f1\\.(?!non)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with(~ gsub("f1\\.", "", .)) %>%
  add_column(method = "two_step_full", .before = 1)

## Optimal
conf_2S_eval_opt <-
  list(conf_step1_eval_opt, conf_step2_eval_opt) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("f1\\.(?!non)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with(~ gsub("f1\\.", "", .)) %>%
  add_column(method = "two_step_optimal", .before = 1)

# Create sequential splits
conf_df <- cbind(conf_data, class = conf_class)

seq_conf_ranks <- seq_class %>%
  map(unique) %>%
  map(~ purrr::discard(., .p = ~ . == "class_0")) %>%
  unlist() %>%
  accumulate(c) %>%
  head(-1)

seq_conf_class <- imap(seq_conf_ranks, ~ {
  cl <- conf_df %>%
    filter(!class %in% head(.x, -1)) %>%
    pull(class)
  if (.y != length(seq_conf_ranks)) {
    factor(ifelse(cl == tail(.x, 1), tail(.x, 1), "class_0"))
  } else {
    factor(cl)
  }
})

## Full
seq_conf_data_full <- map(seq_conf_ranks, ~ {
  conf_df %>%
    filter(!class %in% head(.x, -1)) %>%
    select(-class)
})

## Optimal
seq_conf_data_opt <- seq_conf_data_full %>% 
  map(~ .x %>% select(all_of(opt_genes_seq)))

# Predict and evaluate
## Full
conf_seq_eval_full <-
  pmap(list(mod_seq_full, seq_conf_data_full, seq_conf_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap( ~ .x[grepl("f1\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with( ~ gsub("f1\\.", "", .)) %>%
  add_column(method = "sequential_full", .before = 1)

conf_seq_eval_opt <-
  pmap(list(mod_seq_opt, seq_conf_data_opt, seq_conf_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap( ~ .x[grepl("f1\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with( ~ gsub("f1\\.", "", .)) %>%
  add_column(method = "sequential_optimal", .before = 1)

# # Fit on full data as comparison
# conf_class <- factor(conf_class)
# conf_pred <- prediction(mod_full, conf_data, conf_class)
# conf_eval <- evaluation(conf_class, conf_pred)
# 
# conf_full_eval <- conf_eval %>%
#   pluck("cs") %>%
#   imap(~ .x[grepl("f1\\.", .y)]) %>%
#   compact() %>%
#   bind_rows() %>%
#   rename_with(~ gsub("f1\\.", "", .)) %>%
#   add_column(method = "adaboost-up", .before = 1)

# Comparison of evaluation measures from all methods
conf_summary <- bind_rows(conf_2S_eval_full,
                          conf_2S_eval_opt,
                          conf_seq_eval_full,
                          conf_seq_eval_opt)
kable(conf_summary,
      caption = "Class-specific F1-scores on Confirmation Sets",
      digits = 3)
```

In the confirmation set, **sequential_full** and **sequential_optimal** are very similar. Both sequential algorithms have moderate improvement in LGSC and MUC classification. We will select the **sequential_optimal** model to test in the validation set.

### Validation Set

```{r validation-set}
# Load data
val_class <- readRDS(here("data", "val_class.rds"))
val_data <- readRDS(here("data", "val_data.rds"))

# Create step 1 and step 2 splits
val_step1_data <- val_data
val_step1_class <- factor(ifelse(val_class == "HGSC", "HGSC", "non-HGSC"))
val_step2_data <- val_data[val_step1_class != "HGSC", ]
val_step2_class <- factor(val_class[val_step1_class != "HGSC"])

# Predict and evaluate
val_step1_pred <-
  prediction(mod_two_step[[1]], val_step1_data, val_step1_class)
val_step1_eval <-
  evaluation(val_step1_class, val_step1_pred)

val_step2_pred <-
  prediction(mod_two_step[[2]], val_step2_data, val_step2_class)
val_step2_eval <-
  evaluation(val_step2_class, val_step2_pred)

# Combine evaluations from both steps
val_2S_eval <- list(val_step1_eval, val_step2_eval) %>%
  map("cs") %>%
  unlist() %>%
  imap(~ .x[grepl("f1\\.(?!non)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with(~ gsub("f1\\.", "", .)) %>%
  add_column(method = "two_step", .before = 1)

# Create sequential splits
val_df <- cbind(val_data, class = val_class)

seq_val_ranks <- seq_class %>%
  map(unique) %>%
  map(~ purrr::discard(., .p = ~ . == "class_0")) %>%
  unlist() %>%
  accumulate(c) %>%
  head(-1)

seq_val_data <- map(seq_val_ranks, ~ {
  val_df %>%
    filter(!class %in% head(.x, -1)) %>%
    select(-class)
})

seq_val_class <- imap(seq_val_ranks, ~ {
  cl <- val_df %>%
    filter(!class %in% head(.x, -1)) %>%
    pull(class)
  if (.y != length(seq_val_ranks)) {
    factor(ifelse(cl == tail(.x, 1), tail(.x, 1), "class_0"))
  } else {
    factor(cl)
  }
})

# Predict and evaluate
val_seq_eval <-
  pmap(list(mod_seq, seq_val_data, seq_val_class), ~ {
    pred <- prediction(..1, ..2, ..3)
    eval <- evaluation(..3, pred)
    eval
  }) %>%
  map("cs") %>%
  unlist() %>%
  imap( ~ .x[grepl("f1\\.(?!class_0)", .y, perl = TRUE)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with( ~ gsub("f1\\.", "", .)) %>%
  add_column(method = "sequential", .before = 1)

# Fit on full data as comparison
val_class <- factor(val_class)
val_pred <- prediction(mod_full, val_data, val_class)
val_eval <- evaluation(val_class, val_pred)

val_full_eval <- val_eval %>%
  pluck("cs") %>%
  imap(~ .x[grepl("f1\\.", .y)]) %>%
  compact() %>%
  bind_rows() %>%
  rename_with(~ gsub("f1\\.", "", .)) %>%
  add_column(method = "adaboost-up", .before = 1)

# Comparison of evaluation measures from all methods
val_summary <- bind_rows(val_2S_eval,
                          val_seq_eval,
                          val_full_eval)
kable(val_summary,
      caption = "Class-specific F1-scores on valirmation Sets",
      digits = 3)
```

Similarly in the validation set, **two_step** and **sequential** improve drastically in LGSC classification compared to **adaboost-up**, with moderate improvement in ENOC and MUC, and minor improvement in CCOC. There is a decrease in MUC performance. **sequential** improves on **two_step** in all classes except for a small decrease in HGSC performance.
